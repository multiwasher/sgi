<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal de Gestão ISO 14001 | Somengil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=track_changes" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

    :root { --primary:#065f46; --secondary:#10b981; }

    body{
      font-family:'Plus Jakarta Sans',sans-serif;
      background-color:#f8fafc;
      color:#1e293b;
    }

    .glass-card{
      background:#ffffff;
      border:1px solid #e2e8f0;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.05),0 2px 4px -1px rgba(0,0,0,0.03);
      border-radius:1rem;
      transition:all .3s ease;
    }
    .glass-card:hover{ box-shadow:0 10px 15px -3px rgba(0,0,0,0.08); }

    .type-badge{
      font-size:0.65rem;
      padding:4px 12px;
      border-radius:8px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.05em;
      display:inline-block;
      border-width:1px;
    }
    .badge-procedimento{ background:#dcfce7; color:#166534; border-color:#bbf7d0; }
    .badge-instrucao{ background:#e0f2fe; color:#075985; border-color:#bae6fd; }
    .badge-instrucao-operatoria{ background:#bfdbfe; color:#1e40af; border-color:#93c5fd; }
    .badge-manual{ background:#f3e8ff; color:#6b21a8; border-color:#e9d5ff; }
    .badge-modelo{ background:#fef9c3; color:#854d0e; border-color:#fef08a; }
    .badge-pasta{ background:#ffedd5; color:#9a3412; border-color:#fdba74; }
    .badge-default{ background:#f1f5f9; color:#475569; border-color:#e2e8f0; }

    /* SWOT Colors */
    .swot-f{ border-left: 4px solid #10b981; }     /* Forças */
    .swot-o{ border-left: 4px solid #3b82f6; }     /* Oportunidades */
    .swot-f-ext{ border-left: 4px solid #f59e0b; } /* Fraquezas */
    .swot-a{ border-left: 4px solid #ef4444; }     /* Ameaças */

    /* SWOT Category Badge */
    .swot-cat-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 800;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    /* ✅ CORES DAS TAGS POR CATEGORIA */
    .tag-sga { background:#f1f5f9; border-color:#e2e8f0; color:#475569; }
    .tag-energia { background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
    .tag-agua { background:#eff6ff; border-color:#bfdbfe; color:#1d4ed8; }
    .tag-residuos { background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
    .tag-legal { background:#f5f3ff; border-color:#ddd6fe; color:#5b21b6; }
    .tag-equipa { background:#fdf2f8; border-color:#fbcfe8; color:#9d174d; }
    .tag-emissoes { background:#fef2f2; border-color:#fecaca; color:#991b1b; }
    .tag-transporte { background:#fffbeb; border-color:#fde68a; color:#92400e; }

    /* ✅ R&O BADGES - Riscos & Oportunidades */
    .ro-risco {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #7f1d1d;
      border: 1.5px solid #dc2626;
      font-weight: 900;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
      letter-spacing: 0.05em;
    }
    .ro-risco::before {
      content: "⚠️";
      margin-right: 4px;
    }

    .ro-oportunidade {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      color: #15803d;
      border: 1.5px solid #22c55e;
      font-weight: 900;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
      letter-spacing: 0.05em;
    }
    .ro-oportunidade::before {
      content: "✓";
      margin-right: 4px;
    }

    /* ✅ R&O FILTER BUTTON STATES */
    .ro-filter-btn {
      transition: all 0.3s ease;
    }
    .ro-filter-btn.active {
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: scale(1.05);
      font-weight: 900;
    }
    #roFilterRisco.active {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #7f1d1d;
      border-color: #dc2626;
    }
    #roFilterOportunidade.active {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      color: #15803d;
      border-color: #22c55e;
    }
    #roFilterTodos.active {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      color: #1e293b;
      border-color: #64748b;
    }

    /* ✅ STATUS TAGS */
    .status-concluido {
      background: #dcfce7 !important;
      color: #166534 !important;
    }

    .status-aberto {
      background: #fef08a !important;
      color: #854d0e !important;
    }

    .status-em-curso {
      background: #fed7aa !important;
      color: #92400e !important;
    }

    .status-indefinido {
      background: #f3f4f6 !important;
      color: #6b7280 !important;
    }

    .status-cancelado {
      background: #f3f4f6 !important;
      color: #6b7280 !important;
    }

    /* ✅ EFICÁCIA TAGS */
    .eficacia-eficaz {
      background: #dcfce7 !important;
      color: #166534 !important;
    }

    .eficacia-nao-eficaz {
      background: #fee2e2 !important;
      color: #991b1b !important;
    }

    .status-pulse{
      width:8px;height:8px;
      border-radius:50%;
      display:inline-block;
      margin-right:8px;
    }
    .pulse-emerald{ background:#10b981; box-shadow:0 0 0 rgba(16,185,129,0.4); animation:pulse 2s infinite; }

    @keyframes pulse{
      0%{ transform:scale(0.95); box-shadow:0 0 0 0 rgba(16,185,129,0.7); }
      70%{ transform:scale(1); box-shadow:0 0 0 10px rgba(16,185,129,0); }
      100%{ transform:scale(0.95); box-shadow:0 0 0 0 rgba(16,185,129,0); }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .loading-spinner {
      display: inline-block;
      width: 60px;
      height: 60px;
      background-image: url('https://static.wixstatic.com/media/a6967f_95db0dbb18554c0299efd61c7e081848~mv2.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      animation: spin 2s linear infinite;
    }

    #globalLoadingOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(2px);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    #globalLoadingOverlay.show {
      display: flex;
    }

    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .loading-container .loading-spinner {
      width: 100px;
      height: 100px;
    }

    .loading-container p {
      font-size: 14px;
      font-weight: 600;
      color: #475569;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    #adminModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.6);
      backdrop-filter:blur(4px);
      z-index:100;
      align-items:center;
      justify-content:center;
    }
    #adminModal.active{ display:flex; }

    .tab-btn.active {
      background: white;
      color: #065f46;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }

    /* Mobile Menu Styles */
    #mobile-menu {
      min-width: 200px;
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .mobile-tab-btn.active {
      background-color: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
    }

    #burger-menu-btn svg {
      transition: all 0.3s ease;
    }

    /* R&O Collapsible Filters */
    .ro-filter-container {
      animation: slideDown 0.3s ease-out;
    }

    .ro-filter-container.hidden {
      animation: slideUp 0.3s ease-out;
      display: none !important;
    }

    @keyframes slideUp {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }

    .ro-filter-chevron {
      transform-origin: center;
    }

    .ro-filter-chevron.expanded {
      transform: rotate(180deg);
    }

    .swot-filter-btn { transition: all 0.2s; }
    .swot-filter-btn.active {
      background-color: #065f46;
      color: white;
      border-color: #065f46;
    }

    .pdca-filter-btn { transition: all 0.2s; }
    .pdca-filter-btn.active {
      background-color: #065f46;
      color: white;
      border-color: #065f46;
    }

    .org-view-btn { transition: all 0.3s ease; }
    .org-view-btn.active {
      background: white;
      color: #1e293b;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
  </style>
</head>

<body class="min-h-screen pb-12">

  <!-- Global Loading Overlay -->
  <div id="globalLoadingOverlay">
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p id="loadingText">A carregar documentos...</p>
    </div>
  </div>

  <!-- Modal: Adicionar Documento -->
  <div id="adminModal" onclick="closeModal(event)">
    <div class="glass-card w-full max-w-lg p-8 m-4 shadow-2xl" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-black text-slate-800 tracking-tight">Novo Documento</h2>
        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form id="addDocForm" onsubmit="addDocumentToSheet(event)" class="space-y-4">
        <div>
          <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Tipo</label>
          <select id="docType" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none">
            <option value="PROCEDIMENTO">Procedimento</option>
            <option value="INSTRUÇÃO">Instrução</option>
            <option value="REGISTO">Registo</option>
            <option value="MANUAL">Manual</option>
            <option value="POLÍTICA">Política</option>
            <option value="MODELO">Modelo</option>
            <option value="PASTA">Pasta</option>
            <option value="SGA">Outro (SGI)</option>
          </select>
        </div>
        <div>
          <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Designação</label>
          <input type="text" id="docName" placeholder="Nome do documento" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-emerald-500">
        </div>
        <div>
          <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Link</label>
          <input type="url" id="docLink" placeholder="https://drive.google.com/..." required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-emerald-500">
        </div>
        <div class="pt-4">
          <button id="btnAddDoc" type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black py-4 rounded-xl transition-all shadow-lg active:scale-95">
            GRAVAR NO SISTEMA
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Adicionar SWOT -->
  <div id="swotModal" class="fixed inset-0 hidden z-[120] items-center justify-center bg-slate-900/60 backdrop-blur-sm" onclick="closeSwotModal(event)">
    <div class="glass-card w-full max-w-2xl p-8 m-4 shadow-2xl" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-black text-slate-800 tracking-tight">Nova SWOT</h2>
        <button onclick="closeSwotModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form id="addSwotForm" onsubmit="addSwotToSheet(event)" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">SWOT</label>
            <select id="swotType" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none">
              <option value="INTERNAL STRENGTHS">INTERNAL STRENGTHS (Forças)</option>
              <option value="INTERNAL WEAKNESSES">INTERNAL WEAKNESSES (Fraquezas)</option>
              <option value="EXTERNAL OPPORTUNITIES">EXTERNAL OPPORTUNITIES (Oportunidades)</option>
              <option value="EXTERNAL THREATS">EXTERNAL THREATS (Ameaças)</option>
            </select>
          </div>

          <div>
            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Código</label>
            <input type="text" id="swotCodigo" placeholder="ex: S1 / W1 / O1 / T1" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-emerald-500">
          </div>
        </div>

        <div>
          <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Descrição</label>
          <textarea id="swotDescricao" required rows="3" placeholder="Descrição do ponto SWOT..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-emerald-500"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Tomada de ação?</label>
            <select id="swotTomada" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none">
              <option value="S">S</option>
              <option value="N" selected>N</option>
            </select>
          </div>
          <div class="flex items-end">
            <p class="text-[10px] text-slate-400 font-bold">Ações (máx. 6) — se não colocares código, é gerado automaticamente (S2_1, W1_1, O1_1, T1_1...).</p>
          </div>
        </div>

        <div id="swotActions" class="space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod1" type="text" placeholder="Código Ação 1 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt1" type="text" placeholder="Ação 1" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod2" type="text" placeholder="Código Ação 2 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt2" type="text" placeholder="Ação 2" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod3" type="text" placeholder="Código Ação 3 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt3" type="text" placeholder="Ação 3" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod4" type="text" placeholder="Código Ação 4 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt4" type="text" placeholder="Ação 4" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod5" type="text" placeholder="Código Ação 5 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt5" type="text" placeholder="Ação 5" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod6" type="text" placeholder="Código Ação 6 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt6" type="text" placeholder="Ação 6" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
        </div>

        <div class="pt-4">
          <button id="btnAddSwot" type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black py-4 rounded-xl transition-all shadow-lg active:scale-95">
            GRAVAR SWOT
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Barra Superior -->
  <nav class="bg-emerald-900 text-white sticky top-0 z-50 shadow-lg">
    <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center">
      <div class="flex items-center space-x-4">
        <div class="bg-white/10 p-2.5 rounded-2xl border border-white/10">
          <span class="material-symbols-outlined text-emerald-400 text-4xl">track_changes</span>
        </div>
        <div>
          <h1 class="text-xl font-extrabold tracking-tight leading-none">SGI <span class="text-emerald-400">Somengil</span></h1>
          <p class="text-emerald-300/60 text-[10px] uppercase tracking-[0.2em] font-bold mt-1">Gestão Integrada<p></p>ISO9001 & ISO14001</p>
        </div>
      </div>

      <div class="mt-4 md:mt-0 flex items-center gap-3">
        <button onclick="openCertificationsModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-xs font-black transition-all border border-emerald-700" title="Certificações e Estrutura de Processos">
          ✓ ÂMBITO
        </button>

        <!-- Menu Desktop (hidden on mobile) -->
        <div class="hidden md:flex bg-black/20 p-1 rounded-xl mr-4">
          <button onclick="switchTab('docs')" id="tab-docs" class="tab-btn active px-4 py-1.5 rounded-lg text-xs font-bold transition-all">DOCUMENTAÇÃO</button>
          <button onclick="switchTab('swot')" id="tab-swot" class="tab-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all">ANÁLISE SWOT</button>
          <button onclick="switchTab('ro')" id="tab-ro" class="tab-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all">R&O</button>
          <button onclick="switchTab('partes')" id="tab-partes" class="tab-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all">PARTES INTERESSADAS</button>
          <button onclick="switchTab('org')" id="tab-org" class="tab-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all">ORGANIGRAMA</button>
          <button onclick="switchTab('planning')" id="tab-planning" class="tab-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all">PLANEAMENTO</button>
          <button onclick="switchTab('pdca')" id="tab-pdca" class="tab-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all">PDCA</button>
        </div>

        <!-- Burger Menu (visible only on mobile) -->
        <div class="md:hidden relative">
          <button onclick="toggleMobileMenu()" id="burger-menu-btn" class="bg-black/20 hover:bg-black/40 text-white p-2 rounded-lg transition-all border border-white/10">
            <svg id="burger-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            <svg id="close-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          
          <!-- Mobile Menu Dropdown -->
          <div id="mobile-menu" class="hidden absolute right-0 top-12 bg-slate-900 border border-slate-700 rounded-lg shadow-lg z-50">
            <button onclick="switchTabMobile('docs')" id="mob-tab-docs" class="mobile-tab-btn active block w-full text-left px-4 py-2 text-xs font-bold text-emerald-200 hover:bg-slate-800 rounded-t-lg">DOCUMENTAÇÃO</button>
            <button onclick="switchTabMobile('swot')" id="mob-tab-swot" class="mobile-tab-btn block w-full text-left px-4 py-2 text-xs font-bold text-slate-200 hover:bg-slate-800 border-t border-slate-700">ANÁLISE SWOT</button>
            <button onclick="switchTabMobile('ro')" id="mob-tab-ro" class="mobile-tab-btn block w-full text-left px-4 py-2 text-xs font-bold text-slate-200 hover:bg-slate-800 border-t border-slate-700">R&O</button>
            <button onclick="switchTabMobile('partes')" id="mob-tab-partes" class="mobile-tab-btn block w-full text-left px-4 py-2 text-xs font-bold text-slate-200 hover:bg-slate-800 border-t border-slate-700">PARTES INTERESSADAS</button>
            <button onclick="switchTabMobile('org')" id="mob-tab-org" class="mobile-tab-btn block w-full text-left px-4 py-2 text-xs font-bold text-slate-200 hover:bg-slate-800 border-t border-slate-700">ORGANIGRAMA</button>
            <button onclick="switchTabMobile('planning')" id="mob-tab-planning" class="mobile-tab-btn block w-full text-left px-4 py-2 text-xs font-bold text-slate-200 hover:bg-slate-800 border-t border-slate-700">PLANEAMENTO</button>
            <button onclick="switchTabMobile('pdca')" id="mob-tab-pdca" class="mobile-tab-btn block w-full text-left px-4 py-2 text-xs font-bold text-slate-200 hover:bg-slate-800 border-t border-slate-700 rounded-b-lg">PDCA</button>
          </div>
        </div>

        <div class="bg-black/20 px-3 py-1.5 rounded-full flex items-center border border-white/5">
          <span id="status-dot" class="status-pulse pulse-emerald"></span>
          <span id="sync-status" class="text-[10px] font-bold uppercase text-emerald-200">Ligação Ativa</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Modal: Certificações e Âmbito -->
  <div id="certifications-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6 pb-4 border-b-2">
        <h2 class="font-bold text-2xl uppercase text-slate-900">✓ Certificações e Estrutura</h2>
        <button onclick="closeCertificationsModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">×</button>
      </div>
      
      <div class="space-y-6 text-slate-700">
        <!-- Auditoria e Certificações -->
        <div class="bg-emerald-50 border-l-4 border-emerald-600 p-6 rounded-lg">
          <h3 class="font-bold text-lg text-emerald-900 mb-3 uppercase">Auditoria e Certificações</h3>
          <p class="text-sm leading-relaxed">
            O Sistema de organização da Somengil, s.a. foi auditado e cumpre com os requisitos da norma <strong>NP EN ISO 9001</strong> e <strong>NP EN ISO 14001</strong>, encontrando-se implementado para as atividades de:
          </p>
          <ul class="mt-4 space-y-2 text-sm list-disc list-inside ml-2">
            <li>Design, desenvolvimento, produção, comercialização e assistência técnica de equipamento de lavagem</li>
            <li>Comercialização e assistência técnica de equipamentos de frio industrial</li>
          </ul>
        </div>

        <!-- Requisitos Não Aplicáveis -->
        <div class="bg-amber-50 border-l-4 border-amber-600 p-6 rounded-lg">
          <h3 class="font-bold text-lg text-amber-900 mb-3 uppercase">Requisitos Não Aplicáveis</h3>
          <p class="text-sm text-amber-800">n.a.</p>
        </div>

        <!-- Estrutura dos Processos -->
        <div class="bg-blue-50 border-l-4 border-blue-600 p-6 rounded-lg">
          <h3 class="font-bold text-lg text-blue-900 mb-3 uppercase">Estrutura dos Processos</h3>
          <p class="text-sm leading-relaxed text-blue-900 mb-4">
            A Somengil adoptou uma abordagem baseada na identificação dos seus processos para o desenvolvimento, implementação e melhoria da eficácia do SGI para aumentar a satisfação do cliente e de todas as outras partes interessadas mediante o cumprimento dos seus requisitos.
          </p>
          <p class="text-sm font-semibold text-blue-900">
            VER MAPA PROCESSOS - PS_DGN_02_02 - SWIMLANE Mapeamento de Processos
          </p>
        </div>
      </div>

      <button onclick="closeCertificationsModal()" class="w-full mt-8 bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-4 rounded-lg transition-colors">Fechar</button>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-6 pt-8">

    <!-- CONTEÚDO: DOCUMENTAÇÃO -->
    <div id="view-docs" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="glass-card p-6 border-l-4 border-emerald-500">
          <p class="text-slate-400 text-[10px] uppercase font-bold mb-1">Documentos Totais</p>
          <h3 id="stat-docs" class="text-3xl font-black text-slate-800 tracking-tighter">--</h3>
        </div>
        <div class="glass-card p-6 md:col-span-2 flex items-center justify-between gap-4">
          <div class="relative flex-1 group">
            <input type="text" id="searchDocs" onkeyup="filterDocs()" placeholder="Pesquisar (ex: 'emergência' encontra 'segurança', 'autoprot.')" class="w-full bg-slate-50 border border-slate-200 pl-11 pr-4 py-3 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500 transition-all">
            <svg class="absolute left-4 top-3.5 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
          <button id="btn-new-doc" onclick="openModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-2xl text-xs font-black transition-all border border-emerald-700 whitespace-nowrap">
            + NOVO DOC
          </button>
        </div>
      </div>

      <div class="glass-card p-4 mb-4">
        <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 overflow-x-auto pb-2 md:pb-0">
          <span class="mr-2 whitespace-nowrap">Filtrar por Tipo:</span>
          <button onclick="setDocTypeFilter('TODOS')" id="filter-doctype-TODOS" class="swot-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">TUDO</button>
          <button onclick="setDocTypeFilter('procedimento')" id="filter-doctype-procedimento" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Procedimento</button>
          <button onclick="setDocTypeFilter('instrucao de trabalho')" id="filter-doctype-instrucao-de-trabalho" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Instrução de Trabalho</button>
          <button onclick="setDocTypeFilter('instrucao operatoria')" id="filter-doctype-instrucao-operatoria" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Instrução Operatória</button>
          <button onclick="setDocTypeFilter('manual')" id="filter-doctype-manual" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Manual</button>
          <button onclick="setDocTypeFilter('modelo')" id="filter-doctype-modelo" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Modelo</button>
          <button onclick="setDocTypeFilter('pasta')" id="filter-doctype-pasta" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Pasta</button>
        </div>
      </div>

      <div class="glass-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-slate-50 border-b border-slate-100">
                <th class="px-8 py-4 text-[11px] font-black text-slate-400 uppercase tracking-widest">Tipo</th>
                <th class="px-8 py-4 text-[11px] font-black text-slate-400 uppercase tracking-widest">Designação</th>
                <th class="px-8 py-4 text-[11px] font-black text-slate-400 uppercase tracking-widest">Status</th>
                <th class="px-8 py-4 text-[11px] font-black text-slate-400 uppercase tracking-widest">Data de Atualização</th>
                <th class="px-8 py-4 text-[11px] font-black text-slate-400 uppercase tracking-widest text-right">Ação</th>
              </tr>
            </thead>
            <tbody id="docsTableBody" class="divide-y divide-slate-50">
              <tr><td colspan="3" class="px-8 py-20 text-center"><div class="flex justify-center items-center gap-3"><div class="loading-spinner"></div><span class="text-slate-400 font-bold uppercase text-[10px]">A carregar documentos...</span></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CONTEÚDO: SWOT -->
    <div id="view-swot" class="hidden space-y-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
          <h2 class="text-2xl font-black text-slate-800 tracking-tight">Análise SWOT Ambiental</h2>
          <p class="text-slate-500 text-sm">Matriz de Forças, Fraquezas, Oportunidades e Ameaças</p>
        </div>

        <div class="flex items-center gap-2">
          <a
            href="https://docs.google.com/spreadsheets/d/1n-9nPmr_owOXxOhfIqqIGnoBu8MdbkeknW1nRSKF6AI/edit?usp=sharing"
            target="_blank"
            rel="noopener"
            class="text-[10px] font-black text-slate-600 hover:text-slate-800 uppercase tracking-widest bg-white px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition-all"
            title="Abrir Google Sheets (origem dos dados SWOT)"
          >
            DOCUMENTO DE ORIGEM
          </a>

          <button onclick="fetchSwot()" class="text-[10px] font-black text-emerald-600 hover:text-emerald-700 uppercase tracking-widest bg-emerald-50 px-3 py-2 rounded-lg transition-all">Atualizar Dados</button>

          <button onclick="openSwotModal()" class="text-[10px] font-black text-white uppercase tracking-widest bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded-lg transition-all">
            + NOVA SWOT
          </button>
        </div>
      </div>

      <!-- Barra de Filtros SWOT -->
      <div class="glass-card p-4 space-y-4">
        <div class="flex flex-col md:flex-row gap-4 items-center">
          <div class="relative w-full md:w-1/4">
            <input type="text" id="searchSwot" onkeyup="applySwotFilters()" placeholder="Filtrar texto..." class="w-full bg-slate-50 border border-slate-200 pl-10 pr-4 py-2 rounded-xl text-xs outline-none focus:border-emerald-500">
            <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>

          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400">
            <span class="mr-2 whitespace-nowrap">Estado:</span>
            <button onclick="setActiveFilter('TODOS')" id="filter-active-TODOS" class="swot-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Tudo</button>
            <button onclick="setActiveFilter('ATIVOS')" id="filter-active-ATIVOS" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-emerald-200 hover:bg-emerald-50">Ativos</button>
            <button onclick="setActiveFilter('NAO_ATIVOS')" id="filter-active-NAO_ATIVOS" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Não ativos</button>
          </div>

          <!-- ✅ Filtro Plano de Ação? -->
          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 border-l border-slate-200 pl-4">
            <span class="mr-2 whitespace-nowrap">Plano de Ação?</span>
            <button onclick="setPlanFilter('TODOS')" id="filter-plan-TODOS" class="swot-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Tudo</button>
            <button onclick="setPlanFilter('S')" id="filter-plan-S" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-emerald-200 hover:bg-emerald-50">S</button>
            <button onclick="setPlanFilter('N')" id="filter-plan-N" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-amber-200 hover:bg-amber-50">N</button>
          </div>

          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 overflow-x-auto pb-2 md:pb-0">
            <span class="mr-2 whitespace-nowrap">Temas:</span>
            <button onclick="setSwotFilter('TODOS')" id="filter-swot-TODOS" class="swot-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">TUDO</button>
            <button onclick="setSwotFilter('Energia')" id="filter-swot-Energia" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Energia</button>
            <button onclick="setSwotFilter('Água')" id="filter-swot-Água" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Água</button>
            <button onclick="setSwotFilter('Resíduos')" id="filter-swot-Resíduos" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Resíduos</button>
            <button onclick="setSwotFilter('Legal')" id="filter-swot-Legal" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Legal</button>
            <button onclick="setSwotFilter('Equipa')" id="filter-swot-Equipa" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Equipa</button>
          </div>

          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 border-l border-slate-200 pl-4">
            <span class="mr-2 whitespace-nowrap">Quadrante:</span>
            <button onclick="setQuadrantFilter('TODOS')" id="filter-quad-TODOS" class="swot-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">TUDO</button>
            <button onclick="setQuadrantFilter('FORÇAS')" id="filter-quad-FORÇAS" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-emerald-200 hover:bg-emerald-50">Forças</button>
            <button onclick="setQuadrantFilter('OPORTUNIDADES')" id="filter-quad-OPORTUNIDADES" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-blue-200 hover:bg-blue-50">Oport.</button>
            <button onclick="setQuadrantFilter('FRAQUEZAS')" id="filter-quad-FRAQUEZAS" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-amber-200 hover:bg-amber-50">Fraq.</button>
            <button onclick="setQuadrantFilter('AMEAÇAS')" id="filter-quad-AMEAÇAS" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-red-200 hover:bg-red-50">Ameaças</button>
          </div>
        </div>
      </div>

      <div id="swot-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-4">
        <div id="quadrant-FORÇAS" class="space-y-4">
          <div class="flex items-center gap-3 pb-2 border-b-2 border-emerald-500/20">
            <div class="w-8 h-8 rounded-lg bg-emerald-500 flex items-center justify-center text-white shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <h3 class="font-black text-emerald-800 uppercase tracking-tighter">Forças</h3>
          </div>
          <div id="swot-forcas" class="space-y-4 min-h-[50px]"></div>
        </div>

        <div id="quadrant-OPORTUNIDADES" class="space-y-4">
          <div class="flex items-center gap-3 pb-2 border-b-2 border-blue-500/20">
            <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center text-white shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
            </div>
            <h3 class="font-black text-blue-800 uppercase tracking-tighter">Oportunidades</h3>
          </div>
          <div id="swot-oportunidades" class="space-y-4 min-h-[50px]"></div>
        </div>

        <div id="quadrant-FRAQUEZAS" class="space-y-4">
          <div class="flex items-center gap-3 pb-2 border-b-2 border-amber-500/20">
            <div class="w-8 h-8 rounded-lg bg-amber-500 flex items-center justify-center text-white shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 class="font-black text-amber-800 uppercase tracking-tighter">Fraquezas</h3>
          </div>
          <div id="swot-fraquezas" class="space-y-4 min-h-[50px]"></div>
        </div>

        <div id="quadrant-AMEAÇAS" class="space-y-4">
          <div class="flex items-center gap-3 pb-2 border-b-2 border-red-500/20">
            <div class="w-8 h-8 rounded-lg bg-red-500 flex items-center justify-center text-white shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
            </div>
            <h3 class="font-black text-red-800 uppercase tracking-tighter">Ameaças</h3>
          </div>
          <div id="swot-ameacas" class="space-y-4 min-h-[50px]"></div>
        </div>
      </div>
    </div>

    <!-- CONTEÚDO: R&O -->
    <div id="view-ro" class="hidden space-y-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
          <h2 class="text-2xl font-black text-slate-800 tracking-tight">Riscos e Oportunidades (R&O)</h2>
          <p class="text-slate-500 text-sm">Matriz de Riscos e Oportunidades Ambientais</p>
          <div class="flex gap-6 mt-3">
            <div class="flex items-center gap-2">
              <button id="roFilterRisco" onclick="setRoTypeFilter('risco')" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-[10px] font-black text-red-700 bg-red-100 border border-red-300 hover:bg-red-200 transition-colors cursor-pointer ro-filter-btn">⚠️ R = Risco</button>
            </div>
            <div class="flex items-center gap-2">
              <button id="roFilterOportunidade" onclick="setRoTypeFilter('oportunidade')" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-[10px] font-black text-emerald-700 bg-emerald-100 border border-emerald-300 hover:bg-emerald-200 transition-colors cursor-pointer ro-filter-btn">✓ O = Oportunidade</button>
            </div>
            <div class="flex items-center gap-2">
              <button id="roFilterTodos" onclick="setRoTypeFilter('todos')" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-[10px] font-black text-slate-700 bg-slate-100 border border-slate-300 hover:bg-slate-200 transition-colors cursor-pointer ro-filter-btn">Todos</button>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <a
            href="https://docs.google.com/spreadsheets/d/1n-9nPmr_owOXxOhfIqqIGnoBu8MdbkeknW1nRSKF6AI/edit?usp=sharing"
            target="_blank"
            rel="noopener"
            class="text-[10px] font-black text-slate-600 hover:text-slate-800 uppercase tracking-widest bg-white px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition-all"
            title="Abrir Google Sheets (origem dos dados R&O)"
          >
            DOCUMENTO DE ORIGEM
          </a>

          <button onclick="fetchRo()" class="text-[10px] font-black text-emerald-600 hover:text-emerald-700 uppercase tracking-widest bg-emerald-50 px-3 py-2 rounded-lg transition-all">Atualizar Dados</button>
        </div>
      </div>

      <!-- Barra de Filtros R&O -->
      <div class="glass-card p-4 space-y-4">
        <div class="relative w-full">
          <input type="text" id="searchRo" onkeyup="applyRoFilters()" placeholder="Filtrar por palavra-chave..." class="w-full bg-slate-50 border border-slate-200 pl-10 pr-4 py-2 rounded-xl text-xs outline-none focus:border-emerald-500">
          <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
        
        <!-- Filtros de Processo -->
        <div class="space-y-2 border-t border-slate-200 pt-2">
          <button onclick="toggleRoFilterSection('processo')" class="w-full flex items-center justify-between hover:bg-slate-50 px-2 py-1.5 rounded-lg transition-colors">
            <div class="text-[10px] font-black text-slate-600 uppercase">Processos</div>
            <svg class="ro-filter-chevron chevron-processo w-4 h-4 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
            </svg>
          </button>
          <div id="ro-processo-container" class="ro-filter-container hidden space-y-2">
            <button onclick="setRoFilter('processo', 'TODOS')" id="filter-ro-processo-TODOS" class="ro-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 text-[10px]">TODOS</button>
            <div id="ro-processo-filters" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
        
        <!-- Filtros de Origem -->
        <div class="space-y-2 border-t border-slate-200 pt-2">
          <button onclick="toggleRoFilterSection('origem')" class="w-full flex items-center justify-between hover:bg-slate-50 px-2 py-1.5 rounded-lg transition-colors">
            <div class="text-[10px] font-black text-slate-600 uppercase">Origem</div>
            <svg class="ro-filter-chevron chevron-origem w-4 h-4 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
            </svg>
          </button>
          <div id="ro-origem-container" class="ro-filter-container hidden space-y-2">
            <button onclick="setRoFilter('origem', 'TODOS')" id="filter-ro-origem-TODOS" class="ro-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 text-[10px]">TODOS</button>
            <div id="ro-origem-filters" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
      </div>

      <!-- Tabela R&O -->
      <div class="glass-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 border-b-2 border-slate-200">
              <tr>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600">Descrição do Risco / Oportunidade</th>
                <th class="px-6 py-3 text-center text-[10px] font-black uppercase text-slate-600">R / O</th>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600">Origem</th>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600">Processos</th>
                <th class="px-6 py-3 text-center text-[10px] font-black uppercase text-slate-600">Código (R&O)</th>
                <th class="px-6 py-3 text-center text-[10px] font-black uppercase text-slate-600">PA</th>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600">Proveniência</th>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600 cursor-pointer" title="Clique para ver informação SWOT">Observações</th>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600">KeyWord</th>
              </tr>
            </thead>
            <tbody id="roTableBody" class="divide-y divide-slate-200">
              <tr><td colspan="9" class="px-8 py-10 text-center"><div class="flex justify-center items-center gap-3"><div class="loading-spinner"></div><span class="text-slate-400 font-bold uppercase text-[10px]">A carregar dados...</span></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CONTEÚDO: PARTES INTERESSADAS -->
    <div id="view-partes" class="hidden space-y-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
          <h2 class="text-2xl font-black text-slate-800 tracking-tight">Partes Interessadas</h2>
          <p class="text-slate-500 text-sm">Matriz de Partes Interessadas - Stakeholders e Partes Interessadas</p>
        </div>

        <div class="flex items-center gap-2">
          <a
            href="https://docs.google.com/spreadsheets/d/1A0id_1DRMdpATDCB3Ctp8OZMqwwdj46BG5Pcdw2ULhw/edit?usp=sharing"
            target="_blank"
            rel="noopener"
            class="text-[10px] font-black text-slate-600 hover:text-slate-800 uppercase tracking-widest bg-white px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition-all"
            title="Abrir Google Sheets (origem dos dados)"
          >
            DOCUMENTO DE ORIGEM
          </a>

          <button onclick="fetchPartes()" class="text-[10px] font-black text-emerald-600 hover:text-emerald-700 uppercase tracking-widest bg-emerald-50 px-3 py-2 rounded-lg transition-all">Atualizar Dados</button>
        </div>
      </div>

      <!-- Barra de Filtros Partes Interessadas -->
      <div class="glass-card p-4 space-y-4">
        <div class="relative w-full">
          <input type="text" id="searchPartes" onkeyup="applyPartesFilters()" placeholder="Filtrar por palavra-chave..." class="w-full bg-slate-50 border border-slate-200 pl-10 pr-4 py-2 rounded-xl text-xs outline-none focus:border-emerald-500">
          <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
      </div>

      <!-- Tabela Partes Interessadas -->
      <div class="glass-card overflow-hidden">
        <table class="w-full table-auto" style="table-layout: fixed;">
          <thead class="bg-slate-50 border-b-2 border-slate-200">
            <tr>
              <th class="px-3 py-3 text-left text-[9px] font-black uppercase text-slate-600 w-12">Código</th>
              <th class="px-3 py-3 text-left text-[9px] font-black uppercase text-slate-600 w-24">Parte Interessada</th>
              <th class="px-3 py-3 text-left text-[9px] font-black uppercase text-slate-600 w-16">Fonte</th>
              <th class="px-3 py-3 text-left text-[9px] font-black uppercase text-slate-600 w-32">Requisitos</th>
              <th class="px-3 py-3 text-left text-[9px] font-black uppercase text-slate-600 w-32">Expectativas</th>
              <th class="px-3 py-3 text-left text-[9px] font-black uppercase text-slate-600 w-20">Frequência</th>
              <th class="px-3 py-3 text-left text-[9px] font-black uppercase text-slate-600 w-20">Responsável</th>
              <th class="px-3 py-3 text-left text-[9px] font-black uppercase text-slate-600 w-16">Ações</th>
              <th class="px-3 py-3 text-left text-[9px] font-black uppercase text-slate-600 w-16">Objetivos</th>
            </tr>
          </thead>
          <tbody id="partesTableBody" class="divide-y divide-slate-200">
            <tr><td colspan="9" class="px-8 py-10 text-center"><div class="flex justify-center items-center gap-3"><div class="loading-spinner"></div><span class="text-slate-400 font-bold uppercase text-[10px]">A carregar dados...</span></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- CONTEÚDO: ORGANIGRAMA -->
    <div id="view-org" class="hidden space-y-8">
      <!-- Cabeçalho do Organigrama -->
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-8 rounded-2xl shadow-lg">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
          <div>
            <h1 class="text-4xl font-black tracking-tight">ORGANIGRAMA</h1>
            <p class="text-slate-300 text-sm mt-2">Estrutura Organizacional - SOMENGIL</p>
          </div>
          <div class="flex gap-3">
            <button onclick="toggleOrgView('full')" id="org-full-btn" class="org-view-btn active px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white text-slate-900">Vista Geral</button>
            <button onclick="toggleOrgView('details')" id="org-details-btn" class="org-view-btn px-6 py-2 rounded-lg text-sm font-bold transition-all bg-slate-700 hover:bg-slate-600 text-white">Detalhes</button>
          </div>
        </div>
      </div>

      <!-- Vista Geral (Organigrama) -->
      <div id="org-full-view" class="pb-12 bg-white rounded-xl p-6 shadow-sm border border-slate-200">
        <div class="flex flex-col items-center w-full relative">
          
          <!-- Administração (Topo) -->
          <div class="mb-10 relative">
            <div class="bg-gradient-to-br from-slate-900 to-slate-800 text-white px-4 py-3 rounded-lg shadow-lg min-w-[160px] text-center border border-slate-700">
              <h3 class="font-black text-base uppercase tracking-tight mb-1">ADMINISTRAÇÃO</h3>
              <p class="text-xs">Tony Ventura</p>
            </div>
          </div>

          <!-- Nível de Staff (Contabilidade/SGQA) -->
          <div class="flex justify-center gap-8 mb-10 relative">
            
            <!-- Contabilidade -->
            <div class="flex flex-col items-center relative">
              <div class="mb-2 p-1.5 bg-blue-100 rounded-full text-blue-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-6 3h12a2 2 0 002-2V9a2 2 0 00-2-2H3a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
              </div>
              <button class="org-dept-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-blue-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="CONTABILIDADE" data-staff="Lúcio Mota|Ricardo Costa">
                <h3 class="font-bold uppercase text-xs">CONTABILIDADE</h3>
              </button>
            </div>

            <!-- SGQA -->
            <div class="flex flex-col items-center relative">
              <div class="mb-2 p-1.5 bg-green-100 rounded-full text-green-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
              </div>
              <button class="org-dept-btn bg-green-600 hover:bg-green-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-green-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="SGI" data-staff="Mário Fragoso">
                <h3 class="font-bold uppercase text-xs">SGI</h3>
              </button>
            </div>
          </div>

          <!-- Departamentos (Nível Inferior) -->
          <div class="relative pt-10 w-full flex justify-center gap-2 flex-wrap pb-4">
            
            <!-- Pós Venda -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-red-100 rounded-full text-red-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
              </div>
              <button class="org-dept-btn bg-red-600 hover:bg-red-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-red-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Pós Venda" data-staff="Carina Robaina|Cândido Veloso|Tiago Oliveira|Tiago Dias|Alexandre Neves|Leonel Pereira">
                <h3 class="font-bold uppercase text-xs">Pós Venda</h3>
              </button>
            </div>

            <!-- Financeiro -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-amber-100 rounded-full text-amber-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              </div>
              <button class="org-dept-btn bg-amber-600 hover:bg-amber-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-amber-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Financeiro" data-staff="Lúcio Mota">
                <h3 class="font-bold uppercase text-xs">Financeiro</h3>
              </button>
            </div>

            <!-- Produção -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-orange-100 rounded-full text-orange-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
              </div>
              <button class="org-dept-btn bg-orange-600 hover:bg-orange-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-orange-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Produção" data-staff="Joni Regalado|Fábio Silva|Carlos Almeida|Tiago Dias|Alexandre Neves|Leonel Pereira|Ilídio Ferreira|Octávio Silva|Abel Tavares|Pedro Barreira|Manuel Martins">
                <h3 class="font-bold uppercase text-xs">Produção</h3>
              </button>
            </div>

            <!-- R&D -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-purple-100 rounded-full text-purple-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5h.01M9 9h.01"></path></svg>
              </div>
              <button class="org-dept-btn bg-purple-600 hover:bg-purple-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-purple-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="R&D" data-staff="Joni Regalado|Jonathan Santos|Ricardo Hipólito|Miguel Marta">
                <h3 class="font-bold uppercase text-xs">R&D</h3>
              </button>
            </div>

            <!-- Compras -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-blue-100 rounded-full text-blue-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
              </div>
              <button class="org-dept-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-blue-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Compras" data-staff="Paulo Brioso|Lúcio Mota">
                <h3 class="font-bold uppercase text-xs">Compras</h3>
              </button>
            </div>

            <!-- Logística -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-indigo-100 rounded-full text-indigo-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M8 20h8a2 2 0 002-2V8a2 2 0 00-2-2H8a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
              </div>
              <button class="org-dept-btn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-indigo-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Logística" data-staff="Lúcio Mota|Paulo Brioso|Carlos Tarenta">
                <h3 class="font-bold uppercase text-xs">Logística</h3>
              </button>
            </div>

            <!-- Comercial -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-emerald-100 rounded-full text-emerald-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L5.257 18.757M13 7L5.257 15.757"></path></svg>
              </div>
              <button class="org-dept-btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-emerald-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Comercial" data-staff="Tony Ventura|NACIONAL - Manuel Diniz|INTERNACIONAL - Tony Ventura|INTERNACIONAL - David Borges|INTERNACIONAL - André Quental|INTERNACIONAL - Renato Gomes|INTERNACIONAL - Davide Sturla|INTERNACIONAL - Diogo Sousa|INTERNACIONAL - David Mendez">
                <h3 class="font-bold uppercase text-xs">Comercial</h3>
              </button>
            </div>

            <!-- MArketing -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-amber-100 rounded-full text-amber-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L5.257 18.757M13 7L5.257 15.757"></path></svg>
              </div>
              <button class="org-dept-btn bg-amber-600 hover:bg-amber-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-amber-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Marketing" data-staff="Tony Ventura| António Jorge">
                <h3 class="font-bold uppercase text-xs">Marketing</h3>
              </button>
            </div>

            <!-- IoT (Novo Departamento) -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-cyan-100 rounded-full text-cyan-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
              </div>
              <button class="org-dept-btn bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-cyan-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="IoT" data-staff="Samuel Póvoa">
                <h3 class="font-bold uppercase text-xs">IoT</h3>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal para exibir pessoal do departamento -->
      <div id="org-staff-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
          <div class="flex justify-between items-center mb-4 pb-4 border-b-2">
            <h2 id="org-modal-title" class="font-bold text-xl uppercase">Departamento</h2>
            <button onclick="closeOrgStaffModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
          </div>
          <div id="org-modal-staff" class="space-y-2 max-h-96 overflow-y-auto">
            <!-- Staff list will be inserted here -->
          </div>
          <button onclick="closeOrgStaffModal()" class="w-full mt-6 bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg transition-colors">Fechar</button>
        </div>
      </div>

      <!-- Vista de Detalhes Operacionais -->
      <div id="org-details-view" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Pós Venda -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
          <div class="flex items-center gap-3 mb-4 pb-4 border-b-2 border-red-500/30">
            <div class="p-2 bg-red-100 rounded-lg text-red-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            </div>
            <h2 class="font-black text-red-700 uppercase text-sm">Fluxos Pós Venda</h2>
          </div>
          <div class="space-y-4">
            <div class="p-3 bg-red-50 border-l-4 border-red-500 rounded">
              <p class="font-bold text-red-900 text-sm mb-2">PÓS VENDA - Carina Robaina</p>
              <ul class="text-xs text-red-800 space-y-1">
                <li>• Planeamento: Instalação de Equipamentos</li>
                <li>• Equipas de Instalação</li>
                <li>• Logística: Envio de peças de substituição</li>
              </ul>
              <p class="text-[9px] font-semibold italic text-red-700 mt-2">⚠️ Em CC sempre service@somengil.com</p>
            </div>
            <div class="p-3 bg-red-50 border-l-4 border-red-500 rounded">
              <p class="font-bold text-red-900 text-sm mb-2">PÓS VENDA - Cândido Veloso</p>
              <ul class="text-xs text-red-800 space-y-1">
                <li>• Suporte Técnico</li>
                <li>• Instalação de Equipamentos</li>
                <li>• Funcionamento não standard</li>
                <li>• Prevenção</li>
              </ul>
              <p class="text-[9px] font-semibold italic text-red-700 mt-2">⚠️ Em CC sempre service@somengil.com</p>
            </div>
            <div class="p-3 bg-red-50 border-l-4 border-red-500 rounded">
              <p class="font-bold text-red-900 text-sm mb-2">PÓS VENDA - Tiago Oliveira</p>
              <ul class="text-xs text-red-800 space-y-1">
                <li>• Planeamento Live Demos</li>
                <li>• Teste e Demonstrações</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- R&D & Logística -->
        <div class="space-y-6">
          <!-- R&D -->
          <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
            <div class="flex items-center gap-3 mb-4 pb-4 border-b-2 border-purple-500/30">
              <div class="p-2 bg-purple-100 rounded-lg text-purple-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5h.01M9 9h.01"></path></svg>
              </div>
              <h2 class="font-black text-purple-700 uppercase text-sm">Planeamento R&D</h2>
            </div>
            <div class="space-y-3">
              <div class="p-3 bg-purple-50 border-l-4 border-purple-500 rounded">
                <p class="font-bold text-purple-900 text-sm mb-1">R&D - Joni Regalado</p>
                <ul class="text-xs text-purple-800 space-y-1">
                  <li>• Planeamento: Início Produção</li>
                  <li>• Data de Entrega</li>
                </ul>
              </div>
              <div class="p-3 bg-purple-50 border-l-4 border-purple-500 rounded">
                <p class="font-bold text-purple-900 text-sm mb-1">R&D - Jonathan Santos</p>
                <ul class="text-xs text-purple-800 space-y-1">
                  <li>• Desenvolvimento: MULTIWASHER</li>
                </ul>
              </div>
              <div class="p-3 bg-purple-50 border-l-4 border-purple-500 rounded">
                <p class="font-bold text-purple-900 text-sm mb-1">R&D - Ricardo Hipólito</p>
                <ul class="text-xs text-purple-800 space-y-1">
                  <li>• Desenvolvimento: TROLLEYS</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Logística -->
          <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
            <div class="flex items-center gap-3 mb-4 pb-4 border-b-2 border-indigo-500/30">
              <div class="p-2 bg-indigo-100 rounded-lg text-indigo-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M8 20h8a2 2 0 002-2V8a2 2 0 00-2-2H8a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
              </div>
              <h2 class="font-black text-indigo-700 uppercase text-sm">Logística & Envio</h2>
            </div>
            <div class="space-y-3">
              <div class="p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                <p class="font-bold text-indigo-900 text-sm mb-1">Logística - Lúcio Mota</p>
                <ul class="text-xs text-indigo-800 space-y-1">
                  <li>• Planeamento Envio Equipamentos: INTERNACIONAL</li>
                </ul>
              </div>
              <div class="p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                <p class="font-bold text-indigo-900 text-sm mb-1">Logística - Paulo Brioso</p>
                <ul class="text-xs text-indigo-800 space-y-1">
                  <li>• Planeamento Envio Equipamentos: NACIONAL</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- IoT -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
          <div class="flex items-center gap-3 mb-4 pb-4 border-b-2 border-cyan-500/30">
            <div class="p-2 bg-cyan-100 rounded-lg text-cyan-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <h2 class="font-black text-cyan-700 uppercase text-sm">IoT & Inovação</h2>
          </div>
          <div class="space-y-3">
            <div class="p-3 bg-cyan-50 border-l-4 border-cyan-500 rounded">
              <p class="font-bold text-cyan-900 text-sm mb-1">IoT - Samuel Póvoa</p>
              <ul class="text-xs text-cyan-800 space-y-1">
                <li>• Desenvolvimento de Soluções IoT</li>
                <li>• Integração de Sistemas Inteligentes</li>
                <li>• Monitorização Remota</li>
              </ul>
            </div>
            <div class="p-3 bg-cyan-50 border-l-4 border-cyan-500 rounded">
              <p class="font-bold text-cyan-900 text-sm mb-1">IoT - Joni Regalado</p>
              <ul class="text-xs text-cyan-800 space-y-1">
                <li>• Coordenação Técnica IoT</li>
                <li>• Integração com Produção</li>
                <li>• Validação e Testes</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Estrutura Comercial -->
        <div class="lg:col-span-2 bg-white rounded-xl p-6 shadow-sm border border-slate-200">
          <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-emerald-500/30">
            <div class="p-2 bg-emerald-100 rounded-lg text-emerald-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L5.257 18.757M13 7L5.257 15.757"></path></svg>
            </div>
            <h2 class="font-black text-emerald-700 uppercase text-sm">Estrutura Comercial</h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-emerald-50 rounded-lg p-4 border-l-4 border-emerald-600">
              <h3 class="font-bold text-emerald-900 text-sm mb-3 uppercase">Nacional</h3>
              <div class="space-y-2 text-sm text-emerald-800">
                <p>✓ Manuel Diniz</p>
              </div>
            </div>
            <div class="bg-emerald-50 rounded-lg p-4 border-l-4 border-emerald-600">
              <h3 class="font-bold text-emerald-900 text-sm mb-3 uppercase">Comercial Internacional</h3>
              <div class="space-y-2 text-[12px] text-emerald-800">
                <p>✓ Tony Ventura</p>
                <p>✓ David Borges</p>
                <p>✓ André Quental</p>
                <p>✓ Renato Gomes</p>
              </div>
            </div>
            <div class="bg-emerald-50 rounded-lg p-4 border-l-4 border-emerald-600">
              <h3 class="font-bold text-emerald-900 text-sm mb-3 uppercase">Marketing</h3>
              <div class="space-y-2 text-sm text-emerald-800">
                <p>✓ Tony Ventura</p>
                <p>✓ António Jorge</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Missão e Visão -->
      <div class="space-y-8">
        <!-- Missão e Visão -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Missão -->
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-8 border-2 border-blue-300 shadow-lg">
            <div class="flex items-center gap-3 mb-6">
              <div class="p-3 bg-blue-600 rounded-full text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
              </div>
              <h2 class="text-2xl font-black text-blue-900 uppercase">Missão</h2>
            </div>
            <p class="text-blue-900 leading-relaxed font-medium text-sm">
              Entregar eficientemente o mais alto padrão de produtos de lavagem industrial e prestar um serviço de excelência no apoio ao cliente, utilizando este nível elevado de suporte técnico para diferenciar o grupo e promover o crescimento internacional.
            </p>
          </div>

          <!-- Visão -->
          <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-8 border-2 border-emerald-300 shadow-lg">
            <div class="flex items-center gap-3 mb-6">
              <div class="p-3 bg-emerald-600 rounded-full text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
              </div>
              <h2 class="text-2xl font-black text-emerald-900 uppercase">Visão</h2>
            </div>
            <p class="text-emerald-900 leading-relaxed font-medium text-sm">
              Ser uma organização inovadora e marca de referência mundial na área da lavagem industrial, pautando a imagem do grupo pelo reconhecimento mundial do Know-How e capacidade de inovação, através de equipamentos industriais que promovam a eficiência energética e produtividade.
            </p>
          </div>
        </div>

        <!-- Como alcançaremos a nossa missão -->
        <div class="bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-xl p-8 shadow-lg">
          <h2 class="text-2xl font-black uppercase mb-8 flex items-center gap-3">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Como alcançaremos a nossa missão
          </h2>
          <ol class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm font-semibold">
            <li class="flex items-start gap-4">
              <span class="flex-shrink-0 w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center font-black text-white">1</span>
              <span class="pt-1">Respeitaremos todas as pessoas</span>
            </li>
            <li class="flex items-start gap-4">
              <span class="flex-shrink-0 w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center font-black text-white">2</span>
              <span class="pt-1">Lideraremos com humildade</span>
            </li>
            <li class="flex items-start gap-4">
              <span class="flex-shrink-0 w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center font-black text-white">3</span>
              <span class="pt-1">Agiremos com senso de urgência</span>
            </li>
            <li class="flex items-start gap-4">
              <span class="flex-shrink-0 w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center font-black text-white">4</span>
              <span class="pt-1">Trabalharemos em equipa</span>
            </li>
            <li class="flex items-start gap-4">
              <span class="flex-shrink-0 w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center font-black text-white">5</span>
              <span class="pt-1">Resolveremos os problemas rapidamente</span>
            </li>
            <li class="flex items-start gap-4">
              <span class="flex-shrink-0 w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center font-black text-white">6</span>
              <span class="pt-1">Planearemos antes de fazer</span>
            </li>
          </ol>
        </div>
      </div>

      <!-- Legenda -->
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-6 rounded-xl flex flex-wrap gap-6 justify-center">
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-slate-700 rounded border border-slate-600"></div>
          <span class="text-sm font-semibold">Direção</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-red-600 rounded"></div>
          <span class="text-sm font-semibold">Pós Venda</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-amber-600 rounded"></div>
          <span class="text-sm font-semibold">Financeiro</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-orange-600 rounded"></div>
          <span class="text-sm font-semibold">Produção</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-purple-600 rounded"></div>
          <span class="text-sm font-semibold">R&D</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-blue-600 rounded"></div>
          <span class="text-sm font-semibold">Compras</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-indigo-600 rounded"></div>
          <span class="text-sm font-semibold">Logística</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-emerald-600 rounded"></div>
          <span class="text-sm font-semibold">Comercial</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-amber-600 rounded"></div>
          <span class="text-sm font-semibold">Marketing</span>
        </div>        
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-cyan-600 rounded"></div>
          <span class="text-sm font-semibold">IoT</span>
        </div>
      </div>
    </div>

    <!-- CONTEÚDO: PLANEAMENTO REUNIÕES -->
    <div id="view-planning-meetings" class="hidden space-y-6">
      <!-- Cabeçalho -->
      <div class="bg-gradient-to-r from-blue-900 to-blue-800 text-white p-8 rounded-2xl shadow-lg">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
          <div>
            <button onclick="switchPlanningView('main')" class="text-blue-200 hover:text-white transition-colors text-sm font-semibold mb-3 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
              Voltar
            </button>
            <h1 class="text-3xl font-black tracking-tight">CALENDÁRIO DE REUNIÕES</h1>
            <p class="text-blue-200 text-sm mt-2">Plano Anual 2026 - Clique nos círculos para editar</p>
          </div>
        </div>
      </div>

      <!-- Tabela de Reuniões -->
      <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full border-collapse text-left text-sm">
            <thead>
              <tr class="bg-slate-900 text-white">
                <th class="p-4 font-bold sticky left-0 bg-slate-900 z-10 w-80">Tipo de Reunião</th>
                <th class="p-3 font-bold text-center w-16">Responsável</th>
                <th class="p-3 font-bold text-center w-12">Jan</th>
                <th class="p-3 font-bold text-center w-12">Fev</th>
                <th class="p-3 font-bold text-center w-12">Mar</th>
                <th class="p-3 font-bold text-center w-12">Abr</th>
                <th class="p-3 font-bold text-center w-12">Mai</th>
                <th class="p-3 font-bold text-center w-12">Jun</th>
                <th class="p-3 font-bold text-center w-12">Jul</th>
                <th class="p-3 font-bold text-center w-12">Ago</th>
                <th class="p-3 font-bold text-center w-12">Set</th>
                <th class="p-3 font-bold text-center w-12">Out</th>
                <th class="p-3 font-bold text-center w-12">Nov</th>
                <th class="p-3 font-bold text-center w-12">Dez</th>
              </tr>
            </thead>
            <tbody id="meetingsTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Legenda -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-wrap justify-center gap-8">
        <div class="flex items-center gap-2">
          <div class="text-2xl">🟢</div>
          <span class="font-semibold text-slate-700">Realizado</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="text-2xl">🔵</div>
          <span class="font-semibold text-slate-700">Planeado</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="text-2xl">🔴</div>
          <span class="font-semibold text-slate-700">Não Realizado</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="text-2xl">⭕</div>
          <span class="font-semibold text-slate-700">Vazio</span>
        </div>
      </div>
    </div>

    <!-- CONTEÚDO: PLANEAMENTO AUDITORIAS -->
    <div id="view-planning-audits" class="hidden space-y-6">
      <!-- Cabeçalho -->
      <div class="bg-gradient-to-r from-amber-900 to-amber-800 text-white p-8 rounded-2xl shadow-lg">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
          <div>
            <button onclick="switchPlanningView('main')" class="text-amber-200 hover:text-white transition-colors text-sm font-semibold mb-3 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
              Voltar
            </button>
            <h1 class="text-3xl font-black tracking-tight">CALENDÁRIO DE AUDITORIAS</h1>
            <p class="text-amber-200 text-sm mt-2">Plano Anual 2026 - Clique para editar Data Realizada</p>
          </div>
        </div>
      </div>

      <!-- Tabela de Auditorias -->
      <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full border-collapse text-left text-sm">
            <thead>
              <tr class="bg-slate-900 text-white">
                <th class="p-3 font-bold w-14">Mês</th>
                <th class="p-3 font-bold">Data Planeada</th>
                <th class="p-3 font-bold w-16">Horário</th>
                <th class="p-3 font-bold w-20">Local</th>
                <th class="p-3 font-bold">Processo</th>
                <th class="p-3 font-bold">Auditor(es)</th>
                <th class="p-3 font-bold">Local Auditoria</th>
                <th class="p-3 font-bold">Data Realizada</th>
                <th class="p-3 font-bold">Gestor</th>
                <th class="p-3 font-bold">Observações</th>
              </tr>
            </thead>
            <tbody id="auditsTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Legenda -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-wrap justify-center gap-8">
        <div class="bg-blue-100 border border-blue-300 px-4 py-2 rounded-lg text-sm font-semibold text-blue-900">
        Auditoria Externa
        </div>
        <div class="bg-green-100 border border-green-300 px-4 py-2 rounded-lg text-sm font-semibold text-green-900">
        Auditoria Interna
        </div>
      </div>
    </div>

    <!-- CONTEÚDO: PLANEAMENTO -->
    <div id="view-planning" class="hidden space-y-8">
      <!-- Cabeçalho do Planeamento -->
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-8 rounded-2xl shadow-lg">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
          <div>
            <h1 class="text-4xl font-black tracking-tight">PLANEAMENTO</h1>
            <p class="text-slate-300 text-sm mt-2">Plano Anual de Reuniões e Auditorias - SOMENGIL</p>
          </div>
        </div>
      </div>

      <!-- Cards de Navegação -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        <!-- Card Reuniões -->
        <button onclick="switchPlanningView('meetings')" class="group bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-2xl p-8 hover:shadow-2xl transition-all transform hover:scale-105 active:scale-95 cursor-pointer">
          <div class="flex flex-col items-center text-center gap-4">
            <div class="bg-blue-600 p-4 rounded-full group-hover:bg-blue-700 transition-colors shadow-lg">
              <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>
            <div>
              <h2 class="text-2xl font-black text-blue-900 mb-2">REUNIÕES</h2>
              <p class="text-blue-700 text-sm mb-4">
                Gestão e planeamento de reuniões estratégicas, operacionais e de revisão
              </p>
              <p class="text-xs text-blue-600 font-semibold">
                17 reuniões planeadas
              </p>
            </div>
            <div class="flex items-center gap-2 text-blue-600 font-semibold group-hover:gap-3 transition-all mt-4">
              Ver Calendário
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </div>
          </div>
        </button>

        <!-- Card Auditorias -->
        <button onclick="switchPlanningView('audits')" class="group bg-gradient-to-br from-amber-50 to-amber-100 border-2 border-amber-200 rounded-2xl p-8 hover:shadow-2xl transition-all transform hover:scale-105 active:scale-95 cursor-pointer">
          <div class="flex flex-col items-center text-center gap-4">
            <div class="bg-amber-600 p-4 rounded-full group-hover:bg-amber-700 transition-colors shadow-lg">
              <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m7-0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div>
              <h2 class="text-2xl font-black text-amber-900 mb-2">AUDITORIAS</h2>
              <p class="text-amber-700 text-sm mb-4">
                Plano de auditorias internas e externas conforme calendário anual
              </p>
              <p class="text-xs text-amber-600 font-semibold">
                13 auditorias agendadas
              </p>
            </div>
            <div class="flex items-center gap-2 text-amber-600 font-semibold group-hover:gap-3 transition-all mt-4">
              Ver Calendário
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </div>
          </div>
        </button>
      </div>

      <!-- Resumo de Atividades -->
      <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-8">
        <h2 class="text-2xl font-black text-slate-900 mb-6 flex items-center gap-3">
          <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          Atividades Agendadas para 2026
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
            <p class="text-sm text-blue-600 font-bold uppercase mb-2">Reuniões Planeadas</p>
            <p class="text-4xl font-black text-blue-900">17</p>
            <p class="text-xs text-blue-700 mt-2">Distribuídas ao longo do ano</p>
          </div>
          <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-6 border border-amber-200">
            <p class="text-sm text-amber-600 font-bold uppercase mb-2">Auditorias Agendadas</p>
            <p class="text-4xl font-black text-amber-900">13</p>
            <p class="text-xs text-amber-700 mt-2">Internas e Externas (APCER)</p>
          </div>
          <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-6 border border-emerald-200">
            <p class="text-sm text-emerald-600 font-bold uppercase mb-2">Months</p>
            <p class="text-4xl font-black text-emerald-900">12</p>
            <p class="text-xs text-emerald-700 mt-2">Cobertura anual completa</p>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTEÚDO: PDCA -->
    <div id="view-pdca" class="hidden space-y-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
          <h2 class="text-2xl font-black text-slate-800 tracking-tight">Ciclo PDCA</h2>
          <p class="text-slate-500 text-sm">Planeamento, Execução, Verificação e Ação Corretiva</p>
        </div>

        <div class="flex items-center gap-2">
          <a
            href="https://docs.google.com/spreadsheets/d/1kep8pBEA2ZS0e-dKZKhrvJeOd-BghpZiXRJ2_WSFmzM/edit?usp=sharing"
            target="_blank"
            rel="noopener"
            class="text-[10px] font-black text-slate-600 hover:text-slate-800 uppercase tracking-widest bg-white px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition-all"
            title="Abrir Google Sheets (origem dos dados PDCA)"
          >
            DOCUMENTO DE ORIGEM
          </a>

          <button
            onclick="refreshPdcaData()"
            id="pdcaRefreshBtn"
            class="text-[10px] font-black text-slate-600 hover:text-slate-800 uppercase tracking-widest bg-white px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition-all flex items-center gap-2"
            title="Forçar atualização com o Google Sheets"
          >
            <svg class="w-4 h-4 inline-block" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 5.199V4a1 1 0 011-1zm.008 9a1 1 0 011.992 0A5.002 5.002 0 0014.001 14.8V16a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 11 1.885-.666A5.002 5.002 0 0114.001 14.801V16a1 1 0 112 0v-2.199a7.002 7.002 0 01-11.993-4.801z" clip-rule="evenodd" />
            </svg>
            ATUALIZAR
          </button>

        </div>
      </div>

      <!-- Barra de Filtros PDCA -->
      <div class="glass-card p-4 space-y-4">
        <div class="flex flex-col gap-4">
          <!-- Filtros Fixos: ANO -->
          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 overflow-x-auto pb-2 md:pb-0">
            <span class="mr-2 whitespace-nowrap">Ano:</span>
            <button onclick="setPdcaFilter('ano', 'TODOS')" id="filter-pdca-ano-TODOS" class="pdca-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">TODOS</button>
            <div id="pdca-ano-filters" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Busca por Origem -->
          <div class="flex items-center gap-3">
            <span class="text-[10px] font-bold uppercase text-slate-400 whitespace-nowrap">Origem:</span>
            <input type="text" id="searchOrigemPdca" onkeyup="filterPdcaBySearch('origem')" placeholder="Pesquisar origem..." class="flex-1 bg-slate-50 border border-slate-200 pl-3 pr-4 py-2 rounded-lg text-xs outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500 transition-all">
            <button onclick="clearPdcaSearch('origem')" class="text-[10px] font-black text-slate-500 hover:text-slate-700 px-2 py-1">✕</button>
          </div>

          <!-- Filtro Expandível: PROCESSO -->
          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 overflow-x-auto pb-2 md:pb-0">
            <span class="mr-2 whitespace-nowrap">Processo:</span>
            <button onclick="setPdcaFilter('processo', 'TODOS')" id="filter-pdca-processo-TODOS" class="pdca-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">TODOS</button>
            <div id="pdca-processo-filters" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Busca por Responsável -->
          <div class="flex items-center gap-3">
            <span class="text-[10px] font-bold uppercase text-slate-400 whitespace-nowrap">Responsável:</span>
            <input type="text" id="searchResponsavelPdca" onkeyup="filterPdcaBySearch('responsavel')" placeholder="Pesquisar responsável..." class="flex-1 bg-slate-50 border border-slate-200 pl-3 pr-4 py-2 rounded-lg text-xs outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500 transition-all">
            <button onclick="clearPdcaSearch('responsavel')" class="text-[10px] font-black text-slate-500 hover:text-slate-700 px-2 py-1">✕</button>
          </div>

          <!-- Filtros Fixos: STATUS -->
          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 overflow-x-auto pb-2 md:pb-0">
            <span class="mr-2 whitespace-nowrap">Status:</span>
            <button onclick="setPdcaFilter('status', 'TODOS')" id="filter-pdca-status-TODOS" class="pdca-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">TODOS</button>
            <div id="pdca-status-filters" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Filtros Fixos: EFICÁCIA -->
          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 overflow-x-auto pb-2 md:pb-0">
            <span class="mr-2 whitespace-nowrap">Eficácia:</span>
            <button onclick="setPdcaFilter('eficacia', 'TODOS')" id="filter-pdca-eficacia-TODOS" class="pdca-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">TODOS</button>
            <div id="pdca-eficacia-filters" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
      </div>

      <div class="glass-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="bg-slate-50 border-b border-slate-100">
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Item</th>
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Data de Registo</th>
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Ano</th>
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Origem</th>
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Processo</th>
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Ação a Realizar</th>
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Responsável</th>
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Prazo</th>
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Data Conclusão</th>
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Status</th>
                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-widest">Eficácia</th>
              </tr>
            </thead>
            <tbody id="pdcaTableBody" class="divide-y divide-slate-50">
              <tr><td colspan="11" class="px-8 py-20 text-center"><div class="flex justify-center items-center gap-3"><div class="loading-spinner"></div><span class="text-slate-400 font-bold uppercase text-[10px]">A carregar dados PDCA...</span></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Detalhe SWOT do R&O -->
  <div id="roSwotModal" class="fixed inset-0 hidden z-[120] items-center justify-center bg-slate-900/60 backdrop-blur-sm" onclick="closeRoSwotModal(event)">
    <div class="glass-card w-full max-w-2xl p-8 m-4 shadow-2xl overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-black text-slate-800 tracking-tight">Detalhe SWOT</h2>
        <button onclick="closeRoSwotModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="roSwotModalContent" class="space-y-4">
        <!-- Conteúdo preenchido dinamicamente -->
      </div>
    </div>
  </div>

  <!-- Modal: Detalhe Eficácia PDCA -->
  <div id="pdcaEficaciaModal" class="fixed inset-0 hidden z-[120] items-center justify-center bg-slate-900/60 backdrop-blur-sm" onclick="closePdcaEficaciaModal(event)">
    <div class="glass-card w-full max-w-2xl p-8 m-4 shadow-2xl overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-black text-slate-800 tracking-tight">Detalhe Eficácia</h2>
        <button onclick="closePdcaEficaciaModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="pdcaEficaciaModalContent" class="space-y-4">
        <!-- Conteúdo preenchido dinamicamente -->
      </div>
    </div>
  </div>

  <script>
    const MAIN_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdEqBsG1Fbt_KJNnyXtbZQPRvTLKwdzn1SFZcJm6Lw3HSctLGQmp2h9sBgxR6fiUPgBw/exec';
    const SWOT_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWndlm0j_tgScKnzmKoHxNGqlLmccRNi0LfFI50K5fWipMRsEW3PnsNA9MgeKJMmvz/exec';
    const SWOT_WRITE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzQNDfWCVPYPz84y7CU2BUYWbN-Orh0hq7CLzmjuCu1vrDnKRe7WgskN6ZXjsSQDSHJ/exec';
    const RO_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWndlm0j_tgScKnzmKoHxNGqlLmccRNi0LfFI50K5fWipMRsEW3PnsNA9MgeKJMmvz/exec';
    const PARTES_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbySf0L0PneuiBKavciBvnj-9mHGfKMImtYhhrRIVsLG27_q47l3LNCG74pPa2wKOhKC1A/exec';
    const PDCA_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyfL60bEV1FylAgXUvGn_QemQQXlyvBF5s5F4DxBCWmGxcPsdn8bDP7JOtmRy8AZa_/exec';

    let allDocuments = [];
    let swotData = [];
    let roData = [];
    let partesData = [];
    let pdcaData = [];
    let currentPdcaFilters = {
      ano: [],
      processo: [],
      status: [],
      eficacia: []
    };

    let currentDocTypeFilters = new Set(); // Multi-select para tipos de documentos
    let currentSwotFilterCategory = 'TODOS';
    let currentSwotFilterQuadrant = 'TODOS';
    let currentSwotActiveFilter = 'TODOS'; // TODOS | ATIVOS | NAO_ATIVOS
    let currentSwotPlanFilter = 'TODOS';   // TODOS | S | N
    let roTypeFilter = 'todos';   // 'todos', 'risco', 'oportunidade'
    let currentRoFilters = {
      processo: [],
      origem: []
    };
    
    // Dados das reuniões 2026
    const meetingsData = [
      { id: 1, title: "1) Steering Commitee", responsible: "TV", schedule: { 2: 'done', 10: 'done', 12: 'planned' } },
      { id: 2, title: "A) Reunião Revisão de Gestão - A situação de ações provenientes de análises críticas anteriores pela direção;", responsible: "MF", schedule: { 2: 'done', 10: 'done' } },
      { id: 3, title: "a1) PAC's - resultados de monitoramento e medição (eficácia);", responsible: "MF", schedule: {} },
      { id: 4, title: "a2) A eficácia de ações tomadas para abordar riscos e oportunidades;", responsible: "MF", schedule: {} },
      { id: 5, title: "B) Reunião Revisão de Gestão - Mudanças em questões externas e internas que sejam pertinentes para o sistema de gestão da qualidade;", responsible: "MF", schedule: { 2: 'done', 10: 'done', 12: 'planned' } },
      { id: 6, title: "b1) Oportunidades para melhoria;", responsible: "MF", schedule: {} },
      { id: 7, title: "b2) A suficiência de recursos;", responsible: "MF", schedule: {} },
      { id: 8, title: "2) Satisfação do cliente e retroalimentação de partes interessadas pertinentes;", responsible: "MF", schedule: { 2: 'done', 10: 'done' } },
      { id: 9, title: "3) Extensão na qual os objetivos da qualidade foram alcançados - KPI's;", responsible: "MF", schedule: { 2: 'done', 10: 'done' } },
      { id: 10, title: "4) Auditoria de Acompanhamento - desempenho de processo e conformidade de produtos e serviços;", responsible: "MF", schedule: { 10: 'done' } },
      { id: 11, title: "5) RNC's - não conformidades e ações corretivas;", responsible: "MF", schedule: { 1: 'done', 12: 'planned' } },
      { id: 12, title: "6) Auditoria interna SGQA - resultados de auditoria;", responsible: "MF", schedule: { 9: 'done', 10: 'done' } },
      { id: 13, title: "7) Avaliação desempenho de fornecedores externos - FastFer;", responsible: "MF", schedule: {} },
      { id: 14, title: "8) KOM Abertura - Histórico RNC's últimos 2 anos;", responsible: "MF", schedule: { 12: 'planned' } },
      { id: 15, title: "9) Auditoria de Produto", responsible: "MF", schedule: {} },
      { id: 16, title: "7) Auditoria externa SGQA - 1ª Fase", responsible: "MF", schedule: { 10: 'done' } },
      { id: 17, title: "9) Auditoria externa SGQA - 2ª Fase", responsible: "MF", schedule: { 10: 'done' } },
    ];

    const auditsData = [
      { id: 1, month: "Abril", plannedDate: "14-abr.-26", time: "10:30", location: "SOMENGIL", process: "Compras", auditor: "Joni Regalado & Mário Fragoso", auditLocation: "Gabinete Compras", realizedDate: "", manager: "Paulo Brioso", notes: "Auditoria Interna" },
      { id: 2, month: "Abril", plannedDate: "14-abr.-26", time: "10:30", location: "SOMENGIL", process: "Financeiro", auditor: "Joni Regalado & Mário Fragoso", auditLocation: "Gabinete Financeiro", realizedDate: "", manager: "Lúcio Mota", notes: "Auditoria Interna" },
      { id: 3, month: "Abril", plannedDate: "14-abr.-26", time: "11:30", location: "SOMENGIL", process: "Logística Interna", auditor: "Joni Regalado & Mário Fragoso", auditLocation: "Armazém Logístico", realizedDate: "", manager: "Carlos Tarenta", notes: "Auditoria Interna" },
      { id: 4, month: "Abril", plannedDate: "14-abr.-26", time: "12:30", location: "SOMENGIL", process: "Produção - Setor Montagem", auditor: "Joni Regalado & Mário Fragoso", auditLocation: "Chão de Fábrica", realizedDate: "", manager: "Fábio Silva", notes: "Auditoria Interna" },
      { id: 5, month: "Abril", plannedDate: "14-abr.-26", time: "15:00", location: "SOMENGIL", process: "Pós Venda [Assistência Técnica]", auditor: "Joni Regalado & Mário Fragoso", auditLocation: "Gabinete de Pós-Venda", realizedDate: "", manager: "Carina Robaina", notes: "Auditoria Interna" },
      { id: 6, month: "Abril", plannedDate: "15-abr.-26", time: "10:45", location: "SOMENGIL", process: "Comercial & Marketing", auditor: "Joni Regalado & Mário Fragoso", auditLocation: "Sala de Reuniões", realizedDate: "", manager: "Tony Ventura", notes: "Auditoria Interna" },
      { id: 7, month: "Abril", plannedDate: "15-abr.-26", time: "11:30", location: "SOMENGIL", process: "Gestão de Negócio", auditor: "Joni Regalado & Mário Fragoso", auditLocation: "Sala de Reuniões", realizedDate: "", manager: "Tony Ventura", notes: "Auditoria Interna" },
      { id: 8, month: "Abril", plannedDate: "15-abr.-26", time: "10:00", location: "SOMENGIL", process: "Gestão de Recursos", auditor: "Joni Regalado & Mário Fragoso", auditLocation: "Sala de Reuniões", realizedDate: "", manager: "Tony Ventura", notes: "Auditoria Interna" },
      { id: 9, month: "Abril", plannedDate: "15-abr.-26", time: "10:30", location: "SOMENGIL", process: "SGQA", auditor: "Joni Regalado", auditLocation: "Gabinete Qualidade", realizedDate: "", manager: "Mário Fragoso", notes: "Auditoria Interna" },
      { id: 10, month: "Abril", plannedDate: "15-abr.-26", time: "11:30", location: "SOMENGIL", process: "Engenharia", auditor: "Mário Fragoso", auditLocation: "Gabinete Qualidade", realizedDate: "", manager: "Mário Fragoso", notes: "Auditoria Interna" },
      { id: 11, month: "Setembro", plannedDate: "", time: "14:00", location: "SOMENGIL", process: "SGQA - Ambiental", auditor: "Ana Reis", auditLocation: "Sala de Reuniões", realizedDate: "", manager: "Mário Fragoso", notes: "Auditoria Interna" },
      { id: 12, month: "Outubro", plannedDate: "", time: "9:00", location: "SOMENGIL", process: "SGQA - Acompanhamento ISO 14001:2015", auditor: "Eng.º Daniel Nunes", auditLocation: "Somengil", realizedDate: "", manager: "Daniel Nunes", notes: "Auditoria Externa [APCER]" },
      { id: 13, month: "Outubro", plannedDate: "", time: "9:00", location: "SOMENGIL", process: "SGQA - Renovação de Certificação ISO 9001:2015", auditor: "Eng.º Daniel Nunes", auditLocation: "Somengil", realizedDate: "", manager: "Daniel Nunes", notes: "Auditoria Externa [APCER]" },
    ];

    const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

    // =========
    // Normalização
    // =========
    const normLoose = (s) => String(s || '')
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .trim();

    const keyLoose = (s) => normLoose(s).replace(/[^a-z0-9]/g, '');

    function getValLoose(obj, wantedKey) {
      const want = keyLoose(wantedKey);
      const found = Object.keys(obj || {}).find(k => keyLoose(k) === want);
      return found ? obj[found] : '';
    }

    function getAny(obj, keys) {
      for (const k of keys) {
        const v = getValLoose(obj, k);
        if (v !== undefined && v !== null && String(v).trim() !== '') return v;
      }
      return '';
    }

    // =========
    // ✅ Regras de códigos (S/W/O/T)
    // =========
    const SWOT_PREFIX = {
      "INTERNAL STRENGTHS": "S",
      "INTERNAL WEAKNESSES": "W",
      "EXTERNAL OPPORTUNITIES": "O",
      "EXTERNAL THREATS": "T"
    };

    function expectedPrefixFromSwotType(swotType) {
      return SWOT_PREFIX[String(swotType || '').trim()] || '';
    }

    function cleanMainCode(code) {
      return String(code || '')
        .toUpperCase()
        .replace(/\s+/g, '')
        .trim();
    }

    function deriveActionCode(mainCode, i) {
      const c = cleanMainCode(mainCode);
      if (!c) return '';
      return `${c}_${i}`;
    }

    function validateMainCodeAgainstType(swotType, mainCode) {
      const pref = expectedPrefixFromSwotType(swotType);
      const c = cleanMainCode(mainCode);
      if (!pref || !c) return true;
      return c.startsWith(pref);
    }

    function autofillActionCodes(force = false) {
      const mainCode = cleanMainCode(document.getElementById('swotCodigo')?.value || '');
      for (let i = 1; i <= 6; i++) {
        const codEl = document.getElementById(`acaoCod${i}`);
        const txtEl = document.getElementById(`acaoTxt${i}`);
        if (!codEl) continue;

        const hasText = !!(txtEl && String(txtEl.value || '').trim());
        const current = String(codEl.value || '').trim();

        if ((force || (hasText && !current)) && mainCode) {
          codEl.value = deriveActionCode(mainCode, i);
        }
      }
    }

    // =========
    // Categorias (por termos + regex)
    // =========
    const swotCategories = [
      { key:"Energia", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/energia|eletric|electr|kwh|autoconsumo|fotovoltaic|pv\b|baterias|auditoria energet/i]},
      { key:"Resíduos", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/residu|lixo|reciclag|segregac|valorizac|embalagen|perigos|ecoponto|oleo|quimic/i]},
      { key:"Água", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 13c0 5-3.5 7.5-7.667 7.5S4.667 18 4.667 13C4.667 8.5 12 2 12 2s7.333 6.5 7.333 11z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/agua|hidric|hidrico|hidrica|escassez|litros|efluen|auditoria hidric|tarif|reutiliz|reaproveit|circuito fechado|low water|water consumption/i, /\bwater\b|\blow water\b|\bwater consumption\b|\bwater saving\b/i]},
      { key:"Legal", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/lei|legislac|regulament|conformid|requisit|iso\b|ai act|csrd/i]},
      { key:"Equipa", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/equipa|pessoas|colaborador|rh\b|formac|treino|sensibiliz|competenc|cultura|clima|lideranc|bem[- ]?estar|burnout|psicossoc/i]},
      { key:"Emissões", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/co2|emiss|carbono|pegada|lca|scope/i]},
      { key:"Transporte", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" stroke-width="2"></path><path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/transporte|logistic|frota|veicul|combust|deslocac/i]}
    ];

    function getSwotCategory(text) {
      const txt = normLoose(text);
      if (!txt) return { key: "SGA", icon: '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>' };
      const cat = swotCategories.find(c => (c.patterns || []).some(p => p.test(txt)));
      return cat || { key: "SGA", icon: '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0 1 12 2.944a11.955 11.955 0 0 1-8.618 3.04A12.02 12.02 0 0 0 3 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-0.133-2.052-0.382-3.016z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>' };
    }

    function getSwotTagClass(key) {
      const k = normLoose(key);
      if (k === 'energia') return 'tag-energia';
      if (k === 'agua') return 'tag-agua';
      if (k === 'residuos') return 'tag-residuos';
      if (k === 'legal') return 'tag-legal';
      if (k === 'equipa') return 'tag-equipa';
      if (k === 'emissoes') return 'tag-emissoes';
      if (k === 'transporte') return 'tag-transporte';
      return 'tag-sga';
    }

    // =========
    // ✅ Tomada de Ação / Em Plano de Ação (robusto a cabeçalhos)
    // =========
    function getTomadaAcao(item) {
      return getAny(item, [
        'TOMADA DE AÇÃO',
        'TOMADA DE ACAO',
        'TOMADA DE AÇÃO?',
        'TOMADA DE ACAO?',
        'Tomada de Ação',
        'Tomada de Acao',
        'Tomada de Ação?',
        'Tomada de Acao?',
        'TOMADA',
        'tomada'
      ]);
    }

    function isYes(val) {
      const t = String(val || '').normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
      return (t === 'S' || t === 'SIM' || t === 'Y' || t === 'YES' || t === 'TRUE' || t === '1' || t === 'ATIVO' || t === 'ACTIVO');
    }

    function isAtivoFromTomada(tomada) {
      return isYes(tomada);
    }

    // ✅ este helper mantém a lógica "contém", não "igual"
    function keyLooseKeep(s) {
      return normLoose(s).replace(/[^a-z0-9]/g, '');
    }

    // encontra a coluna de "Em Plano de Ação <i> ... (S/N)" mesmo com variações
    function findPlanoKeyForIndex(item, i) {
      const keys = Object.keys(item || {});
      const idx = String(i);

      const candidates = keys.filter(k => {
        const kk = keyLooseKeep(k); // ex: "emplanodeacao1sn"
        const hasBase = kk.includes('emplanodeacao');
        const hasIdx = kk.includes(idx);
        const hasSN = kk.includes('sn'); // apanha (S/N), S/N, etc.
        return hasBase && hasIdx && hasSN;
      });

      candidates.sort((a,b) => a.length - b.length);
      return candidates[0] || '';
    }

    function getPlanoAcaoFlag(item, i) {
      const k = findPlanoKeyForIndex(item, i);
      if (!k) return '';
      return item[k] ?? '';
    }

    function buildPlanoMap(item) {
      const map = {};
      for (let i = 1; i <= 6; i++) map[i] = getPlanoAcaoFlag(item, i);
      return map;
    }

    function planoBadgeHtml(flag) {
      if (isYes(flag)) {
        return `<span class="px-2 py-0.5 rounded-full text-[8px] font-black bg-emerald-100 text-emerald-700 uppercase">Plano: S</span>`;
      }
      return `<span class="px-2 py-0.5 rounded-full text-[8px] font-black bg-amber-100 text-amber-800 uppercase">Plano: N</span>`;
    }

    // =========
    // Helpers SWOT (texto completo)
    // =========
    function buildSwotBlob(item) {
      const swotRaw = getAny(item, ['SWOT','Swot']);
      const codigo = getAny(item, ['código','Código','ID','id','codigo']);
      const descricao = getAny(item, ['Descrição','Descricao','DESC','desc']);
      const tomada = getTomadaAcao(item);

      let acoes = '';
      for (let i = 1; i <= 6; i++) {
        const cod = getAny(item, [
          `CÓDIGO_AÇÃO ${i}`, `CODIGO_ACAO ${i}`, `CÓDIGO AÇÃO ${i}`, `CODIGO ACAO ${i}`,
          `CODIGO_AÇÃO ${i}`, `CÓDIGO_ACAO ${i}`
        ]);
        const acao = getAny(item, [`AÇÃO ${i}`, `ACAO ${i}`, `Ação ${i}`, `Acao ${i}`]);
        const emPlano = getPlanoAcaoFlag(item, i);
        if (cod || acao || emPlano) acoes += ` ${cod} ${acao} ${emPlano}`;
      }

      return `${swotRaw} ${codigo} ${descricao} ${tomada} ${acoes}`.trim();
    }

    // =========
    // UI / Modais / Tabs
    // =========
    function openModal(){ document.getElementById('adminModal').classList.add('active'); }
    function closeModal(){ document.getElementById('adminModal').classList.remove('active'); }

    function toggleMobileMenu() {
      const menu = document.getElementById('mobile-menu');
      const burgerIcon = document.getElementById('burger-icon');
      const closeIcon = document.getElementById('close-icon');
      
      menu.classList.toggle('hidden');
      burgerIcon.classList.toggle('hidden');
      closeIcon.classList.toggle('hidden');
    }

    function closeMobileMenu() {
      const menu = document.getElementById('mobile-menu');
      const burgerIcon = document.getElementById('burger-icon');
      const closeIcon = document.getElementById('close-icon');
      
      menu.classList.add('hidden');
      burgerIcon.classList.remove('hidden');
      closeIcon.classList.add('hidden');
    }

    function switchTabMobile(tab) {
      switchTab(tab);
      closeMobileMenu();
      
      // Update mobile menu button states
      document.querySelectorAll('.mobile-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`mob-tab-${tab}`).classList.add('active');
    }

    function openSwotModal() {
      const m = document.getElementById('swotModal');
      m.classList.remove('hidden');
      m.classList.add('flex');
      autofillActionCodes(false);
    }

    function closeSwotModal(ev) {
      if (ev && ev.target && ev.target.id !== 'swotModal') return;
      const m = document.getElementById('swotModal');
      m.classList.add('hidden');
      m.classList.remove('flex');
    }

    function toggleNewDocButton(tab) {
      const btn = document.getElementById('btn-new-doc');
      if (!btn) return;
      if (tab === 'docs') btn.classList.remove('hidden');
      else btn.classList.add('hidden');
    }

    function switchTab(tab) {
      document.getElementById('view-docs').classList.add('hidden');
      document.getElementById('view-swot').classList.add('hidden');
      document.getElementById('view-ro').classList.add('hidden');
      document.getElementById('view-partes').classList.add('hidden');
      document.getElementById('view-org').classList.add('hidden');
      document.getElementById('view-planning').classList.add('hidden');
      document.getElementById('view-planning-meetings').classList.add('hidden');
      document.getElementById('view-planning-audits').classList.add('hidden');
      document.getElementById('view-pdca').classList.add('hidden');
      document.getElementById('tab-docs').classList.remove('active');
      document.getElementById('tab-swot').classList.remove('active');
      document.getElementById('tab-ro').classList.remove('active');
      document.getElementById('tab-partes').classList.remove('active');
      document.getElementById('tab-org').classList.remove('active');
      document.getElementById('tab-planning').classList.remove('active');
      document.getElementById('tab-pdca').classList.remove('active');

      toggleNewDocButton(tab);

      if(tab === 'docs') {
        document.getElementById('view-docs').classList.remove('hidden');
        document.getElementById('tab-docs').classList.add('active');
      } else if(tab === 'swot') {
        document.getElementById('view-swot').classList.remove('hidden');
        document.getElementById('tab-swot').classList.add('active');
        if(swotData.length === 0) fetchSwot();
      } else if(tab === 'ro') {
        document.getElementById('view-ro').classList.remove('hidden');
        document.getElementById('tab-ro').classList.add('active');
        if(roData.length === 0) fetchRo();
      } else if(tab === 'partes') {
        document.getElementById('view-partes').classList.remove('hidden');
        document.getElementById('tab-partes').classList.add('active');
        if(partesData.length === 0) fetchPartes();
      } else if(tab === 'org') {
        document.getElementById('view-org').classList.remove('hidden');
        document.getElementById('tab-org').classList.add('active');
      } else if(tab === 'planning') {
        document.getElementById('view-planning').classList.remove('hidden');
        document.getElementById('tab-planning').classList.add('active');
      } else if(tab === 'pdca') {
        document.getElementById('view-pdca').classList.remove('hidden');
        document.getElementById('tab-pdca').classList.add('active');
        if(pdcaData.length === 0) fetchPdca();
      }

      // Update mobile menu button states
      document.querySelectorAll('.mobile-tab-btn').forEach(btn => btn.classList.remove('active'));
      const mobileBtn = document.getElementById(`mob-tab-${tab}`);
      if (mobileBtn) mobileBtn.classList.add('active');
    }

    function switchPlanningView(view) {
      document.getElementById('view-planning').classList.add('hidden');
      document.getElementById('view-planning-meetings').classList.add('hidden');
      document.getElementById('view-planning-audits').classList.add('hidden');

      if(view === 'main') {
        document.getElementById('view-planning').classList.remove('hidden');
      } else if(view === 'meetings') {
        document.getElementById('view-planning-meetings').classList.remove('hidden');
        renderMeetingsTable();
      } else if(view === 'audits') {
        document.getElementById('view-planning-audits').classList.remove('hidden');
        renderAuditsTable();
      }
    }

    function renderMeetingsTable() {
      const tbody = document.getElementById('meetingsTableBody');
      let html = '';

      meetingsData.forEach(meeting => {
        html += '<tr class="border-b border-slate-200 hover:bg-blue-50/50 transition-colors">';
        html += `<td class="p-4 font-semibold text-slate-700 sticky left-0 bg-inherit">${meeting.title}</td>`;
        html += `<td class="p-3 text-center font-bold text-slate-600">${meeting.responsible}</td>`;

        for (let m = 1; m <= 12; m++) {
          const status = meeting.schedule[m] || null;
          const emoji = getStatusEmoji(status);
          html += `<td class="p-2 text-center cursor-pointer hover:bg-slate-100 transition-colors text-2xl" onclick="toggleMeetingStatus(${meeting.id}, ${m})" style="border: none;">${emoji}</td>`;
        }

        html += '</tr>';
      });

      tbody.innerHTML = html;
    }

    function renderAuditsTable() {
      const tbody = document.getElementById('auditsTableBody');
      let html = '';

      auditsData.forEach(audit => {
        const isExternal = audit.notes.includes('Externa');
        const bgColor = isExternal ? 'bg-blue-50' : 'bg-green-50';
        
        html += `<tr class="border-b border-slate-200 hover:${bgColor} transition-colors">`;
        html += `<td class="p-3 font-bold text-slate-700">${audit.month}</td>`;
        html += `<td class="p-3 text-slate-600">${audit.plannedDate || '-'}</td>`;
        html += `<td class="p-3 text-slate-600">${audit.time}</td>`;
        html += `<td class="p-3 text-slate-600">${audit.location}</td>`;
        html += `<td class="p-3 font-semibold text-slate-800">${audit.process}</td>`;
        html += `<td class="p-3 text-sm text-slate-600">${audit.auditor}</td>`;
        html += `<td class="p-3 text-sm text-slate-600">${audit.auditLocation}</td>`;
        html += `<td class="p-3"><input type="text" value="${audit.realizedDate}" placeholder="dd-mmm-yy" class="px-2 py-1 border border-slate-300 rounded text-sm w-full focus:border-amber-500 focus:ring-1 focus:ring-amber-200 outline-none" onchange="updateAuditDate(${audit.id}, this.value)"></td>`;
        html += `<td class="p-3 text-sm font-semibold text-slate-700">${audit.manager}</td>`;
        html += `<td class="p-3"><span class="text-xs px-2 py-1 rounded-full font-bold ${isExternal ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">${audit.notes}</span></td>`;
        html += '</tr>';
      });

      tbody.innerHTML = html;
    }

    function updateAuditDate(auditId, newDate) {
      const audit = auditsData.find(a => a.id === auditId);
      if (audit) {
        audit.realizedDate = newDate;
        saveAuditsData();
      }
    }

    function getStatusEmoji(status) {
      if (status === 'done') return '🟢';
      if (status === 'planned') return '🔵';
      if (status === 'failed') return '🔴';
      return '⭕';
    }

    function toggleMeetingStatus(meetingId, monthNum) {
      const meeting = meetingsData.find(m => m.id === meetingId);
      if (!meeting) return;

      const current = meeting.schedule[monthNum];
      let next;

      if (!current) next = 'planned';
      else if (current === 'planned') next = 'done';
      else if (current === 'done') next = 'failed';
      else next = null;

      if (next) {
        meeting.schedule[monthNum] = next;
      } else {
        delete meeting.schedule[monthNum];
      }

      saveMeetingsData();
      renderMeetingsTable();
    }

    function saveMeetingsData() {
      localStorage.setItem('meetingsData', JSON.stringify(meetingsData));
    }

    function saveAuditsData() {
      localStorage.setItem('auditsData', JSON.stringify(auditsData));
    }

    function loadMeetingsData() {
      const saved = localStorage.getItem('meetingsData');
      if (saved) {
        const savedData = JSON.parse(saved);
        meetingsData.forEach((meeting, idx) => {
          if (savedData[idx]) {
            meeting.schedule = savedData[idx].schedule;
          }
        });
      }
    }

    function loadAuditsData() {
      const saved = localStorage.getItem('auditsData');
      if (saved) {
        const savedData = JSON.parse(saved);
        auditsData.forEach((audit, idx) => {
          if (savedData[idx]) {
            audit.realizedDate = savedData[idx].realizedDate;
          }
        });
      }
    }

    // =========
    // Fetch JSONP
    // =========
    function fetchFromSheet() {
      const callbackName = `cb_${Date.now()}`;
      window[callbackName] = (data) => {
        allDocuments = data;
        renderDocs(data);
        delete window[callbackName];
      };
      const script = document.createElement('script');
      script.src = `${MAIN_APPS_SCRIPT_URL}?callback=${callbackName}&t=${Date.now()}`;
      script.onload = () => script.remove();
      script.onerror = () => {
        console.error('Erro a carregar documentos (script).');
        script.remove();
        delete window[callbackName];
      };
      document.body.appendChild(script);
    }

    function fetchSwot() {
      showLoading('A carregar análise SWOT...');
      document.getElementById('swot-forcas').innerHTML = '<div class="flex justify-center items-center gap-2 py-4"><div class="loading-spinner" style="width: 40px; height: 40px;"></div><span class="text-[10px] text-slate-400">A carregar...</span></div>';
      document.getElementById('swot-oportunidades').innerHTML = '<div class="flex justify-center items-center gap-2 py-4"><div class="loading-spinner" style="width: 40px; height: 40px;"></div><span class="text-[10px] text-slate-400">A carregar...</span></div>';
      document.getElementById('swot-fraquezas').innerHTML = '<div class="flex justify-center items-center gap-2 py-4"><div class="loading-spinner" style="width: 40px; height: 40px;"></div><span class="text-[10px] text-slate-400">A carregar...</span></div>';
      document.getElementById('swot-ameacas').innerHTML = '<div class="flex justify-center items-center gap-2 py-4"><div class="loading-spinner" style="width: 40px; height: 40px;"></div><span class="text-[10px] text-slate-400">A carregar...</span></div>';

      const callbackName = `cb_swot_${Date.now()}`;
      window[callbackName] = (data) => {
        if (data && data.ok === false) {
          const msg = `<p class="text-[10px] text-red-600 font-bold">Erro SWOT: ${escapeHtml(data.error || 'desconhecido')}</p>`;
          document.getElementById('swot-forcas').innerHTML = msg;
          document.getElementById('swot-oportunidades').innerHTML = msg;
          document.getElementById('swot-fraquezas').innerHTML = msg;
          document.getElementById('swot-ameacas').innerHTML = msg;
          hideLoading();
          delete window[callbackName];
          return;
        }

        swotData = Array.isArray(data) ? data : (data?.data || []);
        applySwotFilters();
        hideLoading();
        delete window[callbackName];
      };

      const script = document.createElement('script');
      script.src = `${SWOT_APPS_SCRIPT_URL}?sheet=SWOT&callback=${callbackName}&t=${Date.now()}`;
      script.onload = () => script.remove();
      script.onerror = () => {
        const msg = `<p class="text-[10px] text-red-600 font-bold">Erro a carregar o script SWOT.</p>`;
        document.getElementById('swot-forcas').innerHTML = msg;
        document.getElementById('swot-oportunidades').innerHTML = msg;
        document.getElementById('swot-fraquezas').innerHTML = msg;
        document.getElementById('swot-ameacas').innerHTML = msg;
        hideLoading();
        script.remove();
        delete window[callbackName];
      };
      document.body.appendChild(script);
    }

    function fetchRo() {
      showLoading('A carregar Riscos & Oportunidades...');
      document.getElementById('roTableBody').innerHTML = '<tr><td colspan="9" class="px-8 py-10 text-center"><div class="flex justify-center items-center gap-3"><div class="loading-spinner"></div><span class="text-slate-400 font-bold uppercase text-[10px]">A carregar dados R&O...</span></div></td></tr>';

      const callbackName = `cb_ro_${Date.now()}`;
      window[callbackName] = (data) => {
        if (data && data.ok === false) {
          const msg = `<tr><td colspan="9" class="px-8 py-10 text-center text-red-600 font-bold text-[10px]">Erro R&O: ${escapeHtml(data.error || 'desconhecido')}</td></tr>`;
          document.getElementById('roTableBody').innerHTML = msg;
          hideLoading();
          delete window[callbackName];
          return;
        }

        roData = Array.isArray(data) ? data : (data?.data || []);
        updateRoFilterButtons();
        applyRoFilters();
        hideLoading();
        delete window[callbackName];
      };

      const script = document.createElement('script');
      script.src = `${RO_APPS_SCRIPT_URL}?sheet=R%26O&callback=${callbackName}&t=${Date.now()}`;
      script.onload = () => script.remove();
      script.onerror = () => {
        const msg = `<tr><td colspan="9" class="px-8 py-10 text-center text-red-600 font-bold text-[10px]">Erro a carregar o script R&O.</td></tr>`;
        document.getElementById('roTableBody').innerHTML = msg;
        hideLoading();
        script.remove();
        delete window[callbackName];
      };
      document.body.appendChild(script);
    }

    function fetchPartes() {
      showLoading('A carregar Partes Interessadas...');
      document.getElementById('partesTableBody').innerHTML = '<tr><td colspan="9" class="px-8 py-10 text-center"><div class="flex justify-center items-center gap-3"><div class="loading-spinner"></div><span class="text-slate-400 font-bold uppercase text-[10px]">A carregar dados...</span></div></td></tr>';

      const callbackName = `cb_partes_${Date.now()}`;
      window[callbackName] = (data) => {
        if (data && data.ok === false) {
          const msg = `<tr><td colspan="9" class="px-8 py-10 text-center text-red-600 font-bold text-[10px]">Erro Partes Interessadas: ${escapeHtml(data.error || 'desconhecido')}</td></tr>`;
          document.getElementById('partesTableBody').innerHTML = msg;
          hideLoading();
          delete window[callbackName];
          return;
        }

        partesData = Array.isArray(data) ? data : (data?.data || []);
        applyPartesFilters();
        hideLoading();
        delete window[callbackName];
      };

      const script = document.createElement('script');
      script.src = `${PARTES_APPS_SCRIPT_URL}?sheet=Partes%20Interessadas&callback=${callbackName}&t=${Date.now()}`;
      script.onload = () => script.remove();
      script.onerror = () => {
        const msg = `<tr><td colspan="9" class="px-8 py-10 text-center text-red-600 font-bold text-[10px]">Erro a carregar o script Partes Interessadas.</td></tr>`;
        document.getElementById('partesTableBody').innerHTML = msg;
        hideLoading();
        script.remove();
        delete window[callbackName];
      };
      document.body.appendChild(script);
    }

    function fetchPdca() {
      showLoading('A carregar dados PDCA...');
      document.getElementById('pdcaTableBody').innerHTML = '<tr><td colspan="11" class="px-8 py-10 text-center"><div class="flex justify-center items-center gap-3"><div class="loading-spinner"></div><span class="text-slate-400 font-bold uppercase text-[10px]">A carregar dados PDCA...</span></div></td></tr>';

      const callbackName = `cb_pdca_${Date.now()}`;
      window[callbackName] = (data) => {
        if (data && data.ok === false) {
          const msg = `<tr><td colspan="11" class="px-8 py-10 text-center text-red-600 font-bold text-[10px]">Erro PDCA: ${escapeHtml(data.error || 'desconhecido')}</td></tr>`;
          document.getElementById('pdcaTableBody').innerHTML = msg;
          hideLoading();
          delete window[callbackName];
          return;
        }

        pdcaData = Array.isArray(data) ? data : (data?.data || []);
        buildPdcaFilters();
        renderPdca(pdcaData);
        hideLoading();
        delete window[callbackName];
      };

      const script = document.createElement('script');
      script.src = `${PDCA_APPS_SCRIPT_URL}?sheet=PDCA&callback=${callbackName}&t=${Date.now()}`;
      script.onload = () => script.remove();
      script.onerror = () => {
        const msg = `<tr><td colspan="11" class="px-8 py-10 text-center text-red-600 font-bold text-[10px]">Erro a carregar o script PDCA.</td></tr>`;
        document.getElementById('pdcaTableBody').innerHTML = msg;
        hideLoading();
        script.remove();
        delete window[callbackName];
      };
      document.body.appendChild(script);
    }

    function refreshPdcaData() {
      // Guardar os filtros e buscas atuais
      const savedFilters = JSON.parse(JSON.stringify(currentPdcaFilters));
      const savedOrigemSearch = document.getElementById('searchOrigemPdca').value;
      const savedResponsavelSearch = document.getElementById('searchResponsavelPdca').value;
      
      // Função custom para o callback
      const callbackName = `cb_pdca_refresh_${Date.now()}`;
      window[callbackName] = (data) => {
        if (data && data.ok === false) {
          const msg = `<tr><td colspan="11" class="px-8 py-10 text-center text-red-600 font-bold text-[10px]">Erro ao atualizar: ${escapeHtml(data.error || 'desconhecido')}</td></tr>`;
          document.getElementById('pdcaTableBody').innerHTML = msg;
          hideLoading();
          delete window[callbackName];
          return;
        }

        // Atualizar dados
        pdcaData = Array.isArray(data) ? data : (data?.data || []);
        
        // Restaurar filtros e buscas
        currentPdcaFilters = savedFilters;
        document.getElementById('searchOrigemPdca').value = savedOrigemSearch;
        document.getElementById('searchResponsavelPdca').value = savedResponsavelSearch;
        
        // Reconstruir tabela com dados atualizados e filtros preservados
        buildPdcaFilters();
        applyPdcaFilters();
        hideLoading();
        delete window[callbackName];
      };

      showLoading('A atualizar dados PDCA...');
      document.getElementById('pdcaTableBody').innerHTML = '<tr><td colspan="11" class="px-8 py-10 text-center"><div class="flex justify-center items-center gap-3"><div class="loading-spinner"></div><span class="text-slate-400 font-bold uppercase text-[10px]">A atualizar dados...</span></div></td></tr>';

      const script = document.createElement('script');
      script.src = `${PDCA_APPS_SCRIPT_URL}?sheet=PDCA&callback=${callbackName}&t=${Date.now()}`;
      script.onload = () => script.remove();
      script.onerror = () => {
        const msg = `<tr><td colspan="11" class="px-8 py-10 text-center text-red-600 font-bold text-[10px]">Erro a atualizar dados PDCA.</td></tr>`;
        document.getElementById('pdcaTableBody').innerHTML = msg;
        hideLoading();
        script.remove();
        delete window[callbackName];
      };
      document.body.appendChild(script);
    }

    // =========
    // Docs
    // =========
    function renderDocs(data) {
      const body = document.getElementById('docsTableBody');
      if (!data || data.length === 0) {
        body.innerHTML = '<tr><td colspan="5" class="px-8 py-10 text-center text-slate-400 font-bold uppercase text-[10px]">Sem resultados para a pesquisa</td></tr>';
        return;
      }

      body.innerHTML = data.map(doc => {
        const dataAtualizacao = getAny(doc, ['Data de Atualização', 'Data de atualizacao', 'data_atualizacao', 'Data Atualização']);
        const status = getAny(doc, ['Status', 'status', 'Estado', 'estado']);
        const docName = doc.name || doc.Designação || doc.designacao || doc.Nome || '-';
        const isMOD_DMN = docName.includes('MOD_DMN_11_01');
        const desigHtml = isMOD_DMN ? `${escapeHtml(docName)} <a href="https://multiwasher.github.io/fluorados/" target="_blank" class="text-emerald-600 hover:text-emerald-700 font-bold underline text-xs">📄 Fluorados</a>` : escapeHtml(docName);
        return `
        <tr class="hover:bg-slate-50/50 transition-colors group">
          <td class="px-8 py-5">
            <span class="type-badge ${getBadgeClass(doc.type)}">${escapeHtml(doc.type)}</span>
          </td>
          <td class="px-8 py-5">
            <p class="text-sm font-bold text-slate-700">${desigHtml}</p>
          </td>
          <td class="px-8 py-5">
            <span class="text-xs font-semibold text-slate-600 px-3 py-1 rounded-lg" style="background:${status.toLowerCase() === 'ativo' ? '#dcfce7' : '#fee2e2'}; color:${status.toLowerCase() === 'ativo' ? '#166534' : '#991b1b'}">${escapeHtml(status || '-')}</span>
          </td>
          <td class="px-8 py-5">
            <p class="text-sm text-slate-600">${formatDate(dataAtualizacao)}</p>
          </td>
          <td class="px-8 py-5 text-right">
            <a href="${doc.link}" target="_blank" class="inline-block bg-slate-100 hover:bg-emerald-600 hover:text-white text-slate-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all">Consultar</a>
          </td>
        </tr>
      `;
      }).join('');
      document.getElementById('stat-docs').innerText = data.length;
    }

    function setDocTypeFilter(type) {
      // Converter tipo para ID-safe (espaços para hífens)
      const idSafeType = type === 'TODOS' ? 'TODOS' : type.replace(/\s+/g, '-');
      const btn = document.getElementById(`filter-doctype-${idSafeType}`);
      if (!btn) return;

      if (type === 'TODOS') {
        // Se "TODOS" é clicado, limpar todos os filtros
        currentDocTypeFilters.clear();
        document.querySelectorAll('[id^="filter-doctype-"]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      } else {
        // Se "TODOS" está ativo, desativar primeiro
        const todosBtn = document.getElementById('filter-doctype-TODOS');
        if (todosBtn && todosBtn.classList.contains('active')) {
          todosBtn.classList.remove('active');
        }

        // Toggle do tipo específico
        if (currentDocTypeFilters.has(type)) {
          currentDocTypeFilters.delete(type);
          btn.classList.remove('active');
        } else {
          currentDocTypeFilters.add(type);
          btn.classList.add('active');
        }

        // Se não há filtros, reativar "TODOS"
        if (currentDocTypeFilters.size === 0) {
          todosBtn.classList.add('active');
        }
      }
      filterDocs();
    }

    function filterDocs() {
      const input = document.getElementById('searchDocs').value.toLowerCase().trim();
      const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
      
      let filtered = allDocuments;

      // ✅ Filtro por TIPO (multi-select)
      if (currentDocTypeFilters.size > 0) {
        filtered = filtered.filter(doc => {
          const docType = normalize(String(doc.type || ''));
          return Array.from(currentDocTypeFilters).some(selectedType => 
            docType.includes(normalize(selectedType))
          );
        });
      }

      // ✅ Filtro por pesquisa com sinónimos
      if (input) {
        const queryNormalized = normalize(input);
        const inputTerms = queryNormalized.split(/\s+/).filter(t => t.length > 0);

        const synonymGroups = [
          ["emergencia", "seguranca", "autoprotecao", "incendio", "evacuacao", "socorro", "protecao"],
          ["residuo", "lixo", "reciclagem", "ecoponto", "oleo", "quimico", "perigoso", "contaminacao"],
          ["energia", "eletrica", "consumo", "gas", "agua", "recurso", "eficiencia"],
          ["lei", "legislacao", "conformidade", "requisito", "legal", "norma", "iso", "regulamento", "decreto"],
          ["formacao", "treino", "sensibilizacao", "competencia", "capacitacao", "acolhimento", "apresentacao"],
          ["auditoria", "verificacao", "inspecao", "controlo", "monitorizacao", "interna", "planeamento", "plano"],
          ["indicadores", "estrategicos", "metricas", "desempenho", "kpi", "objetivos"],
          ["mapa", "mapeamento", "processos", "fluxo", "workflow", "swimlane", "responsabilidades", "funcoes"],
          ["comunicacao", "plano", "estrategia", "mensagem", "divulgacao"],
          ["matriz", "materialidade", "material", "stakeholders", "relevancia", "partes", "interessadas", "padroes"],
          ["locais", "fixos", "instalacoes", "facilities", "localizacao", "sedes"],
          ["danos", "ambientais", "ambiente", "impacto", "efeito", "aspetos", "ambiental"],
          ["revisao", "gestao", "management", "review", "avaliacao", "direuccao"],
          ["funil", "negocio", "vendas", "sales", "business", "oportunidade", "comercial"],
          ["seguro", "proteccao", "cobertura", "risco", "indemnizacao", "apolicе"],
          ["fichas", "seguranca", "ficha", "dados", "hsf", "sds", "folha"],
          ["naoconformidade", "desvio", "gemba", "incumprimento", "noncompliance", "achado"],
          ["calibracao", "aferição", "medicao", "verificacao", "manutencao", "preventiva"],
          ["monitorizacao", "monitoramento", "controlo", "observacao", "acompanhamento"],
          ["documental", "documentos", "registos", "arquivo", "documentacao"],
          ["comprovacao", "checklist", "lista", "prova", "evidencia", "verificacao"],
          ["recrutamento", "selecao", "seleccao", "candidatura", "pessoal", "colaborador", "recursos", "humanos", "dgr"],
          ["acolhimento", "integracao", "apresentacao", "onboarding", "boas-vindas"],
          ["aptidao", "medica", "saude", "ocupacional", "avaliacao", "rae", "relatorio"],
          ["protecao", "autoprotecao", "medidas", "proteccao", "seguranca", "bem-estar"],
          ["faltas", "presenca", "assiduidade", "ausencia", "justificacao", "controlo", "comparecimento"],
          ["manutencao", "equipamentos", "preventiva", "fabril", "corretiva", "manuais"],
          ["rae", "relatorio", "aptidao", "medica", "avaliacao", "ocupacional"],
          ["entradas", "saidas", "controlo", "acesso", "fluxo", "pessoas", "registos"],
          ["funcoes", "descricao", "responsabilidades", "cargo", "posicao", "atribuicoes"],
          ["fabricacao", "entregas", "mapa", "producao", "fabrica", "produzir"],
          ["ensaios", "eletricos", "teste", "testes", "validacao", "verificacao", "controlo"],
          ["embalagem", "packaging", "trolleys", "trolley", "acondicionamento", "embalado"],
          ["instrucao", "operatoria", "operacional", "operacao", "pernos", "parafusos", "procedimento"],
          ["recepcao", "materiais", "entrada", "fornecimento", "rececionado", "fornecedor", "compra"]
        ];

        let expandedTerms = [...inputTerms];
        inputTerms.forEach(term => {
          synonymGroups.forEach(group => {
            if (group.some(word => word.includes(term) || term.includes(word))) expandedTerms = [...expandedTerms, ...group];
          });
        });

        const uniqueSearchTerms = [...new Set(expandedTerms)];
        filtered = filtered.filter(doc => {
          const content = normalize(`${doc.name} ${doc.type}`);
          return uniqueSearchTerms.some(term => content.includes(term));
        });
      }

      renderDocs(filtered);
    }

    function getBadgeClass(type) {
      const t = String(type).toLowerCase();
      if (t.includes('procedimento')) return 'badge-procedimento';
      if (t.includes('instrucao operatoria')) return 'badge-instrucao-operatoria';
      if (t.includes('instrucao')) return 'badge-instrucao';
      if (t.includes('manual')) return 'badge-manual';
      if (t.includes('modelo')) return 'badge-modelo';
      if (t.includes('pasta')) return 'badge-pasta';
      return 'badge-default';
    }

    function getStatusClass(status) {
      const st = (status || '').toLowerCase().trim();
      if (st.includes('concluído') || st.includes('concluido')) return 'status-concluido';
      if (st.includes('aberto')) return 'status-aberto';
      if (st.includes('em curso')) return 'status-em-curso';
      if (st.includes('cancelado')) return 'status-cancelado';
      if (st === '-') return 'status-indefinido';
      return 'status-indefinido';
    }

    function getEficaciaClass(eficacia) {
      const ef = (eficacia || '').toLowerCase().trim();
      if (ef.includes('eficaz') && !ef.includes('não') && !ef.includes('nao')) return 'eficacia-eficaz';
      if (ef.includes('não eficaz') || ef.includes('nao eficaz')) return 'eficacia-nao-eficaz';
      if (ef === '-') return 'eficacia-indefinido';
      return 'eficacia-indefinido';
    }

    function renderPdca(data) {
      const body = document.getElementById('pdcaTableBody');
      if (!data || data.length === 0) {
        body.innerHTML = '<tr><td colspan="11" class="px-8 py-10 text-center text-slate-400 font-bold uppercase text-[10px]">Sem resultados para a pesquisa</td></tr>';
        return;
      }

      body.innerHTML = data.map(item => {
        const itemNum = getAny(item, ['Item', 'item', 'ITEM']) || '-';
        const dataRegisto = formatDate(getAny(item, ['Data de Registo', 'data de registo', 'DATA DE REGISTO'])) || '-';
        const ano = getAny(item, ['Ano', 'ano', 'ANO']) || '-';
        const origem = getAny(item, ['Origem da Ação', 'origem da acao', 'ORIGEM DA AÇÃO']) || '-';
        const processo = getAny(item, ['Processo', 'processo', 'PROCESSO']) || '-';
        const acao = getAny(item, ['Ação a ser Realizada', 'acao a ser realizada', 'AÇÃO A SER REALIZADA']) || '-';
        const responsavel = getAny(item, ['Responsável', 'responsavel', 'RESPONSÁVEL', 'Responsavel']) || '-';
        const prazo = formatDate(getAny(item, ['Prazo', 'prazo', 'PRAZO'])) || '-';
        const dataConclusao = formatDate(getAny(item, ['Data de Conclusão', 'data de conclusao', 'DATA DE CONCLUSÃO'])) || '-';
        const status = getAny(item, ['Status das Ações', 'status das acoes', 'STATUS DAS AÇÕES', 'Status', 'status', 'ESTADO']) || '-';
        const eficacia = getAny(item, ['Análise da Eficácia']) || '-';
        
        const statusClass = getStatusClass(status);
        const eficaciaClass = getEficaciaClass(eficacia);
        
        return `
        <tr class="hover:bg-slate-50/50 transition-colors group pdca-row" data-item-id="${escapeHtml(itemNum)}">
          <td class="px-4 py-3 text-xs font-semibold text-slate-700">${escapeHtml(itemNum)}</td>
          <td class="px-4 py-3 text-xs text-slate-600"><div contenteditable="true" class="pdca-edit-cell rounded hover:bg-slate-100 px-1 py-1 outline-none focus:ring-2 focus:ring-emerald-500/50" data-field="Data de Registo" data-original="${escapeHtml(dataRegisto)}">${escapeHtml(dataRegisto)}</div></td>
          <td class="px-4 py-3 text-xs font-semibold text-slate-700"><div contenteditable="true" class="pdca-edit-cell rounded hover:bg-slate-100 px-1 py-1 outline-none focus:ring-2 focus:ring-emerald-500/50" data-field="Ano" data-original="${escapeHtml(ano)}">${escapeHtml(ano)}</div></td>
          <td class="px-4 py-3 text-xs text-slate-600"><div contenteditable="true" class="pdca-edit-cell rounded hover:bg-slate-100 px-1 py-1 outline-none focus:ring-2 focus:ring-emerald-500/50" data-field="Origem da Ação" data-original="${escapeHtml(origem)}">${escapeHtml(origem)}</div></td>
          <td class="px-4 py-3 text-xs text-slate-600"><div contenteditable="true" class="pdca-edit-cell rounded hover:bg-slate-100 px-1 py-1 outline-none focus:ring-2 focus:ring-emerald-500/50" data-field="Processo" data-original="${escapeHtml(processo)}">${escapeHtml(processo)}</div></td>
          <td class="px-4 py-3 text-xs text-slate-600"><div contenteditable="true" class="pdca-edit-cell rounded hover:bg-slate-100 px-1 py-1 outline-none focus:ring-2 focus:ring-emerald-500/50" data-field="Ação a ser Realizada" data-original="${escapeHtml(acao)}">${escapeHtml(acao)}</div></td>
          <td class="px-4 py-3 text-xs text-slate-600"><div contenteditable="true" class="pdca-edit-cell rounded hover:bg-slate-100 px-1 py-1 outline-none focus:ring-2 focus:ring-emerald-500/50" data-field="Responsável" data-original="${escapeHtml(responsavel)}">${escapeHtml(responsavel)}</div></td>
          <td class="px-4 py-3 text-xs text-slate-600"><div contenteditable="true" class="pdca-edit-cell rounded hover:bg-slate-100 px-1 py-1 outline-none focus:ring-2 focus:ring-emerald-500/50" data-field="Prazo" data-original="${escapeHtml(prazo)}">${escapeHtml(prazo)}</div></td>
          <td class="px-4 py-3 text-xs text-slate-600"><div contenteditable="true" class="pdca-edit-cell rounded hover:bg-slate-100 px-1 py-1 outline-none focus:ring-2 focus:ring-emerald-500/50" data-field="Data de Conclusão" data-original="${escapeHtml(dataConclusao)}">${escapeHtml(dataConclusao)}</div></td>
          <td class="px-4 py-3"><select class="pdca-status-select rounded px-2 py-1 outline-none focus:ring-2 focus:ring-emerald-500/50 text-xs font-semibold border border-slate-300 ${statusClass}" data-field="Status das Ações" data-original="${escapeHtml(status)}">
            <option value="${escapeHtml(status)}" selected>${escapeHtml(status)}</option>
            <option value="Concluído">Concluído</option>
            <option value="Aberto">Aberto</option>
            <option value="Em curso">Em curso</option>
            <option value="-">-</option>
          </select></td>
          <td class="px-4 py-3"><select class="pdca-eficacia-select rounded px-2 py-1 outline-none focus:ring-2 focus:ring-emerald-500/50 text-xs font-semibold border border-slate-300 ${eficaciaClass}" data-field="Análise da Eficácia" data-original="${escapeHtml(eficacia)}">
            <option value="${escapeHtml(eficacia)}" selected>${escapeHtml(eficacia)}</option>
            <option value="Eficaz">Eficaz</option>
            <option value="Não Eficaz">Não Eficaz</option>
            <option value="-">-</option>
          </select></td>
        </tr>
      `;
        
      }).join('');
      
      // Adiciona event listeners após renderizar
      attachPdcaEditListeners();
    }

    function attachPdcaEditListeners() {
      const editableCells = document.querySelectorAll('.pdca-edit-cell');
      
      editableCells.forEach(cell => {
        cell.addEventListener('blur', function() {
          const newValue = this.textContent.trim();
          const original = this.getAttribute('data-original');
          const field = this.getAttribute('data-field');
          const row = this.closest('.pdca-row');
          const itemId = row.getAttribute('data-item-id');
          
          // Se mudou, marca como editado e salva
          if (newValue !== original) {
            this.classList.add('ring-2', 'ring-yellow-400');
            savePdcaCell(itemId, field, newValue);
          }
        });
        
        // Prevenir quebra de linhas
        cell.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            this.blur();
          }
        });
        
        // Adiciona visual feedback durante edição
        cell.addEventListener('focus', function() {
          this.classList.add('bg-emerald-50');
        });
      });
      
      // Event listeners para Status select dropdowns
      const statusSelects = document.querySelectorAll('.pdca-status-select');
      statusSelects.forEach(select => {
        select.addEventListener('change', function() {
          const newValue = this.value;
          const original = this.getAttribute('data-original');
          const field = this.getAttribute('data-field');
          const row = this.closest('.pdca-row');
          const itemId = row.getAttribute('data-item-id');
          
          // Atualizar classe visual baseado no novo status
          const newStatusClass = getStatusClass(newValue);
          
          // Remover todas as classes de status
          this.classList.remove('status-concluido', 'status-aberto', 'status-em-curso', 'status-indefinido', 'status-cancelado');
          
          // Adicionar nova classe de status
          if (newStatusClass) {
            this.classList.add(newStatusClass);
          }
          
          // Se mudou, salva
          if (newValue !== original) {
            this.classList.add('ring-2', 'ring-yellow-400');
            savePdcaCell(itemId, field, newValue);
          }
        });
      });

      // Event listeners para Eficácia select dropdowns
      const eficaciaSelects = document.querySelectorAll('.pdca-eficacia-select');
      eficaciaSelects.forEach(select => {
        select.addEventListener('change', function() {
          const newValue = this.value;
          const original = this.getAttribute('data-original');
          const field = this.getAttribute('data-field');
          const row = this.closest('.pdca-row');
          const itemId = row.getAttribute('data-item-id');
          
          // Atualizar classe visual baseado na nova eficácia
          const newEficaciaClass = getEficaciaClass(newValue);
          
          // Remover todas as classes de eficácia
          this.classList.remove('eficacia-eficaz', 'eficacia-nao-eficaz', 'eficacia-indefinido');
          
          // Adicionar nova classe de eficácia
          if (newEficaciaClass) {
            this.classList.add(newEficaciaClass);
          }
          
          // Se mudou, salva
          if (newValue !== original) {
            this.classList.add('ring-2', 'ring-yellow-400');
            savePdcaCell(itemId, field, newValue);
          }
        });
      });
    }

    function savePdcaCell(itemId, fieldName, newValue) {
      // Validação para o campo Status das Ações
      const ALLOWED_STATUS_VALUES = ['Concluído', 'Aberto', 'Em curso', '-'];
      if (fieldName === 'Status das Ações' && !ALLOWED_STATUS_VALUES.includes(newValue)) {
        showError(`Valor inválido para Status. Valores permitidos: ${ALLOWED_STATUS_VALUES.join(', ')}`);
        return;
      }

      // Validação para o campo Análise da Eficácia
      const ALLOWED_EFICACIA_VALUES = ['Eficaz', 'Não Eficaz', '-'];
      if (fieldName === 'Análise da Eficácia' && !ALLOWED_EFICACIA_VALUES.includes(newValue)) {
        showError(`Valor inválido para Eficácia. Valores permitidos: ${ALLOWED_EFICACIA_VALUES.join(', ')}`);
        return;
      }
      
      showLoading('A guardar alteração...');
      
      console.log('Enviando para PDCA:', { Item: itemId, [fieldName]: newValue });
      
      // Usar FormData para contornar CORS (não dispara preflight)
      const formData = new FormData();
      formData.append('Item', itemId);
      formData.append(fieldName, newValue);
      
      fetch(PDCA_APPS_SCRIPT_URL, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        console.log('Status:', response.status);
        // Tenta ler como JSON, se falhar, retorna texto
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          return response.json();
        }
        return response.text().then(text => {
          try {
            return JSON.parse(text);
          } catch (e) {
            return { ok: true, message: text };
          }
        });
      })
      .then(result => {
        console.log('Resposta PDCA:', result);
        hideLoading();
        if (result.ok || result.action) {
          // Feedback visual de sucesso
          const cells = document.querySelectorAll(`[data-item-id="${itemId}"] [data-field="${fieldName}"]`);
          if (cells.length > 0) {
            setTimeout(() => {
              const row = cells[0].closest('.pdca-row');
              if (row) {
                row.classList.add('ring-2', 'ring-green-400');
                setTimeout(() => {
                  row.classList.remove('ring-2', 'ring-green-400');
                }, 1000);
              }
            }, 300);
          }
          
          // Atualiza o data-original para o novo valor
          document.querySelectorAll(`[data-item-id="${itemId}"] [data-field="${fieldName}"]`).forEach(el => {
            el.setAttribute('data-original', newValue);
          });
        } else {
          console.error('Erro ao guardar:', result.error || result);
        }
      })
      .catch(error => {
        console.error('Erro na requisição:', error);
        hideLoading();
      });
    }

    function buildPdcaFilters() {
      // Recolher valores únicos para cada filtro
      const valores = {
        ano: new Set(),
        processo: new Set(),
        status: new Set(),
        eficacia: new Set()
      };

      pdcaData.forEach(item => {
        const ano = getAny(item, ['Ano', 'ano', 'ANO']) || '';
        const processo = getAny(item, ['Processo', 'processo', 'PROCESSO']) || '';
        const status = getAny(item, ['Status das Ações', 'status das acoes', 'STATUS DAS AÇÕES', 'Status', 'status', 'ESTADO']) || '';
        const eficacia = getAny(item, ['Análise da Eficácia']) || '';

        if (ano) valores.ano.add(String(ano).trim());
        if (processo) valores.processo.add(String(processo).trim());
        if (status) valores.status.add(String(status).trim());
        if (eficacia) valores.eficacia.add(String(eficacia).trim());
      });

      // Criar botões para ANO
      const anoContainer = document.getElementById('pdca-ano-filters');
      if (anoContainer) {
        const anoSorted = Array.from(valores.ano).sort();
        anoContainer.innerHTML = anoSorted.map(val => `
          <button onclick="setPdcaFilter('ano', '${escapeHtml(val)}')" 
                  id="filter-pdca-ano-${escapeHtml(val).replace(/\s+/g, '_')}" 
                  class="pdca-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 text-[10px]">${escapeHtml(val)}</button>
        `).join('');
      }

      // Criar botões para PROCESSO
      const processoContainer = document.getElementById('pdca-processo-filters');
      if (processoContainer) {
        const processoSorted = Array.from(valores.processo).sort();
        processoContainer.innerHTML = processoSorted.map(val => `
          <button onclick="setPdcaFilter('processo', '${escapeHtml(val)}')"
                  id="filter-pdca-processo-${escapeHtml(val).replace(/\s+/g, '_')}"
                  class="pdca-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 text-[10px]">${escapeHtml(val)}</button>
        `).join('');
      }

      // Criar botões para STATUS
      const statusContainer = document.getElementById('pdca-status-filters');
      if (statusContainer) {
        const statusSorted = Array.from(valores.status).sort();
        statusContainer.innerHTML = statusSorted.map(val => `
          <button onclick="setPdcaFilter('status', '${escapeHtml(val)}')" 
                  id="filter-pdca-status-${escapeHtml(val).replace(/\s+/g, '_')}" 
                  class="pdca-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 text-[10px]">${escapeHtml(val)}</button>
        `).join('');
      }

      // Criar botões para EFICÁCIA
      const eficaciaContainer = document.getElementById('pdca-eficacia-filters');
      if (eficaciaContainer) {
        const eficaciaSorted = Array.from(valores.eficacia).sort();
        eficaciaContainer.innerHTML = eficaciaSorted.map(val => `
          <button onclick="setPdcaFilter('eficacia', '${escapeHtml(val)}')" 
                  id="filter-pdca-eficacia-${escapeHtml(val).replace(/\s+/g, '_')}" 
                  class="pdca-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 text-[10px]">${escapeHtml(val)}</button>
        `).join('');
      }
    }

    function setPdcaFilter(category, value) {
      // Multi-select com toggle para todos os filtros
      if (value === 'TODOS') {
        // Reset do filtro - limpar array
        currentPdcaFilters[category] = [];
        // Remover 'active' de todos exceto TODOS
        document.querySelectorAll(`[id^="filter-pdca-${category}-"]`).forEach(b => b.classList.remove('active'));
        document.getElementById(`filter-pdca-${category}-TODOS`).classList.add('active');
      } else {
        // Toggle do item específico
        const index = currentPdcaFilters[category].indexOf(value);
        
        if (index > -1) {
          // Já está selecionado, remover
          currentPdcaFilters[category].splice(index, 1);
        } else {
          // Não está selecionado, adicionar
          currentPdcaFilters[category].push(value);
        }
        
        // Remover 'active' do botão TODOS quando há filtros específicos
        const todosBtn = document.getElementById(`filter-pdca-${category}-TODOS`);
        if (currentPdcaFilters[category].length > 0) {
          if (todosBtn) todosBtn.classList.remove('active');
        }
        
        // Atualizar visual do botão específico
        const btnId = `filter-pdca-${category}-${value.replace(/\s+/g, '_')}`;
        const btn = document.getElementById(btnId);
        if (btn) btn.classList.toggle('active');
      }

      applyPdcaFilters();
    }

    function filterPdcaBySearch(field) {
      applyPdcaFilters();
    }

    function clearPdcaSearch(field) {
      if (field === 'origem') {
        document.getElementById('searchOrigemPdca').value = '';
      } else if (field === 'responsavel') {
        document.getElementById('searchResponsavelPdca').value = '';
      }
      applyPdcaFilters();
    }

    function updatePdcaFilterButtonStates() {
      const categories = ['ano', 'processo', 'status', 'eficacia'];
      
      categories.forEach(category => {
        // Atualizar estado do botão TODOS
        const todosBtn = document.getElementById(`filter-pdca-${category}-TODOS`);
        if (currentPdcaFilters[category].length === 0) {
          if (todosBtn) todosBtn.classList.add('active');
        } else {
          if (todosBtn) todosBtn.classList.remove('active');
        }
        
        // Atualizar estado dos botões de opções
        document.querySelectorAll(`[id^="filter-pdca-${category}-"]`).forEach(btn => {
          if (btn.id === `filter-pdca-${category}-TODOS`) return; // Pular TODOS
          
          const valueMatch = btn.id.match(new RegExp(`filter-pdca-${category}-(.+)`));
          if (valueMatch) {
            const value = valueMatch[1].replace(/_/g, ' ');
            if (currentPdcaFilters[category].includes(value)) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          }
        });
      });
    }

    function normalizeText(text) {
      return String(text || '').toLowerCase().trim().replace(/[àáâãäå]/g, 'a').replace(/[èéêë]/g, 'e').replace(/[ìíîï]/g, 'i').replace(/[òóôõö]/g, 'o').replace(/[ùúûü]/g, 'u').replace(/ç/g, 'c');
    }

    function applyPdcaFilters() {
      let filtered = [...pdcaData];

      // Filtro por ANO (cumulativo)
      const anoFilter = currentPdcaFilters['ano'];
      if (anoFilter && anoFilter.length > 0) {
        filtered = filtered.filter(item => {
          const ano = getAny(item, ['Ano', 'ano', 'ANO']) || '';
          return anoFilter.includes(String(ano).trim());
        });
      }

      // Filtro por ORIGEM (busca sensível a variações)
      const origemSearch = document.getElementById('searchOrigemPdca').value.trim();
      if (origemSearch) {
        const origemNorm = normalizeText(origemSearch);
        filtered = filtered.filter(item => {
          const origem = getAny(item, ['Origem da Ação', 'origem da acao', 'ORIGEM DA AÇÃO']) || '';
          return normalizeText(origem).includes(origemNorm);
        });
      }

      // Filtro por PROCESSO (cumulativo, case-insensitive)
      const processoFilter = currentPdcaFilters['processo'];
      if (processoFilter && processoFilter.length > 0) {
        filtered = filtered.filter(item => {
          const processo = getAny(item, ['Processo', 'processo', 'PROCESSO']) || '';
          const processoNorm = normalizeText(processo);
          const filterNorm = processoFilter.map(f => normalizeText(f));
          return filterNorm.some(fn => fn === processoNorm);
        });
      }

      // Filtro por RESPONSÁVEL (busca sensível a variações)
      const responsavelSearch = document.getElementById('searchResponsavelPdca').value.trim();
      if (responsavelSearch) {
        const responsavelNorm = normalizeText(responsavelSearch);
        filtered = filtered.filter(item => {
          const responsavel = getAny(item, ['Responsável', 'responsavel', 'RESPONSÁVEL', 'Responsavel']) || '';
          return normalizeText(responsavel).includes(responsavelNorm);
        });
      }

      // Filtro por STATUS (cumulativo)
      const statusFilter = currentPdcaFilters['status'];
      if (statusFilter && statusFilter.length > 0) {
        filtered = filtered.filter(item => {
          const status = getAny(item, ['Status das Ações', 'status das acoes', 'STATUS DAS AÇÕES', 'Status', 'status', 'ESTADO']) || '';
          return statusFilter.includes(String(status).trim());
        });
      }

      // Filtro por EFICÁCIA (cumulativo)
      const eficaciaFilter = currentPdcaFilters['eficacia'];
      if (eficaciaFilter && eficaciaFilter.length > 0) {
        filtered = filtered.filter(item => {
          const eficacia = getAny(item, ['Análise da Eficácia']) || '';
          return eficaciaFilter.includes(String(eficacia).trim());
        });
      }

      updatePdcaFilterButtonStates();
      renderPdca(filtered);
    }

    // =========
    // Filtros SWOT
    // =========
    function setActiveFilter(val) {
      currentSwotActiveFilter = val;
      document.querySelectorAll('[id^="filter-active-"]').forEach(btn => btn.classList.remove('active'));
      const el = document.getElementById(`filter-active-${val}`);
      if (el) el.classList.add('active');
      applySwotFilters();
    }

    function setPlanFilter(val) {
      currentSwotPlanFilter = val;
      document.querySelectorAll('[id^="filter-plan-"]').forEach(btn => btn.classList.remove('active'));
      const el = document.getElementById(`filter-plan-${val}`);
      if (el) el.classList.add('active');
      applySwotFilters();
    }

    function setSwotFilter(cat) {
      currentSwotFilterCategory = cat;
      document.querySelectorAll('[id^="filter-swot-"]').forEach(btn => btn.classList.remove('active'));
      const el = document.getElementById(`filter-swot-${cat}`);
      if (el) el.classList.add('active');
      applySwotFilters();
    }

    function setQuadrantFilter(quad) {
      currentSwotFilterQuadrant = quad;
      document.querySelectorAll('[id^="filter-quad-"]').forEach(btn => btn.classList.remove('active'));
      const el = document.getElementById(`filter-quad-${quad}`);
      if (el) el.classList.add('active');

      const quadrants = ['FORÇAS', 'OPORTUNIDADES', 'FRAQUEZAS', 'AMEAÇAS'];
      quadrants.forEach(q => {
        const col = document.getElementById(`quadrant-${q}`);
        if(currentSwotFilterQuadrant === 'TODOS' || currentSwotFilterQuadrant === q) col.style.display = 'block';
        else col.style.display = 'none';
      });

      applySwotFilters();
    }

    function resolveQuadrant(swotRaw) {
      const s = String(swotRaw || '')
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toUpperCase().trim();

      if (s.includes('STRENGTHS') || s.includes('FORCAS') || s.includes('FORÇAS')) return 'FORÇAS';
      if (s.includes('OPPORTUNITIES') || s.includes('OPORTUNIDADES')) return 'OPORTUNIDADES';
      if (s.includes('WEAKNESSES') || s.includes('FRAQUEZAS')) return 'FRAQUEZAS';
      if (s.includes('THREATS') || s.includes('AMEACAS') || s.includes('AMEAÇAS')) return 'AMEAÇAS';
      return '';
    }

    function applySwotFilters() {
      const searchTerm = normLoose(document.getElementById('searchSwot')?.value || '');

      const filtered = (swotData || []).filter(item => {
        const swotRaw = getAny(item, ['SWOT','Swot']);
        const codigo  = getAny(item, ['código','Código','ID','id','codigo']);
        const descricao = getAny(item, ['Descrição','Descricao','DESC','desc']);
        const tomada = getTomadaAcao(item);

        const quadrant = resolveQuadrant(swotRaw);

        const blob = buildSwotBlob(item);
        const blobNorm = normLoose(blob);

        const catInfo = getSwotCategory(blob);

        const matchesTheme =
          currentSwotFilterCategory === 'TODOS' ||
          normLoose(catInfo.key) === normLoose(currentSwotFilterCategory);

        const matchesQuadrant =
          currentSwotFilterQuadrant === 'TODOS' ||
          quadrant === currentSwotFilterQuadrant;

        const ativo = isAtivoFromTomada(tomada);
        const matchesActive =
          currentSwotActiveFilter === 'TODOS' ||
          (currentSwotActiveFilter === 'ATIVOS' && ativo) ||
          (currentSwotActiveFilter === 'NAO_ATIVOS' && !ativo);

        // ✅ Plano de Ação? (nível da ação): verifica se há ações que correspondem ao filtro
        const planoMap = buildPlanoMap(item);
        let hasActionMatchingFilter = false;

        for (let i = 1; i <= 6; i++) {
          const acaoTxt = getAny(item, [`AÇÃO ${i}`, `ACAO ${i}`, `Ação ${i}`, `Acao ${i}`]);
          const acaoCod = getAny(item, [
            `CÓDIGO_AÇÃO ${i}`, `CODIGO_ACAO ${i}`, `CÓDIGO AÇÃO ${i}`, `CODIGO ACAO ${i}`,
            `CODIGO_AÇÃO ${i}`, `CÓDIGO_ACAO ${i}`
          ]);

          const temAcao = (acaoTxt && String(acaoTxt).trim()) || (acaoCod && String(acaoCod).trim());
          if (!temAcao) continue;

          const plano = planoMap[i] ?? '';
          const isPlanoS = isYes(plano);

          // Verificar se esta ação corresponde ao filtro
          if (currentSwotPlanFilter === 'TODOS' ||
              (currentSwotPlanFilter === 'S' && isPlanoS) ||
              (currentSwotPlanFilter === 'N' && !isPlanoS)) {
            hasActionMatchingFilter = true;
            break;
          }
        }

        const matchesPlan = currentSwotPlanFilter === 'TODOS' || hasActionMatchingFilter;

        const matchesSearch =
          !searchTerm || blobNorm.includes(searchTerm) || normLoose(`${swotRaw} ${codigo} ${descricao}`).includes(searchTerm);

        return matchesTheme && matchesQuadrant && matchesActive && matchesPlan && matchesSearch;
      });

      renderSwot(filtered);
    }

    function toggleSwotPlan(cardId) {
      const card = document.getElementById(cardId);
      const planSection = card.querySelector('.swot-plan-section');
      const button = card.querySelector('.swot-plan-toggle-btn');
      
      const isHidden = planSection.style.maxHeight === '0px' || !planSection.style.maxHeight;
      
      if (isHidden) {
        planSection.style.maxHeight = planSection.scrollHeight + 'px';
        planSection.style.opacity = '1';
        button.classList.add('expanded');
        button.innerHTML = '▼ Plano Estratégico';
      } else {
        planSection.style.maxHeight = '0px';
        planSection.style.opacity = '0';
        button.classList.remove('expanded');
        button.innerHTML = '▶ Plano Estratégico';
      }
    }

    function renderSwot(data) {
      const categories = {
        forcas: document.getElementById('swot-forcas'),
        oportunidades: document.getElementById('swot-oportunidades'),
        fraquezas: document.getElementById('swot-fraquezas'),
        ameacas: document.getElementById('swot-ameacas')
      };

      Object.values(categories).forEach(el => el.innerHTML = '');

      if (!data || !Array.isArray(data) || data.length === 0) {
        Object.values(categories).forEach(el => el.innerHTML = '<p class="text-[10px] text-slate-400 font-medium italic py-4">Nenhum registo identificado.</p>');
        return;
      }

      let cardCounter = 0;

      data.forEach(item => {
        const swotRaw = getAny(item, ['SWOT','Swot']);
        const quadrant = resolveQuadrant(swotRaw);

        let target = null;
        let borderClass = 'border-slate-200';
        if (quadrant === 'FORÇAS') { target = categories.forcas; borderClass = 'swot-f'; }
        else if (quadrant === 'OPORTUNIDADES') { target = categories.oportunidades; borderClass = 'swot-o'; }
        else if (quadrant === 'FRAQUEZAS') { target = categories.fraquezas; borderClass = 'swot-f-ext'; }
        else if (quadrant === 'AMEAÇAS') { target = categories.ameacas; borderClass = 'swot-a'; }
        if(!target) return;

        const description = getAny(item, ['Descrição','Descricao','DESC','desc']);
        const codigo = getAny(item, ['código','Código','ID','id','codigo']);

        const tomada = getTomadaAcao(item);
        const ativo = isAtivoFromTomada(tomada);

        const planoMap = buildPlanoMap(item);

        let actionsHtml = '';
        let hasAnyActions = false;
        
        for (let i = 1; i <= 6; i++) {
          let cod = getAny(item, [
            `CÓDIGO_AÇÃO ${i}`, `CODIGO_ACAO ${i}`, `CÓDIGO AÇÃO ${i}`, `CODIGO ACAO ${i}`,
            `CODIGO_AÇÃO ${i}`, `CÓDIGO_ACAO ${i}`
          ]);
          const acao = getAny(item, [`AÇÃO ${i}`, `ACAO ${i}`, `Ação ${i}`, `Acao ${i}`]);

          const emPlano = planoMap[i] ?? '';
          const badgePlano = planoBadgeHtml(emPlano);

          if ((!cod || !String(cod).trim()) && (acao && String(acao).trim()) && codigo) {
            cod = deriveActionCode(codigo, i);
          }

          const hasSomething = (acao && String(acao).trim()) || (cod && String(cod).trim());
          if (!hasSomething) continue;

          // ✅ Aplicar o filtro "Plano de Ação?" ao nível de cada ação
          const isPlanoS = isYes(emPlano);
          const shouldShowAction = currentSwotPlanFilter === 'TODOS' ||
                                   (currentSwotPlanFilter === 'S' && isPlanoS) ||
                                   (currentSwotPlanFilter === 'N' && !isPlanoS);

          if (!shouldShowAction) continue;

          hasAnyActions = true;

          actionsHtml += `
            <div class="mt-3 p-3 bg-slate-50 rounded-lg border border-slate-100">
              <div class="flex items-center justify-between gap-2 mb-2">
                <p class="text-[10px] font-black text-slate-600 uppercase tracking-tighter">Ação ${i} (${escapeHtml(cod || '')})</p>
                ${badgePlano}
              </div>
              ${acao && String(acao).trim() !== ''
                ? `<p class="text-xs text-slate-600 font-medium leading-relaxed">${escapeHtml(acao)}</p>`
                : `<p class="text-[10px] text-slate-400 italic">Sem descrição da ação.</p>`
              }
            </div>
          `;
        }

        const catInfo = getSwotCategory(buildSwotBlob(item));
        const tagClass = getSwotTagClass(catInfo.key);
        const cardId = `swot-card-${quadrant}-${cardCounter++}`;

        const card = `
          <div id="${cardId}" class="glass-card p-5 ${borderClass}">
            <div class="flex justify-between items-center mb-3">
              <div class="swot-cat-badge ${tagClass}">
                ${catInfo.icon}
                <span>${escapeHtml(catInfo.key)}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 rounded-full text-[8px] font-black ${ativo ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'} uppercase">
                  ${ativo ? 'Ativo' : 'Não ativo'}
                </span>
                <span class="text-[9px] font-bold text-slate-300 tracking-widest">#${escapeHtml(codigo)}</span>
              </div>
            </div>
            <h4 class="text-[13px] font-bold text-slate-800 leading-snug mb-3">${escapeHtml(description)}</h4>
            ${hasAnyActions ? `
              <button onclick="toggleSwotPlan('${cardId}')" class="swot-plan-toggle-btn w-full mt-3 pt-3 border-t border-slate-100 text-left text-[10px] font-black text-emerald-600 hover:text-emerald-700 uppercase tracking-widest transition-colors">▶ Plano Estratégico</button>
              <div class="swot-plan-section" style="max-height: 0px; overflow: hidden; opacity: 0; transition: max-height 0.3s ease, opacity 0.3s ease;">
                <div class="mt-3 space-y-3">
                  ${actionsHtml}
                </div>
              </div>
            ` : ''}
          </div>
        `;
        target.innerHTML += card;
      });

      Object.values(categories).forEach(el => {
        if(el.innerHTML === '') {
          el.innerHTML = '<p class="text-[10px] text-slate-400 font-medium italic py-4">Nenhum registo identificado com estes filtros.</p>';
        }
      });
    }

    // =========
    // Write SWOT
    // =========
    function buildSwotActionsPayload() {
      const mainCode = cleanMainCode(document.getElementById('swotCodigo')?.value || '');
      const acoes = [];

      for (let i = 1; i <= 6; i++) {
        let codigo = (document.getElementById(`acaoCod${i}`)?.value || '').trim();
        const acao = (document.getElementById(`acaoTxt${i}`)?.value || '').trim();

        if (acao && !codigo && mainCode) codigo = deriveActionCode(mainCode, i);

        if (codigo || acao) acoes.push({ codigo, acao });
      }
      return acoes;
    }

    async function addSwotToSheet(e) {
      e.preventDefault();

      const swotType = document.getElementById('swotType').value;
      const codigo = cleanMainCode(document.getElementById('swotCodigo').value);

      if (!validateMainCodeAgainstType(swotType, codigo)) {
        const expected = expectedPrefixFromSwotType(swotType);
        alert(`Código inválido para o tipo selecionado.\n\nPara "${swotType}", o código deve começar por "${expected}" (ex: ${expected}1).`);
        return;
      }

      autofillActionCodes(false);

      const btn = document.getElementById('btnAddSwot');
      btn.disabled = true;
      const oldText = btn.innerText;
      btn.innerText = 'A GRAVAR...';

      const payload = {
        swot: swotType,
        codigo: codigo,
        descricao: document.getElementById('swotDescricao').value.trim(),
        tomadaAcao: document.getElementById('swotTomada').value,
        acoes: buildSwotActionsPayload()
      };

      try {
        const res = await fetch(SWOT_WRITE_APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        });

        const out = await res.json();
        if (!out || out.ok !== true) {
          alert(`Erro ao gravar SWOT: ${(out && out.error) ? out.error : 'desconhecido'}`);
          return;
        }

        document.getElementById('addSwotForm').reset();
        closeSwotModal();
        fetchSwot();
      } catch (err) {
        alert('Erro na comunicação com a base de dados SWOT.');
      } finally {
        btn.disabled = false;
        btn.innerText = oldText;
      }
    }

    function showLoading(message = 'A carregar...') {
      const overlay = document.getElementById('globalLoadingOverlay');
      const text = document.getElementById('loadingText');
      text.innerText = message;
      overlay.classList.add('show');
    }

    function hideLoading() {
      const overlay = document.getElementById('globalLoadingOverlay');
      overlay.classList.remove('show');
    }

    function escapeHtml(str) {
      if(!str) return "";
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));
    }

    function formatDate(dateString) {
      if (!dateString || String(dateString).trim() === '') return '-';
      try {
        // Trata formatos: YYYY-MM-DD, DD/MM/YYYY, DD-MM-YYYY, ou ISO
        let date;
        const str = String(dateString).trim();
        
        // Se já está em DD/MM/YYYY, retorna como está
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return str;
        
        // Trata YYYY-MM-DD (ISO)
        if (/^\d{4}-\d{2}-\d{2}/.test(str)) {
          date = new Date(str);
        }
        // Trata DD/MM/YYYY ou DD-MM-YYYY
        else if (/^\d{2}[/-]\d{2}[/-]\d{4}$/.test(str)) {
          const parts = str.split(/[/-]/);
          date = new Date(parts[2], parts[1] - 1, parts[0]);
        }
        else {
          date = new Date(str);
        }
        
        if (isNaN(date.getTime())) return String(dateString);
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return String(dateString);
      }
    }

    // =========
    // R&O - Riscos e Oportunidades
    // =========
    
    // Mapa de sinónimos e termos associados para busca semântica
    const RO_SEARCH_SYNONYMS = {
      // Ambiental
      'ambi': ['ambi', 'ambiente', 'ambiental', 'ambientes', 'esg', 'verde', 'sustentabilidade', 'sustentavel', 'ecologia', 'ecologico'],
      'ambiente': ['ambi', 'ambiente', 'ambiental', 'ambientes', 'esg', 'verde', 'sustentabilidade', 'sustentavel', 'ecologia', 'ecologico'],
      'esg': ['esg', 'ambiental', 'ambiente', 'sustentabilidade', 'verde', 'responsabilidade', 'governa'],
      
      // Energia
      'energia': ['energia', 'eletric', 'consumo', 'recurso', 'eficiencia', 'gas', 'combustivel'],
      'eletric': ['energia', 'eletric', 'consumo', 'recurso'],
      'consumo': ['consumo', 'energia', 'recurso', 'eficiencia'],
      
      // Água
      'agua': ['agua', 'hidric', 'recurso', 'consumo', 'desperdicio', 'contaminacao'],
      'hidric': ['agua', 'hidric', 'recurso', 'contaminacao'],
      
      // Resíduos
      'residuo': ['residuo', 'lixo', 'reciclagem', 'ecoponto', 'oleo', 'lixivado', 'aterro'],
      'lixo': ['residuo', 'lixo', 'reciclagem', 'ecoponto', 'desperdicio'],
      'reciclagem': ['reciclagem', 'residuo', 'reutilizacao', 'valorizacao'],
      'quimico': ['quimico', 'substancia', 'perigoso', 'toxico', 'contaminacao'],
      
      // Emissões
      'emissao': ['emissao', 'carbono', 'co2', 'gases', 'poluicao', 'atmosfera'],
      'carbono': ['carbono', 'co2', 'emissao', 'clima', 'aquecimento'],
      'poluicao': ['poluicao', 'emissao', 'contaminacao', 'atmosfera'],
      
      // Legal/Conformidade
      'lei': ['lei', 'legislacao', 'conformidade', 'requisito', 'legal', 'norma', 'iso', 'regulamento', 'decreto'],
      'legal': ['legal', 'lei', 'legislacao', 'conformidade', 'regulamento'],
      'conformidade': ['conformidade', 'lei', 'legal', 'requisito', 'norma'],
      'iso': ['iso', 'norma', 'certificacao', 'requisito', 'conformidade'],
      'regulamento': ['regulamento', 'lei', 'legal', 'decreto', 'legislacao'],
      
      // Saúde e Segurança
      'seguranca': ['seguranca', 'saude', 'protecao', 'incendio', 'evacuacao', 'socorro'],
      'saude': ['saude', 'seguranca', 'protecao', 'bem-estar'],
      'incendio': ['incendio', 'seguranca', 'protecao', 'evacuacao', 'emergencia'],
      'emergencia': ['emergencia', 'incendio', 'seguranca', 'evacuacao'],
      
      // Transporte
      'transporte': ['transporte', 'emissao', 'combustivel', 'veiculo', 'logistica', 'carbono'],
      'veiculo': ['veiculo', 'transporte', 'combustivel', 'emissao'],
      
      // Equipa/Pessoal
      'equipa': ['equipa', 'pessoal', 'colaborador', 'trabalhador', 'formacao', 'treino', 'competencia'],
      'formacao': ['formacao', 'treino', 'sensibilizacao', 'competencia', 'capacitacao', 'equipa'],
      'treino': ['treino', 'formacao', 'sensibilizacao', 'capacitacao'],
      
      // Auditoria/Controlo
      'auditoria': ['auditoria', 'verificacao', 'inspecao', 'controlo', 'monitorizacao', 'avaliacao'],
      'inspecao': ['inspecao', 'auditoria', 'verificacao', 'controlo'],
      'controlo': ['controlo', 'auditoria', 'monitorizacao', 'verificacao'],
      'monitorizacao': ['monitorizacao', 'controlo', 'auditoria', 'seguimiento'],
      
      // Gerais
      'risco': ['risco', 'ameaca', 'perigo', 'problema', 'critico'],
      'oportunidade': ['oportunidade', 'melhoria', 'beneficio', 'vantagem', 'potencial'],
      'melhoria': ['melhoria', 'oportunidade', 'aprimoramento', 'otimizacao'],
      'impacto': ['impacto', 'efeito', 'consequencia', 'resultado', 'influencia'],
      'contaminacao': ['contaminacao', 'poluicao', 'quimico', 'toxico', 'desperdicio'],
    };

    // Expande termo de pesquisa com sinónimos
    function expandSearchTerm(term) {
      const normalized = normLoose(term);
      
      // Busca no mapa de sinónimos
      for (const [key, synonyms] of Object.entries(RO_SEARCH_SYNONYMS)) {
        if (normalized.includes(key) || key.includes(normalized) || normalized === key) {
          return synonyms;
        }
      }
      
      // Se não encontrar em sinónimos, retorna o termo normalizado
      return [normalized];
    }

    function applyRoFilters() {
      const searchInput = document.getElementById('searchRo').value.toLowerCase().trim();
      const normalized = (str) => normLoose(str);

      const filtered = roData.filter(item => {
        // Filtro por tipo (Risco/Oportunidade/Todos)
        if (roTypeFilter !== 'todos') {
          const ro = getAny(item, ['R / O', 'R/O', 'Tipo']);
          const roNormalized = normLoose(ro);
          const isRisco = roNormalized.startsWith('r') || roNormalized.includes('risco');
          
          if (roTypeFilter === 'risco' && !isRisco) return false;
          if (roTypeFilter === 'oportunidade' && isRisco) return false;
        }
        
        // Filtro por PROCESSO (cumulativo)
        if (currentRoFilters['processo'] && currentRoFilters['processo'].length > 0) {
          const processos = getAny(item, ['Processos', 'processos', 'PROCESSOS']) || '';
          const processosNorm = normLoose(processos);
          const filterNorm = currentRoFilters['processo'].map(f => normLoose(f));
          const matches = filterNorm.some(fn => processosNorm.includes(fn));
          if (!matches) return false;
        }
        
        // Filtro por ORIGEM (cumulativo)
        if (currentRoFilters['origem'] && currentRoFilters['origem'].length > 0) {
          const origem = getAny(item, ['Origem', 'origem', 'ORIGEM']) || '';
          const origemNorm = normLoose(origem);
          const filterNorm = currentRoFilters['origem'].map(f => normLoose(f));
          const matches = filterNorm.some(fn => origemNorm === fn);
          if (!matches) return false;
        }
        
        // Filtro por palavra-chave de pesquisa
        if (!searchInput) return true;
        
        const descricao = getAny(item, ['Descrição do Risco / Oportunidade', 'Descricao do Risco / Oportunidade', 'Descrição']);
        const origem = getAny(item, ['Origem']);
        const processos = getAny(item, ['Processos']);
        const codigo = getAny(item, ['Código (R&O)', 'Codigo (R&O)', 'Código', 'Codigo']);
        const keyword = getAny(item, ['KeyWord', 'Keyword']);
        
        const content = normalized(`${descricao} ${origem} ${processos} ${codigo} ${keyword}`);
        
        // Expande o termo com sinónimos
        const expandedTerms = expandSearchTerm(searchInput);
        
        // Verifica se algum dos termos expandidos está no conteúdo
        return expandedTerms.some(term => content.includes(term));
      });

      renderRo(filtered);
    }

    function setRoTypeFilter(type) {
      roTypeFilter = type;
      
      // Atualiza estado visual dos botões
      document.getElementById('roFilterTodos').classList.remove('active');
      document.getElementById('roFilterRisco').classList.remove('active');
      document.getElementById('roFilterOportunidade').classList.remove('active');
      
      if (type === 'todos') {
        document.getElementById('roFilterTodos').classList.add('active');
      } else if (type === 'risco') {
        document.getElementById('roFilterRisco').classList.add('active');
      } else if (type === 'oportunidade') {
        document.getElementById('roFilterOportunidade').classList.add('active');
      }
      
      // Aplica filtros
      applyRoFilters();
    }

    function toggleRoFilterSection(section) {
      const container = document.getElementById(`ro-${section}-container`);
      const chevron = document.querySelector(`.chevron-${section}`);
      
      if (container.classList.contains('hidden')) {
        // Abrir
        container.classList.remove('hidden');
        chevron.classList.add('expanded');
      } else {
        // Fechar
        container.classList.add('hidden');
        chevron.classList.remove('expanded');
      }
    }

    function setRoFilter(category, value) {
      // Multi-select com toggle para todos os filtros
      if (value === 'TODOS') {
        // Reset do filtro - limpar array
        currentRoFilters[category] = [];
        // Remover 'active' de todos exceto TODOS
        document.querySelectorAll(`[id^="filter-ro-${category}-"]`).forEach(b => b.classList.remove('active'));
        document.getElementById(`filter-ro-${category}-TODOS`).classList.add('active');
      } else {
        // Toggle do item específico
        const index = currentRoFilters[category].indexOf(value);
        
        if (index > -1) {
          // Já está selecionado, remover
          currentRoFilters[category].splice(index, 1);
        } else {
          // Não está selecionado, adicionar
          currentRoFilters[category].push(value);
        }
        
        // Remover 'active' do botão TODOS quando há filtros específicos
        const todosBtn = document.getElementById(`filter-ro-${category}-TODOS`);
        if (currentRoFilters[category].length > 0) {
          if (todosBtn) todosBtn.classList.remove('active');
        }
        
        // Atualizar visual do botão específico
        const btnId = `filter-ro-${category}-${value.replace(/\s+/g, '_')}`;
        const btn = document.getElementById(btnId);
        if (btn) btn.classList.toggle('active');
      }

      applyRoFilters();
    }

    function updateRoFilterButtons() {
      // Extrair valores únicos de Processo e Origem
      const valores = {
        processo: new Set(),
        origem: new Set()
      };

      roData.forEach(item => {
        const processo = getAny(item, ['Processos', 'processos', 'PROCESSOS']) || '';
        if (processo.trim()) {
          valores.processo.add(processo.trim());
        }
        const origem = getAny(item, ['Origem', 'origem', 'ORIGEM']) || '';
        if (origem.trim()) {
          valores.origem.add(origem.trim());
        }
      });

      // Criar botões para PROCESSO
      const processoContainer = document.getElementById('ro-processo-filters');
      if (processoContainer) {
        const processoSorted = Array.from(valores.processo).sort();
        processoContainer.innerHTML = processoSorted.map(val => `
          <button onclick="setRoFilter('processo', '${escapeHtml(val)}')" 
                  id="filter-ro-processo-${escapeHtml(val).replace(/\s+/g, '_')}" 
                  class="ro-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 text-[10px]">${escapeHtml(val)}</button>
        `).join('');
      }

      // Criar botões para ORIGEM
      const origemContainer = document.getElementById('ro-origem-filters');
      if (origemContainer) {
        const origemSorted = Array.from(valores.origem).sort();
        origemContainer.innerHTML = origemSorted.map(val => `
          <button onclick="setRoFilter('origem', '${escapeHtml(val)}')" 
                  id="filter-ro-origem-${escapeHtml(val).replace(/\s+/g, '_')}" 
                  class="ro-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 text-[10px]">${escapeHtml(val)}</button>
        `).join('');
      }
    }

    function applyPartesFilters() {
      const searchInput = document.getElementById('searchPartes').value.toLowerCase().trim();
      const normalized = (str) => normLoose(str);

      const filtered = partesData.filter(item => {
        if (!searchInput) return true;
        
        const codigo = getAny(item, ['Código', 'Codigo']);
        const parteInteressada = getAny(item, ['Parte interessada (PI)', 'Parte Interessada', 'Stakeholder']);
        const fonte = getAny(item, ['Fonte']);
        const requisitos = getAny(item, ['Requisitos Relevantes\n (Necessidades e expectativas)', 'Requisitos']);
        const expectativas = getAny(item, ['O que a Organização espera das Partes Interessadas', 'Expectativas']);
        const responsavel = getAny(item, ['Responsável pela Revisão', 'Responsavel']);
        
        const content = normalized(`${codigo} ${parteInteressada} ${fonte} ${requisitos} ${expectativas} ${responsavel}`);
        
        // Verificação simples de palavra-chave
        return content.includes(normalized(searchInput));
      });

      renderPartes(filtered);
    }

    function renderPartes(data) {
      const tbody = document.getElementById('partesTableBody');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-8 py-10 text-center text-slate-400 font-bold uppercase text-[10px]">Nenhum registo identificado</td></tr>';
        return;
      }

      tbody.innerHTML = data.map((item, idx) => {
        const codigo = getAny(item, ['Código', 'Codigo']);
        const parteInteressada = getAny(item, ['Parte interessada (PI)', 'Parte Interessada', 'Stakeholder']);
        const fonte = getAny(item, ['Fonte']);
        const requisitos = getAny(item, ['Requisitos Relevantes\n (Necessidades e expectativas)', 'Requisitos']);
        const expectativas = getAny(item, ['O que a Organização espera das Partes Interessadas', 'Expectativas']);
        const frequencia = getAny(item, ['Frequência de Revisão', 'Frequencia']);
        const responsavel = getAny(item, ['Responsável pela Revisão', 'Responsavel']);
        const nacoes = getAny(item, ['N º de Ação\n(Plano de Ações)', 'Nº de Ação', 'Acoes']);
        const objetivos = getAny(item, ['Objetivo SGQA Nº.', 'Objetivo SGQA']);

        // Badge para fonte
        const fonteColor = fonte.toLowerCase() === 'interna' ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-orange-100 text-orange-700 border-orange-300';

        return `
          <tr class="transition-colors group hover:bg-slate-50">
            <td class="px-3 py-3 text-xs font-black text-emerald-700 break-words">${escapeHtml(codigo)}</td>
            <td class="px-3 py-3 text-xs font-semibold text-slate-800 break-words">${escapeHtml(parteInteressada)}</td>
            <td class="px-3 py-3 text-xs break-words">
              <span class="inline-block px-2 py-1 rounded-full text-[8px] font-black border ${fonteColor} uppercase">${escapeHtml(fonte)}</span>
            </td>
            <td class="px-3 py-3 text-xs text-slate-700 break-words">${escapeHtml(requisitos)}</td>
            <td class="px-3 py-3 text-xs text-slate-700 break-words">${escapeHtml(expectativas)}</td>
            <td class="px-3 py-3 text-xs text-slate-700 break-words">${escapeHtml(frequencia)}</td>
            <td class="px-3 py-3 text-xs font-medium text-slate-800 break-words">${escapeHtml(responsavel)}</td>
            <td class="px-3 py-3 text-xs text-slate-600 break-words">${escapeHtml(nacoes)}</td>
            <td class="px-3 py-3 text-xs text-slate-600 break-words">${escapeHtml(objetivos)}</td>
          </tr>
        `;
      }).join('');
    }

    function renderRo(data) {
      const tbody = document.getElementById('roTableBody');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-8 py-10 text-center text-slate-400 font-bold uppercase text-[10px]">Nenhum registo identificado</td></tr>';
        return;
      }

      tbody.innerHTML = data.map((item, idx) => {
        const descricao = getAny(item, ['Descrição do Risco / Oportunidade', 'Descricao do Risco / Oportunidade', 'Descrição', 'Descricao']);
        const ro = getAny(item, ['R / O', 'R/O', 'Tipo']);
        const origem = getAny(item, ['Origem']);
        const processos = getAny(item, ['Processos']);
        const codigo = getAny(item, ['Código (R&O)', 'Codigo (R&O)', 'Código', 'Codigo']);
        const pa = getAny(item, ['PA', 'Plano de Ação']);
        const proveniencia = getAny(item, ['Proveniência (Origem do Risco)', 'Proveniencia (Origem do Risco)', 'Proveniência', 'Proveniencia']);
        const observacoes = getAny(item, ['Observações', 'Observacoes', 'Observação', 'Observacao']);
        const keyword = getAny(item, ['KeyWord', 'Keyword']);

        // Determina se é Risco (R) ou Oportunidade (O)
        const roNormalized = normLoose(ro);
        const isRisco = roNormalized.startsWith('r') || roNormalized.includes('risco');
        const roBadgeClass = isRisco ? 'ro-risco' : 'ro-oportunidade';
        
        const rowBgClass = isRisco ? 'bg-red-50/30 hover:bg-red-50/50' : 'bg-emerald-50/30 hover:bg-emerald-50/50';
        const rowBorderClass = isRisco ? 'border-l-4 border-red-500' : 'border-l-4 border-emerald-500';
        
        return `
          <tr class="transition-colors group ${rowBgClass} ${rowBorderClass}">
            <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(descricao)}</td>
            <td class="px-6 py-4 text-center">
              <span class="inline-block px-3 py-1.5 rounded-full text-[9px] font-black ${roBadgeClass} uppercase">${escapeHtml(ro)}</span>
            </td>
            <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(origem)}</td>
            <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(processos)}</td>
            <td class="px-6 py-4 text-center text-sm font-bold text-slate-700">${escapeHtml(codigo)}</td>
            <td class="px-6 py-4 text-center text-sm font-black ${pa && normLoose(pa) === 'sim' || normLoose(pa) === 's' ? 'text-emerald-600' : 'text-slate-400'}">${escapeHtml(pa)}</td>
            <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(proveniencia)}</td>
            <td class="px-6 py-4 text-sm text-slate-700">
              ${observacoes && String(observacoes).trim() 
                ? `<button class="btn-ro-swot-modal text-emerald-600 hover:text-emerald-700 hover:underline font-bold transition-colors" data-codigo="${escapeHtml(observacoes)}">${escapeHtml(observacoes)}</button>`
                : '<span class="text-slate-400 italic">-</span>'
              }
            </td>
            <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(keyword)}</td>
          </tr>
        `;
      }).join('');
    }

    function openRoSwotModalWithCode(codigo) {
      openRoSwotModal(codigo);
    }

    function openRoSwotModal(codigos) {
      // Extrai múltiplos códigos (separados por ; , ou espaço)
      const codigosArray = String(codigos || '')
        .split(/[;,]/)
        .map(c => c.trim())
        .filter(c => c.length > 0);

      const content = document.getElementById('roSwotModalContent');
      
      if (codigosArray.length === 0) {
        content.innerHTML = `<p class="text-slate-600 text-sm">Nenhum código fornecido.</p>`;
        const modal = document.getElementById('roSwotModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        return;
      }

      // Procura todos os códigos em swotData
      const matchedSwots = codigosArray.map(codigo => {
        const codigoNorm = normLoose(codigo);
        return {
          codigo: codigo,
          data: swotData.find(item => {
            const itemCodigo = getAny(item, ['código','Código','ID','id','codigo']);
            return normLoose(itemCodigo) === codigoNorm;
          })
        };
      });

      // Cria o HTML para todos os códigos encontrados
      let htmlContent = '';
      let foundCount = 0;
      let notFoundCodigos = [];

      matchedSwots.forEach(match => {
        if (!match.data) {
          notFoundCodigos.push(match.codigo);
          return;
        }

        foundCount++;
        const matchedSwot = match.data;
        const swotRaw = getAny(matchedSwot, ['SWOT','Swot']);
        const descricao = getAny(matchedSwot, ['Descrição','Descricao','DESC','desc']);
        const itemCodigo = getAny(matchedSwot, ['código','Código','ID','id','codigo']);
        const tomada = getTomadaAcao(matchedSwot);

        const planoMap = buildPlanoMap(matchedSwot);

        let acoesList = '';
        for (let i = 1; i <= 6; i++) {
          const cod = getAny(matchedSwot, [
            `CÓDIGO_AÇÃO ${i}`, `CODIGO_ACAO ${i}`, `CÓDIGO AÇÃO ${i}`, `CODIGO ACAO ${i}`,
            `CODIGO_AÇÃO ${i}`, `CÓDIGO_ACAO ${i}`
          ]);
          const acao = getAny(matchedSwot, [`AÇÃO ${i}`, `ACAO ${i}`, `Ação ${i}`, `Acao ${i}`]);
          const emPlano = planoMap[i] ?? '';
          
          if (!cod && !acao) continue;
          
          const badgePlano = planoBadgeHtml(emPlano);
          acoesList += `
            <div class="mb-4 p-3 bg-white rounded border border-slate-200">
              <div class="flex items-center justify-between gap-2 mb-2">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Ação ${i} (${escapeHtml(cod || '')})</p>
                ${badgePlano}
              </div>
              ${acao && String(acao).trim() ? `<p class="text-sm text-slate-700">${escapeHtml(acao)}</p>` : `<p class="text-[10px] text-slate-400 italic">Sem descrição</p>`}
            </div>
          `;
        }

        htmlContent += `
          <div class="border-l-4 border-emerald-500 pl-4 mb-6 pb-6 ${foundCount > 1 ? 'border-b border-slate-200' : ''}">
            <p class="text-[10px] font-black uppercase text-slate-400 mb-1">SWOT - ${escapeHtml(swotRaw)}</p>
            <p class="text-sm font-bold text-slate-700">Código: ${escapeHtml(itemCodigo)}</p>
            
            <div class="mt-4 mb-4">
              <p class="text-[10px] font-black uppercase text-slate-400 mb-2">Descrição</p>
              <p class="text-sm text-slate-700">${escapeHtml(descricao)}</p>
            </div>

            <div class="mb-4">
              <p class="text-[10px] font-black uppercase text-slate-400 mb-2">Tomada de Ação</p>
              <p class="text-sm text-slate-700">${escapeHtml(tomada)}</p>
            </div>

            ${acoesList ? `
            <div>
              <p class="text-[10px] font-black uppercase text-slate-400 mb-2">Ações Estratégicas</p>
              <div class="space-y-1">${acoesList}</div>
            </div>
            ` : ''}
          </div>
        `;
      });

      // Adiciona aviso para códigos não encontrados
      if (notFoundCodigos.length > 0) {
        htmlContent += `
          <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-[10px] font-black text-red-700 uppercase">Códigos não encontrados:</p>
            <p class="text-sm text-red-600">${escapeHtml(notFoundCodigos.join(', '))}</p>
          </div>
        `;
      }

      if (htmlContent === '') {
        htmlContent = `<p class="text-slate-600 text-sm">Nenhum registo SWOT encontrado para os códigos fornecidos.</p>`;
      }

      content.innerHTML = htmlContent;

      const modal = document.getElementById('roSwotModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeRoSwotModal(event) {
      if (event && event.target && event.target.id !== 'roSwotModal') return;
      const modal = document.getElementById('roSwotModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function openPdcaEficaciaModal(discussao, analise) {
      const content = document.getElementById('pdcaEficaciaModalContent');
      content.innerHTML = `
        <div class="space-y-4">
          <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
            <h3 class="text-sm font-bold text-slate-700 mb-2 uppercase tracking-widest">Discussão Eficácia</h3>
            <p class="text-sm text-slate-600 whitespace-pre-wrap">${discussao || 'Sem informação'}</p>
          </div>
          <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <h3 class="text-sm font-bold text-slate-700 mb-2 uppercase tracking-widest">Análise da Eficácia</h3>
            <p class="text-sm text-slate-600 whitespace-pre-wrap">${analise || 'Sem informação'}</p>
          </div>
        </div>
      `;
      const modal = document.getElementById('pdcaEficaciaModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closePdcaEficaciaModal(event) {
      if (event && event.target && event.target.id !== 'pdcaEficaciaModal') return;
      const modal = document.getElementById('pdcaEficaciaModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // =========
    // Organigrama
    // =========
    function toggleOrgView(view) {
      const fullView = document.getElementById('org-full-view');
      const detailsView = document.getElementById('org-details-view');
      const fullBtn = document.getElementById('org-full-btn');
      const detailsBtn = document.getElementById('org-details-btn');

      if (view === 'full') {
        fullView.classList.remove('hidden');
        detailsView.classList.add('hidden');
        fullBtn.classList.add('active');
        fullBtn.classList.remove('bg-slate-700', 'hover:bg-slate-600');
        fullBtn.classList.add('bg-white', 'text-slate-900');
        detailsBtn.classList.remove('active');
        detailsBtn.classList.remove('bg-white', 'text-slate-900');
        detailsBtn.classList.add('bg-slate-700', 'hover:bg-slate-600', 'text-white');
      } else {
        fullView.classList.add('hidden');
        detailsView.classList.remove('hidden');
        detailsBtn.classList.add('active');
        detailsBtn.classList.remove('bg-slate-700', 'hover:bg-slate-600');
        detailsBtn.classList.add('bg-white', 'text-slate-900');
        fullBtn.classList.remove('active');
        fullBtn.classList.remove('bg-white', 'text-slate-900');
        fullBtn.classList.add('bg-slate-700', 'hover:bg-slate-600', 'text-white');
      }
    }

    function openOrgStaffModal(deptName, staffString) {
      const staffList = staffString.split('|').map(s => s.trim()).filter(s => s);
      const modal = document.getElementById('org-staff-modal');
      const title = document.getElementById('org-modal-title');
      const staffDiv = document.getElementById('org-modal-staff');
      
      title.textContent = deptName;
      staffDiv.innerHTML = staffList.map(staff => `
        <div class="p-3 bg-slate-50 border-l-4 border-slate-300 rounded hover:bg-slate-100 transition-colors cursor-pointer">
          <p class="font-semibold text-slate-800">${staff}</p>
        </div>
      `).join('');
      
      modal.classList.remove('hidden');
    }

    function closeOrgStaffModal() {
      const modal = document.getElementById('org-staff-modal');
      modal.classList.add('hidden');
    }

    function openCertificationsModal() {
      const modal = document.getElementById('certifications-modal');
      modal.classList.remove('hidden');
    }

    function closeCertificationsModal() {
      const modal = document.getElementById('certifications-modal');
      modal.classList.add('hidden');
    }

    // ⚠️ NOTA: addDocumentToSheet não estava no snippet original (mantém a tua função anterior)

    window.onload = () => {
      toggleNewDocButton('docs');
      loadMeetingsData();
      loadAuditsData();
      fetchFromSheet();
      fetchSwot();
      fetchRo();
      fetchPartes();
      
      // ✅ Inicializa estado do filtro R&O
      setTimeout(() => {
        if (document.getElementById('roFilterTodos')) {
          document.getElementById('roFilterTodos').classList.add('active');
        }
      }, 100);

      // Event listeners para botões de departamento no organigrama
      document.querySelectorAll('.org-dept-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const dept = btn.getAttribute('data-dept');
          const staff = btn.getAttribute('data-staff');
          openOrgStaffModal(dept, staff);
        });
      });

      // Fechar modais ao clicar fora deles
      document.getElementById('org-staff-modal').addEventListener('click', (e) => {
        if (e.target.id === 'org-staff-modal') {
          closeOrgStaffModal();
        }
      });

      document.getElementById('certifications-modal').addEventListener('click', (e) => {
        if (e.target.id === 'certifications-modal') {
          closeCertificationsModal();
        }
      });

      // ✅ listeners para auto-gerar códigos das ações
      const swotCodigoEl = document.getElementById('swotCodigo');
      const swotTypeEl = document.getElementById('swotType');

      if (swotCodigoEl) {
        swotCodigoEl.addEventListener('input', () => autofillActionCodes(true));
        swotCodigoEl.addEventListener('blur', () => autofillActionCodes(true));
      }
      if (swotTypeEl) {
        swotTypeEl.addEventListener('change', () => {
          const pref = expectedPrefixFromSwotType(swotTypeEl.value);
          const current = cleanMainCode(swotCodigoEl?.value || '');
          if (!current && pref) swotCodigoEl.value = `${pref}1`;
          autofillActionCodes(true);
        });
      }

      for (let i = 1; i <= 6; i++) {
        const txtEl = document.getElementById(`acaoTxt${i}`);
        if (txtEl) txtEl.addEventListener('input', () => autofillActionCodes(false));
      }

      // ✅ Event listener para botões R&O que abrem modal SWOT
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-ro-swot-modal')) {
          const codigo = e.target.getAttribute('data-codigo');
          if (codigo) openRoSwotModal(codigo);
        }
      });

      // ✅ Close mobile menu when clicking outside
      document.addEventListener('click', (e) => {
        const mobileMenu = document.getElementById('mobile-menu');
        const burgerMenuBtn = document.getElementById('burger-menu-btn');
        
        if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
          if (!mobileMenu.contains(e.target) && !burgerMenuBtn.contains(e.target)) {
            closeMobileMenu();
          }
        }
      });
    };
  </script>
</body>
</html>
