<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal de Gestão ISO 14001 | Somengil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

    :root { --primary:#065f46; --secondary:#10b981; }

    body{
      font-family:'Plus Jakarta Sans',sans-serif;
      background-color:#f8fafc;
      color:#1e293b;
    }

    .glass-card{
      background:#ffffff;
      border:1px solid #e2e8f0;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.05),0 2px 4px -1px rgba(0,0,0,0.03);
      border-radius:1rem;
      transition:all .3s ease;
    }
    .glass-card:hover{ box-shadow:0 10px 15px -3px rgba(0,0,0,0.08); }

    .type-badge{
      font-size:0.65rem;
      padding:4px 12px;
      border-radius:8px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:0.05em;
      display:inline-block;
      border-width:1px;
    }
    .badge-procedimento{ background:#dcfce7; color:#166534; border-color:#bbf7d0; }
    .badge-instrucao{ background:#e0f2fe; color:#075985; border-color:#bae6fd; }
    .badge-registo{ background:#fef9c3; color:#854d0e; border-color:#fef08a; }
    .badge-manual{ background:#f3e8ff; color:#6b21a8; border-color:#e9d5ff; }
    .badge-politica{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
    .badge-modelo{ background:#fef9c3; color:#854d0e; border-color:#fef08a; }
    .badge-pasta{ background:#ffedd5; color:#9a3412; border-color:#fdba74; }
    .badge-default{ background:#f1f5f9; color:#475569; border-color:#e2e8f0; }

    /* SWOT Colors */
    .swot-f{ border-left: 4px solid #10b981; }     /* Forças */
    .swot-o{ border-left: 4px solid #3b82f6; }     /* Oportunidades */
    .swot-f-ext{ border-left: 4px solid #f59e0b; } /* Fraquezas */
    .swot-a{ border-left: 4px solid #ef4444; }     /* Ameaças */

    /* SWOT Category Badge */
    .swot-cat-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 800;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    /* ✅ CORES DAS TAGS POR CATEGORIA */
    .tag-sga { background:#f1f5f9; border-color:#e2e8f0; color:#475569; }
    .tag-energia { background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
    .tag-agua { background:#eff6ff; border-color:#bfdbfe; color:#1d4ed8; }
    .tag-residuos { background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
    .tag-legal { background:#f5f3ff; border-color:#ddd6fe; color:#5b21b6; }
    .tag-equipa { background:#fdf2f8; border-color:#fbcfe8; color:#9d174d; }
    .tag-emissoes { background:#fef2f2; border-color:#fecaca; color:#991b1b; }
    .tag-transporte { background:#fffbeb; border-color:#fde68a; color:#92400e; }

    /* ✅ R&O BADGES - Riscos & Oportunidades */
    .ro-risco {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #7f1d1d;
      border: 1.5px solid #dc2626;
      font-weight: 900;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
      letter-spacing: 0.05em;
    }
    .ro-risco::before {
      content: "⚠️";
      margin-right: 4px;
    }

    .ro-oportunidade {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      color: #15803d;
      border: 1.5px solid #22c55e;
      font-weight: 900;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
      letter-spacing: 0.05em;
    }
    .ro-oportunidade::before {
      content: "✓";
      margin-right: 4px;
    }

    .status-pulse{
      width:8px;height:8px;
      border-radius:50%;
      display:inline-block;
      margin-right:8px;
    }
    .pulse-emerald{ background:#10b981; box-shadow:0 0 0 rgba(16,185,129,0.4); animation:pulse 2s infinite; }

    @keyframes pulse{
      0%{ transform:scale(0.95); box-shadow:0 0 0 0 rgba(16,185,129,0.7); }
      70%{ transform:scale(1); box-shadow:0 0 0 10px rgba(16,185,129,0); }
      100%{ transform:scale(0.95); box-shadow:0 0 0 0 rgba(16,185,129,0); }
    }

    #adminModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.6);
      backdrop-filter:blur(4px);
      z-index:100;
      align-items:center;
      justify-content:center;
    }
    #adminModal.active{ display:flex; }

    .tab-btn.active {
      background: white;
      color: #065f46;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }

    .swot-filter-btn { transition: all 0.2s; }
    .swot-filter-btn.active {
      background-color: #065f46;
      color: white;
      border-color: #065f46;
    }

    .org-view-btn { transition: all 0.3s ease; }
    .org-view-btn.active {
      background: white;
      color: #1e293b;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
  </style>
</head>

<body class="min-h-screen pb-12">

  <!-- Modal: Adicionar Documento -->
  <div id="adminModal" onclick="closeModal(event)">
    <div class="glass-card w-full max-w-lg p-8 m-4 shadow-2xl" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-black text-slate-800 tracking-tight">Novo Documento</h2>
        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form id="addDocForm" onsubmit="addDocumentToSheet(event)" class="space-y-4">
        <div>
          <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Tipo</label>
          <select id="docType" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none">
            <option value="PROCEDIMENTO">Procedimento</option>
            <option value="INSTRUÇÃO">Instrução</option>
            <option value="REGISTO">Registo</option>
            <option value="MANUAL">Manual</option>
            <option value="POLÍTICA">Política</option>
            <option value="MODELO">Modelo</option>
            <option value="PASTA">Pasta</option>
            <option value="SGA">Outro (SGI)</option>
          </select>
        </div>
        <div>
          <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Designação</label>
          <input type="text" id="docName" placeholder="Nome do documento" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-emerald-500">
        </div>
        <div>
          <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Link</label>
          <input type="url" id="docLink" placeholder="https://drive.google.com/..." required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-emerald-500">
        </div>
        <div class="pt-4">
          <button id="btnAddDoc" type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black py-4 rounded-xl transition-all shadow-lg active:scale-95">
            GRAVAR NO SISTEMA
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Adicionar SWOT -->
  <div id="swotModal" class="fixed inset-0 hidden z-[120] items-center justify-center bg-slate-900/60 backdrop-blur-sm" onclick="closeSwotModal(event)">
    <div class="glass-card w-full max-w-2xl p-8 m-4 shadow-2xl" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-black text-slate-800 tracking-tight">Nova SWOT</h2>
        <button onclick="closeSwotModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form id="addSwotForm" onsubmit="addSwotToSheet(event)" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">SWOT</label>
            <select id="swotType" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none">
              <option value="INTERNAL STRENGTHS">INTERNAL STRENGTHS (Forças)</option>
              <option value="INTERNAL WEAKNESSES">INTERNAL WEAKNESSES (Fraquezas)</option>
              <option value="EXTERNAL OPPORTUNITIES">EXTERNAL OPPORTUNITIES (Oportunidades)</option>
              <option value="EXTERNAL THREATS">EXTERNAL THREATS (Ameaças)</option>
            </select>
          </div>

          <div>
            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Código</label>
            <input type="text" id="swotCodigo" placeholder="ex: S1 / W1 / O1 / T1" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-emerald-500">
          </div>
        </div>

        <div>
          <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Descrição</label>
          <textarea id="swotDescricao" required rows="3" placeholder="Descrição do ponto SWOT..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-emerald-500"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-[10px] font-black uppercase text-slate-400 mb-1">Tomada de ação?</label>
            <select id="swotTomada" required class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none">
              <option value="S">S</option>
              <option value="N" selected>N</option>
            </select>
          </div>
          <div class="flex items-end">
            <p class="text-[10px] text-slate-400 font-bold">Ações (máx. 6) — se não colocares código, é gerado automaticamente (S2_1, W1_1, O1_1, T1_1...).</p>
          </div>
        </div>

        <div id="swotActions" class="space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod1" type="text" placeholder="Código Ação 1 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt1" type="text" placeholder="Ação 1" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod2" type="text" placeholder="Código Ação 2 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt2" type="text" placeholder="Ação 2" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod3" type="text" placeholder="Código Ação 3 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt3" type="text" placeholder="Ação 3" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod4" type="text" placeholder="Código Ação 4 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt4" type="text" placeholder="Ação 4" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod5" type="text" placeholder="Código Ação 5 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt5" type="text" placeholder="Ação 5" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="acaoCod6" type="text" placeholder="Código Ação 6 (auto)" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
            <input id="acaoTxt6" type="text" placeholder="Ação 6" class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-xs outline-none focus:border-emerald-500">
          </div>
        </div>

        <div class="pt-4">
          <button id="btnAddSwot" type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black py-4 rounded-xl transition-all shadow-lg active:scale-95">
            GRAVAR SWOT
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Barra Superior -->
  <nav class="bg-emerald-900 text-white sticky top-0 z-50 shadow-lg">
    <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center">
      <div class="flex items-center space-x-4">
        <div class="bg-white/10 p-2.5 rounded-2xl border border-white/10">
          <svg class="w-7 h-7 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3.055 11H5a2 2 0 0 1 2 2v1a2 2 0 0 0 2 2 2 2 0 0 1 2 2v2.945M8 3.935V5.5A2.5 2.5 0 0 0 10.5 8h.5a2 2 0 0 1 2 2 2 0 1 0 4 0 9 9 0 0 1 2-2h1.064M15 20.488V18a2 2 0 0 1 2-2h3.064M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path>
          </svg>
        </div>
        <div>
          <h1 class="text-xl font-extrabold tracking-tight leading-none">SGI <span class="text-emerald-400">Somengil</span></h1>
          <p class="text-emerald-300/60 text-[10px] uppercase tracking-[0.2em] font-bold mt-1">Gestão Integrada ISO9001 & ISO14001</p>
        </div>
      </div>

      <div class="mt-4 md:mt-0 flex items-center gap-3">
        <div class="flex bg-black/20 p-1 rounded-xl mr-4">
          <button onclick="switchTab('docs')" id="tab-docs" class="tab-btn active px-4 py-1.5 rounded-lg text-xs font-bold transition-all">DOCUMENTAÇÃO</button>
          <button onclick="switchTab('swot')" id="tab-swot" class="tab-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all">ANÁLISE SWOT</button>
          <button onclick="switchTab('ro')" id="tab-ro" class="tab-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all">R&O</button>
          <button onclick="switchTab('org')" id="tab-org" class="tab-btn px-4 py-1.5 rounded-lg text-xs font-bold transition-all">ORGANIGRAMA</button>
        </div>

        <button id="btn-new-doc" onclick="openModal()" class="bg-white/10 hover:bg-white/20 text-white px-5 py-2 rounded-xl text-xs font-black transition-all border border-white/20">
          + NOVO DOC
        </button>

        <div class="bg-black/20 px-3 py-1.5 rounded-full flex items-center border border-white/5">
          <span id="status-dot" class="status-pulse pulse-emerald"></span>
          <span id="sync-status" class="text-[10px] font-bold uppercase text-emerald-200">Ligação Ativa</span>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-6 pt-8">

    <!-- CONTEÚDO: DOCUMENTAÇÃO -->
    <div id="view-docs" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="glass-card p-6 border-l-4 border-emerald-500">
          <p class="text-slate-400 text-[10px] uppercase font-bold mb-1">Documentos Totais</p>
          <h3 id="stat-docs" class="text-3xl font-black text-slate-800 tracking-tighter">--</h3>
        </div>
        <div class="glass-card p-6 md:col-span-2 flex items-center justify-between">
          <div class="relative w-full group">
            <input type="text" id="searchDocs" onkeyup="filterDocs()" placeholder="Pesquisar (ex: 'emergência' encontra 'segurança', 'autoprot.')" class="w-full bg-slate-50 border border-slate-200 pl-11 pr-4 py-3 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-emerald-500/10 focus:border-emerald-500 transition-all">
            <svg class="absolute left-4 top-3.5 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
        </div>
      </div>

      <div class="glass-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-slate-50 border-b border-slate-100">
                <th class="px-8 py-4 text-[11px] font-black text-slate-400 uppercase tracking-widest">Tipo</th>
                <th class="px-8 py-4 text-[11px] font-black text-slate-400 uppercase tracking-widest">Designação</th>
                <th class="px-8 py-4 text-[11px] font-black text-slate-400 uppercase tracking-widest text-right">Ação</th>
              </tr>
            </thead>
            <tbody id="docsTableBody" class="divide-y divide-slate-50">
              <tr><td colspan="3" class="px-8 py-20 text-center animate-pulse text-slate-400 font-bold uppercase text-[10px]">A carregar documentos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CONTEÚDO: SWOT -->
    <div id="view-swot" class="hidden space-y-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
          <h2 class="text-2xl font-black text-slate-800 tracking-tight">Análise SWOT Ambiental</h2>
          <p class="text-slate-500 text-sm">Matriz de Forças, Fraquezas, Oportunidades e Ameaças</p>
        </div>

        <div class="flex items-center gap-2">
          <a
            href="https://docs.google.com/spreadsheets/d/1n-9nPmr_owOXxOhfIqqIGnoBu8MdbkeknW1nRSKF6AI/edit?usp=sharing"
            target="_blank"
            rel="noopener"
            class="text-[10px] font-black text-slate-600 hover:text-slate-800 uppercase tracking-widest bg-white px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition-all"
            title="Abrir Google Sheets (origem dos dados SWOT)"
          >
            DOCUMENTO DE ORIGEM
          </a>

          <button onclick="fetchSwot()" class="text-[10px] font-black text-emerald-600 hover:text-emerald-700 uppercase tracking-widest bg-emerald-50 px-3 py-2 rounded-lg transition-all">Atualizar Dados</button>

          <button onclick="openSwotModal()" class="text-[10px] font-black text-white uppercase tracking-widest bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded-lg transition-all">
            + NOVA SWOT
          </button>
        </div>
      </div>

      <!-- Barra de Filtros SWOT -->
      <div class="glass-card p-4 space-y-4">
        <div class="flex flex-col md:flex-row gap-4 items-center">
          <div class="relative w-full md:w-1/4">
            <input type="text" id="searchSwot" onkeyup="applySwotFilters()" placeholder="Filtrar texto..." class="w-full bg-slate-50 border border-slate-200 pl-10 pr-4 py-2 rounded-xl text-xs outline-none focus:border-emerald-500">
            <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>

          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400">
            <span class="mr-2 whitespace-nowrap">Estado:</span>
            <button onclick="setActiveFilter('TODOS')" id="filter-active-TODOS" class="swot-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Tudo</button>
            <button onclick="setActiveFilter('ATIVOS')" id="filter-active-ATIVOS" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-emerald-200 hover:bg-emerald-50">Ativos</button>
            <button onclick="setActiveFilter('NAO_ATIVOS')" id="filter-active-NAO_ATIVOS" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Não ativos</button>
          </div>

          <!-- ✅ Filtro Plano de Ação? -->
          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 border-l border-slate-200 pl-4">
            <span class="mr-2 whitespace-nowrap">Plano de Ação?</span>
            <button onclick="setPlanFilter('TODOS')" id="filter-plan-TODOS" class="swot-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Tudo</button>
            <button onclick="setPlanFilter('S')" id="filter-plan-S" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-emerald-200 hover:bg-emerald-50">S</button>
            <button onclick="setPlanFilter('N')" id="filter-plan-N" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-amber-200 hover:bg-amber-50">N</button>
          </div>

          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 overflow-x-auto pb-2 md:pb-0">
            <span class="mr-2 whitespace-nowrap">Temas:</span>
            <button onclick="setSwotFilter('TODOS')" id="filter-swot-TODOS" class="swot-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">TUDO</button>
            <button onclick="setSwotFilter('Energia')" id="filter-swot-Energia" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Energia</button>
            <button onclick="setSwotFilter('Água')" id="filter-swot-Água" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Água</button>
            <button onclick="setSwotFilter('Resíduos')" id="filter-swot-Resíduos" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Resíduos</button>
            <button onclick="setSwotFilter('Legal')" id="filter-swot-Legal" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Legal</button>
            <button onclick="setSwotFilter('Equipa')" id="filter-swot-Equipa" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">Equipa</button>
          </div>

          <div class="flex flex-wrap gap-2 items-center text-[10px] font-bold uppercase text-slate-400 border-l border-slate-200 pl-4">
            <span class="mr-2 whitespace-nowrap">Quadrante:</span>
            <button onclick="setQuadrantFilter('TODOS')" id="filter-quad-TODOS" class="swot-filter-btn active px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">TUDO</button>
            <button onclick="setQuadrantFilter('FORÇAS')" id="filter-quad-FORÇAS" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-emerald-200 hover:bg-emerald-50">Forças</button>
            <button onclick="setQuadrantFilter('OPORTUNIDADES')" id="filter-quad-OPORTUNIDADES" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-blue-200 hover:bg-blue-50">Oport.</button>
            <button onclick="setQuadrantFilter('FRAQUEZAS')" id="filter-quad-FRAQUEZAS" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-amber-200 hover:bg-amber-50">Fraq.</button>
            <button onclick="setQuadrantFilter('AMEAÇAS')" id="filter-quad-AMEAÇAS" class="swot-filter-btn px-3 py-1.5 rounded-lg border border-red-200 hover:bg-red-50">Ameaças</button>
          </div>
        </div>
      </div>

      <div id="swot-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-4">
        <div id="quadrant-FORÇAS" class="space-y-4">
          <div class="flex items-center gap-3 pb-2 border-b-2 border-emerald-500/20">
            <div class="w-8 h-8 rounded-lg bg-emerald-500 flex items-center justify-center text-white shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <h3 class="font-black text-emerald-800 uppercase tracking-tighter">Forças</h3>
          </div>
          <div id="swot-forcas" class="space-y-4 min-h-[50px]"></div>
        </div>

        <div id="quadrant-OPORTUNIDADES" class="space-y-4">
          <div class="flex items-center gap-3 pb-2 border-b-2 border-blue-500/20">
            <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center text-white shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
            </div>
            <h3 class="font-black text-blue-800 uppercase tracking-tighter">Oportunidades</h3>
          </div>
          <div id="swot-oportunidades" class="space-y-4 min-h-[50px]"></div>
        </div>

        <div id="quadrant-FRAQUEZAS" class="space-y-4">
          <div class="flex items-center gap-3 pb-2 border-b-2 border-amber-500/20">
            <div class="w-8 h-8 rounded-lg bg-amber-500 flex items-center justify-center text-white shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 class="font-black text-amber-800 uppercase tracking-tighter">Fraquezas</h3>
          </div>
          <div id="swot-fraquezas" class="space-y-4 min-h-[50px]"></div>
        </div>

        <div id="quadrant-AMEAÇAS" class="space-y-4">
          <div class="flex items-center gap-3 pb-2 border-b-2 border-red-500/20">
            <div class="w-8 h-8 rounded-lg bg-red-500 flex items-center justify-center text-white shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
            </div>
            <h3 class="font-black text-red-800 uppercase tracking-tighter">Ameaças</h3>
          </div>
          <div id="swot-ameacas" class="space-y-4 min-h-[50px]"></div>
        </div>
      </div>
    </div>

    <!-- CONTEÚDO: R&O -->
    <div id="view-ro" class="hidden space-y-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
          <h2 class="text-2xl font-black text-slate-800 tracking-tight">Riscos e Oportunidades (R&O)</h2>
          <p class="text-slate-500 text-sm">Matriz de Riscos e Oportunidades Ambientais</p>
          <div class="flex gap-6 mt-3">
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-black text-red-700 bg-red-100 border border-red-300">⚠️ R = Risco</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-black text-emerald-700 bg-emerald-100 border border-emerald-300">✓ O = Oportunidade</span>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <a
            href="https://docs.google.com/spreadsheets/d/1n-9nPmr_owOXxOhfIqqIGnoBu8MdbkeknW1nRSKF6AI/edit?usp=sharing"
            target="_blank"
            rel="noopener"
            class="text-[10px] font-black text-slate-600 hover:text-slate-800 uppercase tracking-widest bg-white px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 transition-all"
            title="Abrir Google Sheets (origem dos dados R&O)"
          >
            DOCUMENTO DE ORIGEM
          </a>

          <button onclick="fetchRo()" class="text-[10px] font-black text-emerald-600 hover:text-emerald-700 uppercase tracking-widest bg-emerald-50 px-3 py-2 rounded-lg transition-all">Atualizar Dados</button>
        </div>
      </div>

      <!-- Barra de Filtros R&O -->
      <div class="glass-card p-4 space-y-4">
        <div class="relative w-full">
          <input type="text" id="searchRo" onkeyup="applyRoFilters()" placeholder="Filtrar por palavra-chave..." class="w-full bg-slate-50 border border-slate-200 pl-10 pr-4 py-2 rounded-xl text-xs outline-none focus:border-emerald-500">
          <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
      </div>

      <!-- Tabela R&O -->
      <div class="glass-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 border-b-2 border-slate-200">
              <tr>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600">Descrição do Risco / Oportunidade</th>
                <th class="px-6 py-3 text-center text-[10px] font-black uppercase text-slate-600">R / O</th>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600">Origem</th>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600">Processos</th>
                <th class="px-6 py-3 text-center text-[10px] font-black uppercase text-slate-600">Código (R&O)</th>
                <th class="px-6 py-3 text-center text-[10px] font-black uppercase text-slate-600">PA</th>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600">Proveniência</th>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600 cursor-pointer" title="Clique para ver informação SWOT">Observações</th>
                <th class="px-6 py-3 text-left text-[10px] font-black uppercase text-slate-600">KeyWord</th>
              </tr>
            </thead>
            <tbody id="roTableBody" class="divide-y divide-slate-200">
              <tr><td colspan="9" class="px-8 py-10 text-center text-slate-400 font-bold uppercase text-[10px]">A carregar dados...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CONTEÚDO: ORGANIGRAMA -->
    <div id="view-org" class="hidden space-y-8">
      <!-- Cabeçalho do Organigrama -->
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-8 rounded-2xl shadow-lg">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
          <div>
            <h1 class="text-4xl font-black tracking-tight">ORGANIGRAMA</h1>
            <p class="text-slate-300 text-sm mt-2">Estrutura Organizacional - SOMENGIL</p>
          </div>
          <div class="flex gap-3">
            <button onclick="toggleOrgView('full')" id="org-full-btn" class="org-view-btn active px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white text-slate-900">Vista Geral</button>
            <button onclick="toggleOrgView('details')" id="org-details-btn" class="org-view-btn px-6 py-2 rounded-lg text-sm font-bold transition-all bg-slate-700 hover:bg-slate-600 text-white">Detalhes</button>
          </div>
        </div>
      </div>

      <!-- Vista Geral (Organigrama) -->
      <div id="org-full-view" class="pb-12 bg-white rounded-xl p-6 shadow-sm border border-slate-200">
        <div class="flex flex-col items-center w-full relative">
          
          <!-- Administração (Topo) -->
          <div class="mb-10 relative">
            <div class="bg-gradient-to-br from-slate-900 to-slate-800 text-white px-4 py-3 rounded-lg shadow-lg min-w-[160px] text-center border border-slate-700">
              <h3 class="font-black text-base uppercase tracking-tight mb-1">ADMINISTRAÇÃO</h3>
              <p class="text-xs">Tony Ventura</p>
            </div>
          </div>

          <!-- Nível de Staff (Contabilidade/SGQA) -->
          <div class="flex justify-center gap-8 mb-10 relative">
            
            <!-- Contabilidade -->
            <div class="flex flex-col items-center relative">
              <div class="mb-2 p-1.5 bg-blue-100 rounded-full text-blue-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-6 3h12a2 2 0 002-2V9a2 2 0 00-2-2H3a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
              </div>
              <button class="org-dept-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-blue-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="CONTABILIDADE" data-staff="Lúcio Mota|Ricardo Costa">
                <h3 class="font-bold uppercase text-xs">CONTABILIDADE</h3>
              </button>
            </div>

            <!-- SGQA -->
            <div class="flex flex-col items-center relative">
              <div class="mb-2 p-1.5 bg-green-100 rounded-full text-green-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
              </div>
              <button class="org-dept-btn bg-green-600 hover:bg-green-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-green-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="SGI" data-staff="Mário Fragoso">
                <h3 class="font-bold uppercase text-xs">SGI</h3>
              </button>
            </div>
          </div>

          <!-- Departamentos (Nível Inferior) -->
          <div class="relative pt-10 w-full flex justify-center gap-2 flex-wrap pb-4">
            
            <!-- Pós Venda -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-red-100 rounded-full text-red-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
              </div>
              <button class="org-dept-btn bg-red-600 hover:bg-red-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-red-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Pós Venda" data-staff="Carina Robaina|Cândido Veloso|Tiago Oliveira|Tiago Dias|Alexandre Neves|Leonel Pereira">
                <h3 class="font-bold uppercase text-xs">Pós Venda</h3>
              </button>
            </div>

            <!-- Financeiro -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-amber-100 rounded-full text-amber-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              </div>
              <button class="org-dept-btn bg-amber-600 hover:bg-amber-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-amber-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Financeiro" data-staff="Lúcio Mota">
                <h3 class="font-bold uppercase text-xs">Financeiro</h3>
              </button>
            </div>

            <!-- Produção -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-orange-100 rounded-full text-orange-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
              </div>
              <button class="org-dept-btn bg-orange-600 hover:bg-orange-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-orange-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Produção" data-staff="Joni Regalado|Fábio Silva|Carlos Almeida|Tiago Dias|Alexandre Neves|Leonel Pereira|Ilídio Ferreira|Octávio Silva|Abel Tavares|Pedro Barreira|Manuel Martins">
                <h3 class="font-bold uppercase text-xs">Produção</h3>
              </button>
            </div>

            <!-- R&D -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-purple-100 rounded-full text-purple-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5h.01M9 9h.01"></path></svg>
              </div>
              <button class="org-dept-btn bg-purple-600 hover:bg-purple-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-purple-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="R&D" data-staff="Joni Regalado|Jonathan Santos|Ricardo Hipólito|Miguel Marta">
                <h3 class="font-bold uppercase text-xs">R&D</h3>
              </button>
            </div>

            <!-- Compras -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-blue-100 rounded-full text-blue-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
              </div>
              <button class="org-dept-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-blue-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Compras" data-staff="Paulo Brioso|Lúcio Mota">
                <h3 class="font-bold uppercase text-xs">Compras</h3>
              </button>
            </div>

            <!-- Logística -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-indigo-100 rounded-full text-indigo-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M8 20h8a2 2 0 002-2V8a2 2 0 00-2-2H8a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
              </div>
              <button class="org-dept-btn bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-indigo-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Logística" data-staff="Lúcio Mota|Paulo Brioso|Carlos Tarenta">
                <h3 class="font-bold uppercase text-xs">Logística</h3>
              </button>
            </div>

            <!-- Comercial -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-emerald-100 rounded-full text-emerald-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L5.257 18.757M13 7L5.257 15.757"></path></svg>
              </div>
              <button class="org-dept-btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-emerald-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Comercial" data-staff="Tony Ventura|NACIONAL - Manuel Diniz|INTERNACIONAL - Tony Ventura|INTERNACIONAL - David Borges|INTERNACIONAL - André Quental|INTERNACIONAL - Renato Gomes|INTERNACIONAL - Davide Sturla|INTERNACIONAL - Diogo Sousa|INTERNACIONAL - David Mendez">
                <h3 class="font-bold uppercase text-xs">Comercial</h3>
              </button>
            </div>

            <!-- MArketing -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-amber-100 rounded-full text-amber-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L5.257 18.757M13 7L5.257 15.757"></path></svg>
              </div>
              <button class="org-dept-btn bg-amber-600 hover:bg-amber-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-amber-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="Marketing" data-staff="Tony Ventura| António Jorge">
                <h3 class="font-bold uppercase text-xs">Marketing</h3>
              </button>
            </div>

            <!-- IoT (Novo Departamento) -->
            <div class="flex flex-col items-center relative z-10">
              <div class="mb-2 p-1.5 bg-cyan-100 rounded-full text-cyan-600 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
              </div>
              <button class="org-dept-btn bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-3 rounded-lg shadow-md text-center border border-cyan-700 cursor-pointer transition-colors w-[140px] h-[110px] flex flex-col items-center justify-center" data-dept="IoT" data-staff="Samuel Póvoa">
                <h3 class="font-bold uppercase text-xs">IoT</h3>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal para exibir pessoal do departamento -->
      <div id="org-staff-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
          <div class="flex justify-between items-center mb-4 pb-4 border-b-2">
            <h2 id="org-modal-title" class="font-bold text-xl uppercase">Departamento</h2>
            <button onclick="closeOrgStaffModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
          </div>
          <div id="org-modal-staff" class="space-y-2 max-h-96 overflow-y-auto">
            <!-- Staff list will be inserted here -->
          </div>
          <button onclick="closeOrgStaffModal()" class="w-full mt-6 bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg transition-colors">Fechar</button>
        </div>
      </div>

      <!-- Vista de Detalhes Operacionais -->
      <div id="org-details-view" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Pós Venda -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
          <div class="flex items-center gap-3 mb-4 pb-4 border-b-2 border-red-500/30">
            <div class="p-2 bg-red-100 rounded-lg text-red-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            </div>
            <h2 class="font-black text-red-700 uppercase text-sm">Fluxos Pós Venda</h2>
          </div>
          <div class="space-y-4">
            <div class="p-3 bg-red-50 border-l-4 border-red-500 rounded">
              <p class="font-bold text-red-900 text-sm mb-2">PÓS VENDA - Carina Robaina</p>
              <ul class="text-xs text-red-800 space-y-1">
                <li>• Planeamento: Instalação de Equipamentos</li>
                <li>• Equipas de Instalação</li>
                <li>• Logística: Envio de peças de substituição</li>
              </ul>
              <p class="text-[9px] font-semibold italic text-red-700 mt-2">⚠️ Em CC sempre service@somengil.com</p>
            </div>
            <div class="p-3 bg-red-50 border-l-4 border-red-500 rounded">
              <p class="font-bold text-red-900 text-sm mb-2">PÓS VENDA - Cândido Veloso</p>
              <ul class="text-xs text-red-800 space-y-1">
                <li>• Suporte Técnico</li>
                <li>• Instalação de Equipamentos</li>
                <li>• Funcionamento não standard</li>
                <li>• Prevenção</li>
              </ul>
              <p class="text-[9px] font-semibold italic text-red-700 mt-2">⚠️ Em CC sempre service@somengil.com</p>
            </div>
            <div class="p-3 bg-red-50 border-l-4 border-red-500 rounded">
              <p class="font-bold text-red-900 text-sm mb-2">PÓS VENDA - Tiago Oliveira</p>
              <ul class="text-xs text-red-800 space-y-1">
                <li>• Planeamento Live Demos</li>
                <li>• Teste e Demonstrações</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- R&D & Logística -->
        <div class="space-y-6">
          <!-- R&D -->
          <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
            <div class="flex items-center gap-3 mb-4 pb-4 border-b-2 border-purple-500/30">
              <div class="p-2 bg-purple-100 rounded-lg text-purple-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5h.01M9 9h.01"></path></svg>
              </div>
              <h2 class="font-black text-purple-700 uppercase text-sm">Planeamento R&D</h2>
            </div>
            <div class="space-y-3">
              <div class="p-3 bg-purple-50 border-l-4 border-purple-500 rounded">
                <p class="font-bold text-purple-900 text-sm mb-1">R&D - Joni Regalado</p>
                <ul class="text-xs text-purple-800 space-y-1">
                  <li>• Planeamento: Início Produção</li>
                  <li>• Data de Entrega</li>
                </ul>
              </div>
              <div class="p-3 bg-purple-50 border-l-4 border-purple-500 rounded">
                <p class="font-bold text-purple-900 text-sm mb-1">R&D - Jonathan Santos</p>
                <ul class="text-xs text-purple-800 space-y-1">
                  <li>• Desenvolvimento: MULTIWASHER</li>
                </ul>
              </div>
              <div class="p-3 bg-purple-50 border-l-4 border-purple-500 rounded">
                <p class="font-bold text-purple-900 text-sm mb-1">R&D - Ricardo Hipólito</p>
                <ul class="text-xs text-purple-800 space-y-1">
                  <li>• Desenvolvimento: TROLLEYS</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Logística -->
          <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
            <div class="flex items-center gap-3 mb-4 pb-4 border-b-2 border-indigo-500/30">
              <div class="p-2 bg-indigo-100 rounded-lg text-indigo-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M8 20h8a2 2 0 002-2V8a2 2 0 00-2-2H8a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
              </div>
              <h2 class="font-black text-indigo-700 uppercase text-sm">Logística & Envio</h2>
            </div>
            <div class="space-y-3">
              <div class="p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                <p class="font-bold text-indigo-900 text-sm mb-1">Logística - Lúcio Mota</p>
                <ul class="text-xs text-indigo-800 space-y-1">
                  <li>• Planeamento Envio Equipamentos: INTERNACIONAL</li>
                </ul>
              </div>
              <div class="p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                <p class="font-bold text-indigo-900 text-sm mb-1">Logística - Paulo Brioso</p>
                <ul class="text-xs text-indigo-800 space-y-1">
                  <li>• Planeamento Envio Equipamentos: NACIONAL</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- IoT -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
          <div class="flex items-center gap-3 mb-4 pb-4 border-b-2 border-cyan-500/30">
            <div class="p-2 bg-cyan-100 rounded-lg text-cyan-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <h2 class="font-black text-cyan-700 uppercase text-sm">IoT & Inovação</h2>
          </div>
          <div class="space-y-3">
            <div class="p-3 bg-cyan-50 border-l-4 border-cyan-500 rounded">
              <p class="font-bold text-cyan-900 text-sm mb-1">IoT - Samuel Póvoa</p>
              <ul class="text-xs text-cyan-800 space-y-1">
                <li>• Desenvolvimento de Soluções IoT</li>
                <li>• Integração de Sistemas Inteligentes</li>
                <li>• Monitorização Remota</li>
              </ul>
            </div>
            <div class="p-3 bg-cyan-50 border-l-4 border-cyan-500 rounded">
              <p class="font-bold text-cyan-900 text-sm mb-1">IoT - Joni Regalado</p>
              <ul class="text-xs text-cyan-800 space-y-1">
                <li>• Coordenação Técnica IoT</li>
                <li>• Integração com Produção</li>
                <li>• Validação e Testes</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Estrutura Comercial -->
        <div class="lg:col-span-2 bg-white rounded-xl p-6 shadow-sm border border-slate-200">
          <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-emerald-500/30">
            <div class="p-2 bg-emerald-100 rounded-lg text-emerald-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8L5.257 18.757M13 7L5.257 15.757"></path></svg>
            </div>
            <h2 class="font-black text-emerald-700 uppercase text-sm">Estrutura Comercial</h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-emerald-50 rounded-lg p-4 border-l-4 border-emerald-600">
              <h3 class="font-bold text-emerald-900 text-sm mb-3 uppercase">Nacional</h3>
              <div class="space-y-2 text-sm text-emerald-800">
                <p>✓ Manuel Diniz</p>
              </div>
            </div>
            <div class="bg-emerald-50 rounded-lg p-4 border-l-4 border-emerald-600">
              <h3 class="font-bold text-emerald-900 text-sm mb-3 uppercase">Comercial Internacional</h3>
              <div class="space-y-2 text-[12px] text-emerald-800">
                <p>✓ Tony Ventura</p>
                <p>✓ David Borges</p>
                <p>✓ André Quental</p>
                <p>✓ Renato Gomes</p>
              </div>
            </div>
            <div class="bg-emerald-50 rounded-lg p-4 border-l-4 border-emerald-600">
              <h3 class="font-bold text-emerald-900 text-sm mb-3 uppercase">Marketing</h3>
              <div class="space-y-2 text-sm text-emerald-800">
                <p>✓ Tony Ventura</p>
                <p>✓ António Jorge</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Legenda -->
      <div class="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-6 rounded-xl flex flex-wrap gap-6 justify-center">
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-slate-700 rounded border border-slate-600"></div>
          <span class="text-sm font-semibold">Direção</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-red-600 rounded"></div>
          <span class="text-sm font-semibold">Pós Venda</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-amber-600 rounded"></div>
          <span class="text-sm font-semibold">Financeiro</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-orange-600 rounded"></div>
          <span class="text-sm font-semibold">Produção</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-purple-600 rounded"></div>
          <span class="text-sm font-semibold">R&D</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-blue-600 rounded"></div>
          <span class="text-sm font-semibold">Compras</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-indigo-600 rounded"></div>
          <span class="text-sm font-semibold">Logística</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-emerald-600 rounded"></div>
          <span class="text-sm font-semibold">Comercial</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-amber-600 rounded"></div>
          <span class="text-sm font-semibold">Marketing</span>
        </div>        
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-cyan-600 rounded"></div>
          <span class="text-sm font-semibold">IoT</span>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Detalhe SWOT do R&O -->
  <div id="roSwotModal" class="fixed inset-0 hidden z-[120] items-center justify-center bg-slate-900/60 backdrop-blur-sm" onclick="closeRoSwotModal(event)">
    <div class="glass-card w-full max-w-2xl p-8 m-4 shadow-2xl overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-black text-slate-800 tracking-tight">Detalhe SWOT</h2>
        <button onclick="closeRoSwotModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="roSwotModalContent" class="space-y-4">
        <!-- Conteúdo preenchido dinamicamente -->
      </div>
    </div>
  </div>

  <script>
    const MAIN_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzWI5Yq4Ng61JUwcM0Okg1xfaXTJ1fu4g7c_aYWOWIVqeEv9_JBhnfKw6DgNwkHVg4wDg/exec';
    const SWOT_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWndlm0j_tgScKnzmKoHxNGqlLmccRNi0LfFI50K5fWipMRsEW3PnsNA9MgeKJMmvz/exec';
    const SWOT_WRITE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzQNDfWCVPYPz84y7CU2BUYWbN-Orh0hq7CLzmjuCu1vrDnKRe7WgskN6ZXjsSQDSHJ/exec';
    const RO_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWndlm0j_tgScKnzmKoHxNGqlLmccRNi0LfFI50K5fWipMRsEW3PnsNA9MgeKJMmvz/exec';

    let allDocuments = [];
    let swotData = [];
    let roData = [];

    let currentSwotFilterCategory = 'TODOS';
    let currentSwotFilterQuadrant = 'TODOS';
    let currentSwotActiveFilter = 'TODOS'; // TODOS | ATIVOS | NAO_ATIVOS
    let currentSwotPlanFilter = 'TODOS';   // TODOS | S | N

    // =========
    // Normalização
    // =========
    const normLoose = (s) => String(s || '')
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .trim();

    const keyLoose = (s) => normLoose(s).replace(/[^a-z0-9]/g, '');

    function getValLoose(obj, wantedKey) {
      const want = keyLoose(wantedKey);
      const found = Object.keys(obj || {}).find(k => keyLoose(k) === want);
      return found ? obj[found] : '';
    }

    function getAny(obj, keys) {
      for (const k of keys) {
        const v = getValLoose(obj, k);
        if (v !== undefined && v !== null && String(v).trim() !== '') return v;
      }
      return '';
    }

    // =========
    // ✅ Regras de códigos (S/W/O/T)
    // =========
    const SWOT_PREFIX = {
      "INTERNAL STRENGTHS": "S",
      "INTERNAL WEAKNESSES": "W",
      "EXTERNAL OPPORTUNITIES": "O",
      "EXTERNAL THREATS": "T"
    };

    function expectedPrefixFromSwotType(swotType) {
      return SWOT_PREFIX[String(swotType || '').trim()] || '';
    }

    function cleanMainCode(code) {
      return String(code || '')
        .toUpperCase()
        .replace(/\s+/g, '')
        .trim();
    }

    function deriveActionCode(mainCode, i) {
      const c = cleanMainCode(mainCode);
      if (!c) return '';
      return `${c}_${i}`;
    }

    function validateMainCodeAgainstType(swotType, mainCode) {
      const pref = expectedPrefixFromSwotType(swotType);
      const c = cleanMainCode(mainCode);
      if (!pref || !c) return true;
      return c.startsWith(pref);
    }

    function autofillActionCodes(force = false) {
      const mainCode = cleanMainCode(document.getElementById('swotCodigo')?.value || '');
      for (let i = 1; i <= 6; i++) {
        const codEl = document.getElementById(`acaoCod${i}`);
        const txtEl = document.getElementById(`acaoTxt${i}`);
        if (!codEl) continue;

        const hasText = !!(txtEl && String(txtEl.value || '').trim());
        const current = String(codEl.value || '').trim();

        if ((force || (hasText && !current)) && mainCode) {
          codEl.value = deriveActionCode(mainCode, i);
        }
      }
    }

    // =========
    // Categorias (por termos + regex)
    // =========
    const swotCategories = [
      { key:"Energia", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/energia|eletric|electr|kwh|autoconsumo|fotovoltaic|pv\b|baterias|auditoria energet/i]},
      { key:"Resíduos", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/residu|lixo|reciclag|segregac|valorizac|embalagen|perigos|ecoponto|oleo|quimic/i]},
      { key:"Água", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 13c0 5-3.5 7.5-7.667 7.5S4.667 18 4.667 13C4.667 8.5 12 2 12 2s7.333 6.5 7.333 11z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/agua|hidric|hidrico|hidrica|escassez|litros|efluen|auditoria hidric|tarif|reutiliz|reaproveit|circuito fechado|low water|water consumption/i, /\bwater\b|\blow water\b|\bwater consumption\b|\bwater saving\b/i]},
      { key:"Legal", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/lei|legislac|regulament|conformid|requisit|iso\b|ai act|csrd/i]},
      { key:"Equipa", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/equipa|pessoas|colaborador|rh\b|formac|treino|sensibiliz|competenc|cultura|clima|lideranc|bem[- ]?estar|burnout|psicossoc/i]},
      { key:"Emissões", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/co2|emiss|carbono|pegada|lca|scope/i]},
      { key:"Transporte", icon:'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" stroke-width="2"></path><path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>', patterns:[/transporte|logistic|frota|veicul|combust|deslocac/i]}
    ];

    function getSwotCategory(text) {
      const txt = normLoose(text);
      if (!txt) return { key: "SGA", icon: '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>' };
      const cat = swotCategories.find(c => (c.patterns || []).some(p => p.test(txt)));
      return cat || { key: "SGA", icon: '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0 1 12 2.944a11.955 11.955 0 0 1-8.618 3.04A12.02 12.02 0 0 0 3 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-0.133-2.052-0.382-3.016z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>' };
    }

    function getSwotTagClass(key) {
      const k = normLoose(key);
      if (k === 'energia') return 'tag-energia';
      if (k === 'agua') return 'tag-agua';
      if (k === 'residuos') return 'tag-residuos';
      if (k === 'legal') return 'tag-legal';
      if (k === 'equipa') return 'tag-equipa';
      if (k === 'emissoes') return 'tag-emissoes';
      if (k === 'transporte') return 'tag-transporte';
      return 'tag-sga';
    }

    // =========
    // ✅ Tomada de Ação / Em Plano de Ação (robusto a cabeçalhos)
    // =========
    function getTomadaAcao(item) {
      return getAny(item, [
        'TOMADA DE AÇÃO',
        'TOMADA DE ACAO',
        'TOMADA DE AÇÃO?',
        'TOMADA DE ACAO?',
        'Tomada de Ação',
        'Tomada de Acao',
        'Tomada de Ação?',
        'Tomada de Acao?',
        'TOMADA',
        'tomada'
      ]);
    }

    function isYes(val) {
      const t = String(val || '').normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
      return (t === 'S' || t === 'SIM' || t === 'Y' || t === 'YES' || t === 'TRUE' || t === '1' || t === 'ATIVO' || t === 'ACTIVO');
    }

    function isAtivoFromTomada(tomada) {
      return isYes(tomada);
    }

    // ✅ este helper mantém a lógica "contém", não "igual"
    function keyLooseKeep(s) {
      return normLoose(s).replace(/[^a-z0-9]/g, '');
    }

    // encontra a coluna de "Em Plano de Ação <i> ... (S/N)" mesmo com variações
    function findPlanoKeyForIndex(item, i) {
      const keys = Object.keys(item || {});
      const idx = String(i);

      const candidates = keys.filter(k => {
        const kk = keyLooseKeep(k); // ex: "emplanodeacao1sn"
        const hasBase = kk.includes('emplanodeacao');
        const hasIdx = kk.includes(idx);
        const hasSN = kk.includes('sn'); // apanha (S/N), S/N, etc.
        return hasBase && hasIdx && hasSN;
      });

      candidates.sort((a,b) => a.length - b.length);
      return candidates[0] || '';
    }

    function getPlanoAcaoFlag(item, i) {
      const k = findPlanoKeyForIndex(item, i);
      if (!k) return '';
      return item[k] ?? '';
    }

    function buildPlanoMap(item) {
      const map = {};
      for (let i = 1; i <= 6; i++) map[i] = getPlanoAcaoFlag(item, i);
      return map;
    }

    function planoBadgeHtml(flag) {
      if (isYes(flag)) {
        return `<span class="px-2 py-0.5 rounded-full text-[8px] font-black bg-emerald-100 text-emerald-700 uppercase">Plano: S</span>`;
      }
      return `<span class="px-2 py-0.5 rounded-full text-[8px] font-black bg-amber-100 text-amber-800 uppercase">Plano: N</span>`;
    }

    // =========
    // Helpers SWOT (texto completo)
    // =========
    function buildSwotBlob(item) {
      const swotRaw = getAny(item, ['SWOT','Swot']);
      const codigo = getAny(item, ['código','Código','ID','id','codigo']);
      const descricao = getAny(item, ['Descrição','Descricao','DESC','desc']);
      const tomada = getTomadaAcao(item);

      let acoes = '';
      for (let i = 1; i <= 6; i++) {
        const cod = getAny(item, [
          `CÓDIGO_AÇÃO ${i}`, `CODIGO_ACAO ${i}`, `CÓDIGO AÇÃO ${i}`, `CODIGO ACAO ${i}`,
          `CODIGO_AÇÃO ${i}`, `CÓDIGO_ACAO ${i}`
        ]);
        const acao = getAny(item, [`AÇÃO ${i}`, `ACAO ${i}`, `Ação ${i}`, `Acao ${i}`]);
        const emPlano = getPlanoAcaoFlag(item, i);
        if (cod || acao || emPlano) acoes += ` ${cod} ${acao} ${emPlano}`;
      }

      return `${swotRaw} ${codigo} ${descricao} ${tomada} ${acoes}`.trim();
    }

    // =========
    // UI / Modais / Tabs
    // =========
    function openModal(){ document.getElementById('adminModal').classList.add('active'); }
    function closeModal(){ document.getElementById('adminModal').classList.remove('active'); }

    function openSwotModal() {
      const m = document.getElementById('swotModal');
      m.classList.remove('hidden');
      m.classList.add('flex');
      autofillActionCodes(false);
    }

    function closeSwotModal(ev) {
      if (ev && ev.target && ev.target.id !== 'swotModal') return;
      const m = document.getElementById('swotModal');
      m.classList.add('hidden');
      m.classList.remove('flex');
    }

    function toggleNewDocButton(tab) {
      const btn = document.getElementById('btn-new-doc');
      if (!btn) return;
      if (tab === 'docs') btn.classList.remove('hidden');
      else btn.classList.add('hidden');
    }

    function switchTab(tab) {
      document.getElementById('view-docs').classList.add('hidden');
      document.getElementById('view-swot').classList.add('hidden');
      document.getElementById('view-ro').classList.add('hidden');
      document.getElementById('view-org').classList.add('hidden');
      document.getElementById('tab-docs').classList.remove('active');
      document.getElementById('tab-swot').classList.remove('active');
      document.getElementById('tab-ro').classList.remove('active');
      document.getElementById('tab-org').classList.remove('active');

      toggleNewDocButton(tab);

      if(tab === 'docs') {
        document.getElementById('view-docs').classList.remove('hidden');
        document.getElementById('tab-docs').classList.add('active');
      } else if(tab === 'swot') {
        document.getElementById('view-swot').classList.remove('hidden');
        document.getElementById('tab-swot').classList.add('active');
        if(swotData.length === 0) fetchSwot();
      } else if(tab === 'ro') {
        document.getElementById('view-ro').classList.remove('hidden');
        document.getElementById('tab-ro').classList.add('active');
        if(roData.length === 0) fetchRo();
      } else if(tab === 'org') {
        document.getElementById('view-org').classList.remove('hidden');
        document.getElementById('tab-org').classList.add('active');
      }
    }

    // =========
    // Fetch JSONP
    // =========
    function fetchFromSheet() {
      const callbackName = `cb_${Date.now()}`;
      window[callbackName] = (data) => {
        allDocuments = data;
        renderDocs(data);
        delete window[callbackName];
      };
      const script = document.createElement('script');
      script.src = `${MAIN_APPS_SCRIPT_URL}?callback=${callbackName}&t=${Date.now()}`;
      script.onload = () => script.remove();
      script.onerror = () => {
        console.error('Erro a carregar documentos (script).');
        script.remove();
        delete window[callbackName];
      };
      document.body.appendChild(script);
    }

    function fetchSwot() {
      document.getElementById('swot-forcas').innerHTML = '<p class="text-[10px] animate-pulse">A carregar...</p>';
      document.getElementById('swot-oportunidades').innerHTML = '<p class="text-[10px] animate-pulse">A carregar...</p>';
      document.getElementById('swot-fraquezas').innerHTML = '<p class="text-[10px] animate-pulse">A carregar...</p>';
      document.getElementById('swot-ameacas').innerHTML = '<p class="text-[10px] animate-pulse">A carregar...</p>';

      const callbackName = `cb_swot_${Date.now()}`;
      window[callbackName] = (data) => {
        if (data && data.ok === false) {
          const msg = `<p class="text-[10px] text-red-600 font-bold">Erro SWOT: ${escapeHtml(data.error || 'desconhecido')}</p>`;
          document.getElementById('swot-forcas').innerHTML = msg;
          document.getElementById('swot-oportunidades').innerHTML = msg;
          document.getElementById('swot-fraquezas').innerHTML = msg;
          document.getElementById('swot-ameacas').innerHTML = msg;
          delete window[callbackName];
          return;
        }

        swotData = Array.isArray(data) ? data : (data?.data || []);
        applySwotFilters();
        delete window[callbackName];
      };

      const script = document.createElement('script');
      script.src = `${SWOT_APPS_SCRIPT_URL}?sheet=SWOT&callback=${callbackName}&t=${Date.now()}`;
      script.onload = () => script.remove();
      script.onerror = () => {
        const msg = `<p class="text-[10px] text-red-600 font-bold">Erro a carregar o script SWOT.</p>`;
        document.getElementById('swot-forcas').innerHTML = msg;
        document.getElementById('swot-oportunidades').innerHTML = msg;
        document.getElementById('swot-fraquezas').innerHTML = msg;
        document.getElementById('swot-ameacas').innerHTML = msg;
        script.remove();
        delete window[callbackName];
      };
      document.body.appendChild(script);
    }

    function fetchRo() {
      document.getElementById('roTableBody').innerHTML = '<tr><td colspan="9" class="px-8 py-10 text-center text-slate-400 font-bold uppercase text-[10px] animate-pulse">A carregar dados R&O...</td></tr>';

      const callbackName = `cb_ro_${Date.now()}`;
      window[callbackName] = (data) => {
        if (data && data.ok === false) {
          const msg = `<tr><td colspan="9" class="px-8 py-10 text-center text-red-600 font-bold text-[10px]">Erro R&O: ${escapeHtml(data.error || 'desconhecido')}</td></tr>`;
          document.getElementById('roTableBody').innerHTML = msg;
          delete window[callbackName];
          return;
        }

        roData = Array.isArray(data) ? data : (data?.data || []);
        applyRoFilters();
        delete window[callbackName];
      };

      const script = document.createElement('script');
      script.src = `${RO_APPS_SCRIPT_URL}?sheet=R%26O&callback=${callbackName}&t=${Date.now()}`;
      script.onload = () => script.remove();
      script.onerror = () => {
        const msg = `<tr><td colspan="9" class="px-8 py-10 text-center text-red-600 font-bold text-[10px]">Erro a carregar o script R&O.</td></tr>`;
        document.getElementById('roTableBody').innerHTML = msg;
        script.remove();
        delete window[callbackName];
      };
      document.body.appendChild(script);
    }

    // =========
    // Docs
    // =========
    function renderDocs(data) {
      const body = document.getElementById('docsTableBody');
      if (!data || data.length === 0) {
        body.innerHTML = '<tr><td colspan="3" class="px-8 py-10 text-center text-slate-400 font-bold uppercase text-[10px]">Sem resultados para a pesquisa</td></tr>';
        return;
      }

      body.innerHTML = data.map(doc => `
        <tr class="hover:bg-slate-50/50 transition-colors group">
          <td class="px-8 py-5">
            <span class="type-badge ${getBadgeClass(doc.type)}">${escapeHtml(doc.type)}</span>
          </td>
          <td class="px-8 py-5">
            <p class="text-sm font-bold text-slate-700">${escapeHtml(doc.name)}</p>
          </td>
          <td class="px-8 py-5 text-right">
            <a href="${doc.link}" target="_blank" class="inline-block bg-slate-100 hover:bg-emerald-600 hover:text-white text-slate-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all">Consultar</a>
          </td>
        </tr>
      `).join('');
      document.getElementById('stat-docs').innerText = data.length;
    }

    function filterDocs() {
      const input = document.getElementById('searchDocs').value.toLowerCase().trim();
      if (!input) { renderDocs(allDocuments); return; }

      const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
      const queryNormalized = normalize(input);
      const inputTerms = queryNormalized.split(/\s+/).filter(t => t.length > 0);

      const synonymGroups = [
        ["emergencia", "seguranca", "autoprotecao", "incendio", "evacuacao", "socorro", "protecao"],
        ["residuo", "lixo", "reciclagem", "ecoponto", "oleo", "quimico", "perigoso", "contaminacao"],
        ["energia", "eletrica", "consumo", "gas", "agua", "recurso", "eficiencia"],
        ["lei", "legislacao", "conformidade", "requisito", "legal", "norma", "iso", "regulamento"],
        ["formacao", "treino", "sensibilizacao", "competencia", "capacitacao"],
        ["auditoria", "verificacao", "inspecao", "controlo", "monitorizacao"]
      ];

      let expandedTerms = [...inputTerms];
      inputTerms.forEach(term => {
        synonymGroups.forEach(group => {
          if (group.some(word => word.includes(term) || term.includes(word))) expandedTerms = [...expandedTerms, ...group];
        });
      });

      const uniqueSearchTerms = [...new Set(expandedTerms)];
      const filtered = allDocuments.filter(doc => {
        const content = normalize(`${doc.name} ${doc.type}`);
        return uniqueSearchTerms.some(term => content.includes(term));
      });

      renderDocs(filtered);
    }

    function getBadgeClass(type) {
      const t = String(type).toLowerCase();
      if (t.includes('procedimento')) return 'badge-procedimento';
      if (t.includes('instrucao')) return 'badge-instrucao';
      if (t.includes('registo')) return 'badge-registo';
      if (t.includes('manual')) return 'badge-manual';
      if (t.includes('politica')) return 'badge-politica';
      if (t.includes('modelo')) return 'badge-modelo';
      if (t.includes('pasta')) return 'badge-pasta';
      return 'badge-default';
    }

    // =========
    // Filtros SWOT
    // =========
    function setActiveFilter(val) {
      currentSwotActiveFilter = val;
      document.querySelectorAll('[id^="filter-active-"]').forEach(btn => btn.classList.remove('active'));
      const el = document.getElementById(`filter-active-${val}`);
      if (el) el.classList.add('active');
      applySwotFilters();
    }

    function setPlanFilter(val) {
      currentSwotPlanFilter = val;
      document.querySelectorAll('[id^="filter-plan-"]').forEach(btn => btn.classList.remove('active'));
      const el = document.getElementById(`filter-plan-${val}`);
      if (el) el.classList.add('active');
      applySwotFilters();
    }

    function setSwotFilter(cat) {
      currentSwotFilterCategory = cat;
      document.querySelectorAll('[id^="filter-swot-"]').forEach(btn => btn.classList.remove('active'));
      const el = document.getElementById(`filter-swot-${cat}`);
      if (el) el.classList.add('active');
      applySwotFilters();
    }

    function setQuadrantFilter(quad) {
      currentSwotFilterQuadrant = quad;
      document.querySelectorAll('[id^="filter-quad-"]').forEach(btn => btn.classList.remove('active'));
      const el = document.getElementById(`filter-quad-${quad}`);
      if (el) el.classList.add('active');

      const quadrants = ['FORÇAS', 'OPORTUNIDADES', 'FRAQUEZAS', 'AMEAÇAS'];
      quadrants.forEach(q => {
        const col = document.getElementById(`quadrant-${q}`);
        if(currentSwotFilterQuadrant === 'TODOS' || currentSwotFilterQuadrant === q) col.style.display = 'block';
        else col.style.display = 'none';
      });

      applySwotFilters();
    }

    function resolveQuadrant(swotRaw) {
      const s = String(swotRaw || '')
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toUpperCase().trim();

      if (s.includes('STRENGTHS') || s.includes('FORCAS') || s.includes('FORÇAS')) return 'FORÇAS';
      if (s.includes('OPPORTUNITIES') || s.includes('OPORTUNIDADES')) return 'OPORTUNIDADES';
      if (s.includes('WEAKNESSES') || s.includes('FRAQUEZAS')) return 'FRAQUEZAS';
      if (s.includes('THREATS') || s.includes('AMEACAS') || s.includes('AMEAÇAS')) return 'AMEAÇAS';
      return '';
    }

    function applySwotFilters() {
      const searchTerm = normLoose(document.getElementById('searchSwot')?.value || '');

      const filtered = (swotData || []).filter(item => {
        const swotRaw = getAny(item, ['SWOT','Swot']);
        const codigo  = getAny(item, ['código','Código','ID','id','codigo']);
        const descricao = getAny(item, ['Descrição','Descricao','DESC','desc']);
        const tomada = getTomadaAcao(item);

        const quadrant = resolveQuadrant(swotRaw);

        const blob = buildSwotBlob(item);
        const blobNorm = normLoose(blob);

        const catInfo = getSwotCategory(blob);

        const matchesTheme =
          currentSwotFilterCategory === 'TODOS' ||
          normLoose(catInfo.key) === normLoose(currentSwotFilterCategory);

        const matchesQuadrant =
          currentSwotFilterQuadrant === 'TODOS' ||
          quadrant === currentSwotFilterQuadrant;

        const ativo = isAtivoFromTomada(tomada);
        const matchesActive =
          currentSwotActiveFilter === 'TODOS' ||
          (currentSwotActiveFilter === 'ATIVOS' && ativo) ||
          (currentSwotActiveFilter === 'NAO_ATIVOS' && !ativo);

        // ✅ Plano de Ação? (nível da ação): verifica se há ações que correspondem ao filtro
        const planoMap = buildPlanoMap(item);
        let hasActionMatchingFilter = false;

        for (let i = 1; i <= 6; i++) {
          const acaoTxt = getAny(item, [`AÇÃO ${i}`, `ACAO ${i}`, `Ação ${i}`, `Acao ${i}`]);
          const acaoCod = getAny(item, [
            `CÓDIGO_AÇÃO ${i}`, `CODIGO_ACAO ${i}`, `CÓDIGO AÇÃO ${i}`, `CODIGO ACAO ${i}`,
            `CODIGO_AÇÃO ${i}`, `CÓDIGO_ACAO ${i}`
          ]);

          const temAcao = (acaoTxt && String(acaoTxt).trim()) || (acaoCod && String(acaoCod).trim());
          if (!temAcao) continue;

          const plano = planoMap[i] ?? '';
          const isPlanoS = isYes(plano);

          // Verificar se esta ação corresponde ao filtro
          if (currentSwotPlanFilter === 'TODOS' ||
              (currentSwotPlanFilter === 'S' && isPlanoS) ||
              (currentSwotPlanFilter === 'N' && !isPlanoS)) {
            hasActionMatchingFilter = true;
            break;
          }
        }

        const matchesPlan = currentSwotPlanFilter === 'TODOS' || hasActionMatchingFilter;

        const matchesSearch =
          !searchTerm || blobNorm.includes(searchTerm) || normLoose(`${swotRaw} ${codigo} ${descricao}`).includes(searchTerm);

        return matchesTheme && matchesQuadrant && matchesActive && matchesPlan && matchesSearch;
      });

      renderSwot(filtered);
    }

    function renderSwot(data) {
      const categories = {
        forcas: document.getElementById('swot-forcas'),
        oportunidades: document.getElementById('swot-oportunidades'),
        fraquezas: document.getElementById('swot-fraquezas'),
        ameacas: document.getElementById('swot-ameacas')
      };

      Object.values(categories).forEach(el => el.innerHTML = '');

      if (!data || !Array.isArray(data) || data.length === 0) {
        Object.values(categories).forEach(el => el.innerHTML = '<p class="text-[10px] text-slate-400 font-medium italic py-4">Nenhum registo identificado.</p>');
        return;
      }

      data.forEach(item => {
        const swotRaw = getAny(item, ['SWOT','Swot']);
        const quadrant = resolveQuadrant(swotRaw);

        let target = null;
        let borderClass = 'border-slate-200';
        if (quadrant === 'FORÇAS') { target = categories.forcas; borderClass = 'swot-f'; }
        else if (quadrant === 'OPORTUNIDADES') { target = categories.oportunidades; borderClass = 'swot-o'; }
        else if (quadrant === 'FRAQUEZAS') { target = categories.fraquezas; borderClass = 'swot-f-ext'; }
        else if (quadrant === 'AMEAÇAS') { target = categories.ameacas; borderClass = 'swot-a'; }
        if(!target) return;

        const description = getAny(item, ['Descrição','Descricao','DESC','desc']);
        const codigo = getAny(item, ['código','Código','ID','id','codigo']);

        const tomada = getTomadaAcao(item);
        const ativo = isAtivoFromTomada(tomada);

        const planoMap = buildPlanoMap(item);

        let actionsHtml = '';
        for (let i = 1; i <= 6; i++) {
          let cod = getAny(item, [
            `CÓDIGO_AÇÃO ${i}`, `CODIGO_ACAO ${i}`, `CÓDIGO AÇÃO ${i}`, `CODIGO ACAO ${i}`,
            `CODIGO_AÇÃO ${i}`, `CÓDIGO_ACAO ${i}`
          ]);
          const acao = getAny(item, [`AÇÃO ${i}`, `ACAO ${i}`, `Ação ${i}`, `Acao ${i}`]);

          const emPlano = planoMap[i] ?? '';
          const badgePlano = planoBadgeHtml(emPlano);

          if ((!cod || !String(cod).trim()) && (acao && String(acao).trim()) && codigo) {
            cod = deriveActionCode(codigo, i);
          }

          const hasSomething = (acao && String(acao).trim()) || (cod && String(cod).trim());
          if (!hasSomething) continue;

          // ✅ Aplicar o filtro "Plano de Ação?" ao nível de cada ação
          const isPlanoS = isYes(emPlano);
          const shouldShowAction = currentSwotPlanFilter === 'TODOS' ||
                                   (currentSwotPlanFilter === 'S' && isPlanoS) ||
                                   (currentSwotPlanFilter === 'N' && !isPlanoS);

          if (!shouldShowAction) continue;

          actionsHtml += `
            <div class="mt-2 p-2 bg-slate-50 rounded-lg border border-slate-100">
              <div class="flex items-center justify-between gap-2">
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">Ação ${i} (${escapeHtml(cod || '')})</p>
                ${badgePlano}
              </div>
              ${acao && String(acao).trim() !== ''
                ? `<p class="text-xs text-slate-600 font-medium leading-relaxed mt-1">${escapeHtml(acao)}</p>`
                : `<p class="text-[10px] text-slate-400 italic mt-1">Sem descrição da ação.</p>`
              }
            </div>
          `;
        }

        const catInfo = getSwotCategory(buildSwotBlob(item));
        const tagClass = getSwotTagClass(catInfo.key);

        const card = `
          <div class="glass-card p-5 ${borderClass}">
            <div class="flex justify-between items-center mb-3">
              <div class="swot-cat-badge ${tagClass}">
                ${catInfo.icon}
                <span>${escapeHtml(catInfo.key)}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 rounded-full text-[8px] font-black ${ativo ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'} uppercase">
                  ${ativo ? 'Ativo' : 'Não ativo'}
                </span>
                <span class="text-[9px] font-bold text-slate-300 tracking-widest">#${escapeHtml(codigo)}</span>
              </div>
            </div>
            <h4 class="text-[13px] font-bold text-slate-800 leading-snug mb-3">${escapeHtml(description)}</h4>
            ${actionsHtml ? `
              <div class="border-t border-slate-50 pt-3 mt-3">
                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-2">Plano Estratégico</p>
                ${actionsHtml}
              </div>
            ` : ''}
          </div>
        `;
        target.innerHTML += card;
      });

      Object.values(categories).forEach(el => {
        if(el.innerHTML === '') {
          el.innerHTML = '<p class="text-[10px] text-slate-400 font-medium italic py-4">Nenhum registo identificado com estes filtros.</p>';
        }
      });
    }

    // =========
    // Write SWOT
    // =========
    function buildSwotActionsPayload() {
      const mainCode = cleanMainCode(document.getElementById('swotCodigo')?.value || '');
      const acoes = [];

      for (let i = 1; i <= 6; i++) {
        let codigo = (document.getElementById(`acaoCod${i}`)?.value || '').trim();
        const acao = (document.getElementById(`acaoTxt${i}`)?.value || '').trim();

        if (acao && !codigo && mainCode) codigo = deriveActionCode(mainCode, i);

        if (codigo || acao) acoes.push({ codigo, acao });
      }
      return acoes;
    }

    async function addSwotToSheet(e) {
      e.preventDefault();

      const swotType = document.getElementById('swotType').value;
      const codigo = cleanMainCode(document.getElementById('swotCodigo').value);

      if (!validateMainCodeAgainstType(swotType, codigo)) {
        const expected = expectedPrefixFromSwotType(swotType);
        alert(`Código inválido para o tipo selecionado.\n\nPara "${swotType}", o código deve começar por "${expected}" (ex: ${expected}1).`);
        return;
      }

      autofillActionCodes(false);

      const btn = document.getElementById('btnAddSwot');
      btn.disabled = true;
      const oldText = btn.innerText;
      btn.innerText = 'A GRAVAR...';

      const payload = {
        swot: swotType,
        codigo: codigo,
        descricao: document.getElementById('swotDescricao').value.trim(),
        tomadaAcao: document.getElementById('swotTomada').value,
        acoes: buildSwotActionsPayload()
      };

      try {
        const res = await fetch(SWOT_WRITE_APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        });

        const out = await res.json();
        if (!out || out.ok !== true) {
          alert(`Erro ao gravar SWOT: ${(out && out.error) ? out.error : 'desconhecido'}`);
          return;
        }

        document.getElementById('addSwotForm').reset();
        closeSwotModal();
        fetchSwot();
      } catch (err) {
        alert('Erro na comunicação com a base de dados SWOT.');
      } finally {
        btn.disabled = false;
        btn.innerText = oldText;
      }
    }

    function escapeHtml(str) {
      if(!str) return "";
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));
    }

    // =========
    // R&O - Riscos e Oportunidades
    // =========
    
    // Mapa de sinónimos e termos associados para busca semântica
    const RO_SEARCH_SYNONYMS = {
      // Ambiental
      'ambi': ['ambi', 'ambiente', 'ambiental', 'ambientes', 'esg', 'verde', 'sustentabilidade', 'sustentavel', 'ecologia', 'ecologico'],
      'ambiente': ['ambi', 'ambiente', 'ambiental', 'ambientes', 'esg', 'verde', 'sustentabilidade', 'sustentavel', 'ecologia', 'ecologico'],
      'esg': ['esg', 'ambiental', 'ambiente', 'sustentabilidade', 'verde', 'responsabilidade', 'governa'],
      
      // Energia
      'energia': ['energia', 'eletric', 'consumo', 'recurso', 'eficiencia', 'gas', 'combustivel'],
      'eletric': ['energia', 'eletric', 'consumo', 'recurso'],
      'consumo': ['consumo', 'energia', 'recurso', 'eficiencia'],
      
      // Água
      'agua': ['agua', 'hidric', 'recurso', 'consumo', 'desperdicio', 'contaminacao'],
      'hidric': ['agua', 'hidric', 'recurso', 'contaminacao'],
      
      // Resíduos
      'residuo': ['residuo', 'lixo', 'reciclagem', 'ecoponto', 'oleo', 'lixivado', 'aterro'],
      'lixo': ['residuo', 'lixo', 'reciclagem', 'ecoponto', 'desperdicio'],
      'reciclagem': ['reciclagem', 'residuo', 'reutilizacao', 'valorizacao'],
      'quimico': ['quimico', 'substancia', 'perigoso', 'toxico', 'contaminacao'],
      
      // Emissões
      'emissao': ['emissao', 'carbono', 'co2', 'gases', 'poluicao', 'atmosfera'],
      'carbono': ['carbono', 'co2', 'emissao', 'clima', 'aquecimento'],
      'poluicao': ['poluicao', 'emissao', 'contaminacao', 'atmosfera'],
      
      // Legal/Conformidade
      'lei': ['lei', 'legislacao', 'conformidade', 'requisito', 'legal', 'norma', 'iso', 'regulamento', 'decreto'],
      'legal': ['legal', 'lei', 'legislacao', 'conformidade', 'regulamento'],
      'conformidade': ['conformidade', 'lei', 'legal', 'requisito', 'norma'],
      'iso': ['iso', 'norma', 'certificacao', 'requisito', 'conformidade'],
      'regulamento': ['regulamento', 'lei', 'legal', 'decreto', 'legislacao'],
      
      // Saúde e Segurança
      'seguranca': ['seguranca', 'saude', 'protecao', 'incendio', 'evacuacao', 'socorro'],
      'saude': ['saude', 'seguranca', 'protecao', 'bem-estar'],
      'incendio': ['incendio', 'seguranca', 'protecao', 'evacuacao', 'emergencia'],
      'emergencia': ['emergencia', 'incendio', 'seguranca', 'evacuacao'],
      
      // Transporte
      'transporte': ['transporte', 'emissao', 'combustivel', 'veiculo', 'logistica', 'carbono'],
      'veiculo': ['veiculo', 'transporte', 'combustivel', 'emissao'],
      
      // Equipa/Pessoal
      'equipa': ['equipa', 'pessoal', 'colaborador', 'trabalhador', 'formacao', 'treino', 'competencia'],
      'formacao': ['formacao', 'treino', 'sensibilizacao', 'competencia', 'capacitacao', 'equipa'],
      'treino': ['treino', 'formacao', 'sensibilizacao', 'capacitacao'],
      
      // Auditoria/Controlo
      'auditoria': ['auditoria', 'verificacao', 'inspecao', 'controlo', 'monitorizacao', 'avaliacao'],
      'inspecao': ['inspecao', 'auditoria', 'verificacao', 'controlo'],
      'controlo': ['controlo', 'auditoria', 'monitorizacao', 'verificacao'],
      'monitorizacao': ['monitorizacao', 'controlo', 'auditoria', 'seguimiento'],
      
      // Gerais
      'risco': ['risco', 'ameaca', 'perigo', 'problema', 'critico'],
      'oportunidade': ['oportunidade', 'melhoria', 'beneficio', 'vantagem', 'potencial'],
      'melhoria': ['melhoria', 'oportunidade', 'aprimoramento', 'otimizacao'],
      'impacto': ['impacto', 'efeito', 'consequencia', 'resultado', 'influencia'],
      'contaminacao': ['contaminacao', 'poluicao', 'quimico', 'toxico', 'desperdicio'],
    };

    // Expande termo de pesquisa com sinónimos
    function expandSearchTerm(term) {
      const normalized = normLoose(term);
      
      // Busca no mapa de sinónimos
      for (const [key, synonyms] of Object.entries(RO_SEARCH_SYNONYMS)) {
        if (normalized.includes(key) || key.includes(normalized) || normalized === key) {
          return synonyms;
        }
      }
      
      // Se não encontrar em sinónimos, retorna o termo normalizado
      return [normalized];
    }

    function applyRoFilters() {
      const searchInput = document.getElementById('searchRo').value.toLowerCase().trim();
      const normalized = (str) => normLoose(str);

      const filtered = roData.filter(item => {
        if (!searchInput) return true;
        
        const descricao = getAny(item, ['Descrição do Risco / Oportunidade', 'Descricao do Risco / Oportunidade', 'Descrição']);
        const origem = getAny(item, ['Origem']);
        const processos = getAny(item, ['Processos']);
        const codigo = getAny(item, ['Código (R&O)', 'Codigo (R&O)', 'Código', 'Codigo']);
        const keyword = getAny(item, ['KeyWord', 'Keyword']);
        
        const content = normalized(`${descricao} ${origem} ${processos} ${codigo} ${keyword}`);
        
        // Expande o termo com sinónimos
        const expandedTerms = expandSearchTerm(searchInput);
        
        // Verifica se algum dos termos expandidos está no conteúdo
        return expandedTerms.some(term => content.includes(term));
      });

      renderRo(filtered);
    }

    function renderRo(data) {
      const tbody = document.getElementById('roTableBody');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-8 py-10 text-center text-slate-400 font-bold uppercase text-[10px]">Nenhum registo identificado</td></tr>';
        return;
      }

      tbody.innerHTML = data.map((item, idx) => {
        const descricao = getAny(item, ['Descrição do Risco / Oportunidade', 'Descricao do Risco / Oportunidade', 'Descrição', 'Descricao']);
        const ro = getAny(item, ['R / O', 'R/O', 'Tipo']);
        const origem = getAny(item, ['Origem']);
        const processos = getAny(item, ['Processos']);
        const codigo = getAny(item, ['Código (R&O)', 'Codigo (R&O)', 'Código', 'Codigo']);
        const pa = getAny(item, ['PA', 'Plano de Ação']);
        const proveniencia = getAny(item, ['Proveniência (Origem do Risco)', 'Proveniencia (Origem do Risco)', 'Proveniência', 'Proveniencia']);
        const observacoes = getAny(item, ['Observações', 'Observacoes', 'Observação', 'Observacao']);
        const keyword = getAny(item, ['KeyWord', 'Keyword']);

        // Determina se é Risco (R) ou Oportunidade (O)
        const roNormalized = normLoose(ro);
        const isRisco = roNormalized.startsWith('r') || roNormalized.includes('risco');
        const roBadgeClass = isRisco ? 'ro-risco' : 'ro-oportunidade';
        
        const rowBgClass = isRisco ? 'bg-red-50/30 hover:bg-red-50/50' : 'bg-emerald-50/30 hover:bg-emerald-50/50';
        const rowBorderClass = isRisco ? 'border-l-4 border-red-500' : 'border-l-4 border-emerald-500';
        
        return `
          <tr class="transition-colors group ${rowBgClass} ${rowBorderClass}">
            <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(descricao)}</td>
            <td class="px-6 py-4 text-center">
              <span class="inline-block px-3 py-1.5 rounded-full text-[9px] font-black ${roBadgeClass} uppercase">${escapeHtml(ro)}</span>
            </td>
            <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(origem)}</td>
            <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(processos)}</td>
            <td class="px-6 py-4 text-center text-sm font-bold text-slate-700">${escapeHtml(codigo)}</td>
            <td class="px-6 py-4 text-center text-sm font-black ${pa && normLoose(pa) === 'sim' || normLoose(pa) === 's' ? 'text-emerald-600' : 'text-slate-400'}">${escapeHtml(pa)}</td>
            <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(proveniencia)}</td>
            <td class="px-6 py-4 text-sm text-slate-700">
              ${observacoes && String(observacoes).trim() 
                ? `<button class="btn-ro-swot-modal text-emerald-600 hover:text-emerald-700 hover:underline font-bold transition-colors" data-codigo="${escapeHtml(observacoes)}">${escapeHtml(observacoes)}</button>`
                : '<span class="text-slate-400 italic">-</span>'
              }
            </td>
            <td class="px-6 py-4 text-sm text-slate-700">${escapeHtml(keyword)}</td>
          </tr>
        `;
      }).join('');
    }

    function openRoSwotModalWithCode(codigo) {
      openRoSwotModal(codigo);
    }

    function openRoSwotModal(codigos) {
      // Extrai múltiplos códigos (separados por ; , ou espaço)
      const codigosArray = String(codigos || '')
        .split(/[;,]/)
        .map(c => c.trim())
        .filter(c => c.length > 0);

      const content = document.getElementById('roSwotModalContent');
      
      if (codigosArray.length === 0) {
        content.innerHTML = `<p class="text-slate-600 text-sm">Nenhum código fornecido.</p>`;
        const modal = document.getElementById('roSwotModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        return;
      }

      // Procura todos os códigos em swotData
      const matchedSwots = codigosArray.map(codigo => {
        const codigoNorm = normLoose(codigo);
        return {
          codigo: codigo,
          data: swotData.find(item => {
            const itemCodigo = getAny(item, ['código','Código','ID','id','codigo']);
            return normLoose(itemCodigo) === codigoNorm;
          })
        };
      });

      // Cria o HTML para todos os códigos encontrados
      let htmlContent = '';
      let foundCount = 0;
      let notFoundCodigos = [];

      matchedSwots.forEach(match => {
        if (!match.data) {
          notFoundCodigos.push(match.codigo);
          return;
        }

        foundCount++;
        const matchedSwot = match.data;
        const swotRaw = getAny(matchedSwot, ['SWOT','Swot']);
        const descricao = getAny(matchedSwot, ['Descrição','Descricao','DESC','desc']);
        const itemCodigo = getAny(matchedSwot, ['código','Código','ID','id','codigo']);
        const tomada = getTomadaAcao(matchedSwot);

        const planoMap = buildPlanoMap(matchedSwot);

        let acoesList = '';
        for (let i = 1; i <= 6; i++) {
          const cod = getAny(matchedSwot, [
            `CÓDIGO_AÇÃO ${i}`, `CODIGO_ACAO ${i}`, `CÓDIGO AÇÃO ${i}`, `CODIGO ACAO ${i}`,
            `CODIGO_AÇÃO ${i}`, `CÓDIGO_ACAO ${i}`
          ]);
          const acao = getAny(matchedSwot, [`AÇÃO ${i}`, `ACAO ${i}`, `Ação ${i}`, `Acao ${i}`]);
          const emPlano = planoMap[i] ?? '';
          
          if (!cod && !acao) continue;
          
          const badgePlano = planoBadgeHtml(emPlano);
          acoesList += `
            <div class="mb-4 p-3 bg-white rounded border border-slate-200">
              <div class="flex items-center justify-between gap-2 mb-2">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Ação ${i} (${escapeHtml(cod || '')})</p>
                ${badgePlano}
              </div>
              ${acao && String(acao).trim() ? `<p class="text-sm text-slate-700">${escapeHtml(acao)}</p>` : `<p class="text-[10px] text-slate-400 italic">Sem descrição</p>`}
            </div>
          `;
        }

        htmlContent += `
          <div class="border-l-4 border-emerald-500 pl-4 mb-6 pb-6 ${foundCount > 1 ? 'border-b border-slate-200' : ''}">
            <p class="text-[10px] font-black uppercase text-slate-400 mb-1">SWOT - ${escapeHtml(swotRaw)}</p>
            <p class="text-sm font-bold text-slate-700">Código: ${escapeHtml(itemCodigo)}</p>
            
            <div class="mt-4 mb-4">
              <p class="text-[10px] font-black uppercase text-slate-400 mb-2">Descrição</p>
              <p class="text-sm text-slate-700">${escapeHtml(descricao)}</p>
            </div>

            <div class="mb-4">
              <p class="text-[10px] font-black uppercase text-slate-400 mb-2">Tomada de Ação</p>
              <p class="text-sm text-slate-700">${escapeHtml(tomada)}</p>
            </div>

            ${acoesList ? `
            <div>
              <p class="text-[10px] font-black uppercase text-slate-400 mb-2">Ações Estratégicas</p>
              <div class="space-y-1">${acoesList}</div>
            </div>
            ` : ''}
          </div>
        `;
      });

      // Adiciona aviso para códigos não encontrados
      if (notFoundCodigos.length > 0) {
        htmlContent += `
          <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-[10px] font-black text-red-700 uppercase">Códigos não encontrados:</p>
            <p class="text-sm text-red-600">${escapeHtml(notFoundCodigos.join(', '))}</p>
          </div>
        `;
      }

      if (htmlContent === '') {
        htmlContent = `<p class="text-slate-600 text-sm">Nenhum registo SWOT encontrado para os códigos fornecidos.</p>`;
      }

      content.innerHTML = htmlContent;

      const modal = document.getElementById('roSwotModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeRoSwotModal(event) {
      if (event && event.target && event.target.id !== 'roSwotModal') return;
      const modal = document.getElementById('roSwotModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // =========
    // Organigrama
    // =========
    function toggleOrgView(view) {
      const fullView = document.getElementById('org-full-view');
      const detailsView = document.getElementById('org-details-view');
      const fullBtn = document.getElementById('org-full-btn');
      const detailsBtn = document.getElementById('org-details-btn');

      if (view === 'full') {
        fullView.classList.remove('hidden');
        detailsView.classList.add('hidden');
        fullBtn.classList.add('active');
        fullBtn.classList.remove('bg-slate-700', 'hover:bg-slate-600');
        fullBtn.classList.add('bg-white', 'text-slate-900');
        detailsBtn.classList.remove('active');
        detailsBtn.classList.remove('bg-white', 'text-slate-900');
        detailsBtn.classList.add('bg-slate-700', 'hover:bg-slate-600', 'text-white');
      } else {
        fullView.classList.add('hidden');
        detailsView.classList.remove('hidden');
        detailsBtn.classList.add('active');
        detailsBtn.classList.remove('bg-slate-700', 'hover:bg-slate-600');
        detailsBtn.classList.add('bg-white', 'text-slate-900');
        fullBtn.classList.remove('active');
        fullBtn.classList.remove('bg-white', 'text-slate-900');
        fullBtn.classList.add('bg-slate-700', 'hover:bg-slate-600', 'text-white');
      }
    }

    function openOrgStaffModal(deptName, staffString) {
      const staffList = staffString.split('|').map(s => s.trim()).filter(s => s);
      const modal = document.getElementById('org-staff-modal');
      const title = document.getElementById('org-modal-title');
      const staffDiv = document.getElementById('org-modal-staff');
      
      title.textContent = deptName;
      staffDiv.innerHTML = staffList.map(staff => `
        <div class="p-3 bg-slate-50 border-l-4 border-slate-300 rounded hover:bg-slate-100 transition-colors cursor-pointer">
          <p class="font-semibold text-slate-800">${staff}</p>
        </div>
      `).join('');
      
      modal.classList.remove('hidden');
    }

    function closeOrgStaffModal() {
      const modal = document.getElementById('org-staff-modal');
      modal.classList.add('hidden');
    }

    // ⚠️ NOTA: addDocumentToSheet não estava no snippet original (mantém a tua função anterior)

    window.onload = () => {
      toggleNewDocButton('docs');
      fetchFromSheet();
      fetchSwot();
      fetchRo();

      // Event listeners para botões de departamento no organigrama
      document.querySelectorAll('.org-dept-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const dept = btn.getAttribute('data-dept');
          const staff = btn.getAttribute('data-staff');
          openOrgStaffModal(dept, staff);
        });
      });

      // Fechar modal ao clicar fora dele
      document.getElementById('org-staff-modal').addEventListener('click', (e) => {
        if (e.target.id === 'org-staff-modal') {
          closeOrgStaffModal();
        }
      });

      // ✅ listeners para auto-gerar códigos das ações
      const swotCodigoEl = document.getElementById('swotCodigo');
      const swotTypeEl = document.getElementById('swotType');

      if (swotCodigoEl) {
        swotCodigoEl.addEventListener('input', () => autofillActionCodes(true));
        swotCodigoEl.addEventListener('blur', () => autofillActionCodes(true));
      }
      if (swotTypeEl) {
        swotTypeEl.addEventListener('change', () => {
          const pref = expectedPrefixFromSwotType(swotTypeEl.value);
          const current = cleanMainCode(swotCodigoEl?.value || '');
          if (!current && pref) swotCodigoEl.value = `${pref}1`;
          autofillActionCodes(true);
        });
      }

      for (let i = 1; i <= 6; i++) {
        const txtEl = document.getElementById(`acaoTxt${i}`);
        if (txtEl) txtEl.addEventListener('input', () => autofillActionCodes(false));
      }

      // ✅ Event listener para botões R&O que abrem modal SWOT
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-ro-swot-modal')) {
          const codigo = e.target.getAttribute('data-codigo');
          if (codigo) openRoSwotModal(codigo);
        }
      });
    };
  </script>
</body>
</html>
